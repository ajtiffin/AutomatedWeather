---
format: 
    typst:
        mainfont: "Arial"
        fontsize: 9.5pt
        fig-format: png
        include-before-body:
             text: |
                #show heading: set text(rgb(0,72,151))
editor_options: 
  chunk_output_type: console
---

```{r}
#| label: Throat Clearing
#| output: false
#| echo: false
rm(list=ls())
Sys.setenv(TZ="UTC")
library(ggthemes)
library(skimr)
library(lubridate)
library(scales)
library(countrycode)
library(readxl)
library(knitr)
library(kableExtra)
library(patchwork)
library(reticulate)
use_python("C:/ProgramData/Python3", required = TRUE)
library(ggforce)
library(fpp3)
library(ggdist)
library(tidyverse)

setwd("c:\\Projects\\OctREO25")

# REO-approved theme ----------------------------------

{fundblue<-"#004C97"
ssablue<-"#0065d2"
ssamedblue<-"#66C4EB"
ssapeach1<-"#fab58a"
ssapeach2<-"#ff8745"
ssapeach3<-"#fa5a00"
ssapeach4<-"#cc4700"
ssapeach5<-"#802b00"
ssagrey1<-"#b3b3b3"
ssagrey2<-"#949494"
ssagrey3<-"#707070"
ssagrey4<-"#404040"
ssagrey5<-"#171717"}

slidetheme<- theme_bw() +
  theme(
    panel.grid = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.background = element_rect(fill = "transparent"), 
    plot.background = element_rect(fill = "transparent", color = NA),
    panel.border = element_blank(),
    axis.line = element_line(color="grey20"),
    axis.ticks = element_line(color="grey20"),
    axis.ticks.length=unit(-0.10, "cm"),
    axis.text.y = element_text(margin=margin(0,10,0,0,"pt")),
    axis.text = element_text(size=8),
    plot.title=element_text(size=11, face="bold"),
    plot.subtitle=element_text(size=9),
    plot.caption = element_text(size=8, color="grey30", hjust=0),
    legend.text = element_text(size=8, color="grey30"),
    plot.title.position = "plot",
    plot.caption.position = "plot")
theme_set(slidetheme)



theme_set(slidetheme)
getwd()
# AFR-specific groups-------------------------------


oilexport<-c("AGO", "CMR", "TCD", "COG", "GNQ", "GAB", "NGA", "SSD")
otherresource<-c("BWA", "BFA", "CAF", "COD", "GHA", "GIN", "LBR","MLI", "NAM", "NER", "SLE", "ZAF", "TZA", "ZMB", "ZWE")
nonresource<-c("BEN", "BDI", "CPV", "COM", "CIV", "ERI", "ETH", "GMB", "GNB", "KEN", "LSO", "MDG", "MWI", "MUS", "MOZ", "RWA", "STP", "SEN", "SYC", "SWZ", "TGO","UGA")
conflict<-c("BFA", "CMR", "CAF", "COG", "ETH","MLI","MOZ","NER", "NGA","SSD")
institandsocial<-c("BDI","TCD","COM","COD", "ERI","GNB","ZWE")
fragile<-c(conflict,institandsocial)
CEMAC<-c("GAB", "CMR", "CAF", "TCD", "COG", "GNQ")
WAEMU<-c("BEN", "BFA", "CIV", "GNB", "MLI", "NER", "SEN", "TGO")
tourlist<-c("CPV", "COM", "GMB", "MUS", "STP", "SYC")
frontier<-c("AGO", "BEN", "CMR", "CIV", "ETH",  "GAB",  "GHA", "KEN", "MUS", "MOZ", "NAM", "NGA", "RWA", "SEN" , "TZA", "ZMB")
MIClist<-c("AGO","BWA","CPV","CMR","COM","COG", "CIV", "GNQ", "SWZ", "GAB", "GHA",
    "KEN", "LSO", "MUS", "NAM", "NGA","STP", "SEN", "SYC", "ZAF", "ZMB")

NAFRlist<-c("DZA", "DJI", "EGY", "LBY", "MRT", "MAR", "SOM", "SDN", "TUN")

# IMF datatools helpert functions----------------------------------------------------

imf_datatools <- import("imf_datatools")
imf_datatools$idata_utilities$PRIVATE <- TRUE
py_config()
db.list<-imf_datatools$idata_utilities$get_databases()

idata.basic<-function(var.list, country.list, database, start, end, frq){
  key.var<-paste0(var.list, collapse="+")
  key.ctry<-paste0(country.list, collapse="+")
  key.freq<-frq
  key<-paste0(key.ctry,".",key.var,".",key.freq)
  data<-imf_datatools$idata_utilities$get_idata_data(database, key=key, start=start, end=end, panel="COUNTRY") %>% 
    janitor::clean_names() %>% 
    rename(date=dates, iso3c=country) %>%
    mutate(date=as.Date(date)) %>% 
    select(date, everything())%>%
    pivot_longer(-c(date, iso3c), names_to = "code", values_to = "value") %>% 
    mutate(variable=str_sub(code,start=1, end=-3)) %>% 
    select(-code)%>%
    pivot_wider(names_from = variable, values_from = value) %>% 
    arrange(iso3c,date)%>%
    ungroup() %>% 
    as.tibble()
  print(key)
  return(data)
}

bbiextract<-function(var.list, field, start, end, frq){
  key.var<-paste0(var.list, collapse="+")
  key.field<-paste(field, collapse="+")
  key.freq<-frq
  key<-paste0(key.var,".",key.field,".", key.freq)
  print(key)
  data<-imf_datatools$idata_utilities$get_idata_data("IMF.CSF:BBGDL", key=key, start=start, end=end)%>% 
    janitor::clean_names() %>% 
    mutate(date=as.Date(rownames(.)))%>% 
    select(date, everything())%>%
    pivot_longer(!date, names_to = "code", values_to = "value")%>%
    mutate(variable=sub("_.*", "", code) )%>% 
    select(-code)%>%
    pivot_wider(names_from=variable, values_from=value) %>% 
    ungroup() %>% 
    mutate_all( ~ case_when(!is.nan(.x) ~ .x)) %>% 
    as.tibble()
  return(data)
}

ecosextract<-function(code.list, country.list, database, start, end, frq){
  ecos<-imf_datatools$get_ecos_sdmx_data(database, country.list,code.list, freq = frq)%>%
    mutate(date=as.Date(row.names(.)))%>%
    mutate(year=year(date))%>%
    # select(-date)%>%
    filter(year>=start & year<=end)%>%
    select(date, everything())%>%
    gather(code, value, -c(year, date))%>%
    mutate(variable=str_sub(code,start=4, end=-3),
           imf=as.numeric(str_sub(code,1,3)))%>%
    mutate(iso3c=countrycode(imf,"imf", "iso3c"))%>%
    select(-code)%>%
    spread(variable, value) %>% 
    arrange(imf,date)%>%
    mutate(iso3c=countrycode(imf,"imf", "iso3c"))%>%
    ungroup() %>% 
    as_tibble()
  return(ecos)
}
bbextract<-function(code.list, start, end){
  ecos<-imf_datatools$get_ecos_bloomberg_data(code.list, field='PX_LAST')%>%
    mutate(date=as.Date(row.names(.)))%>%
    filter(date>=start & date<=end)%>%
    select(date, everything())%>%
    pivot_longer(!date, names_to = "code", values_to = "value")%>%
    mutate(variable=str_sub(code,start=1, end=8)) %>% 
    select(-code)%>%
    pivot_wider(names_from=variable, values_from=value) %>% 
    ungroup() %>% 
    mutate_all( ~ case_when(!is.nan(.x) ~ .x)) %>% 
    as_tibble()
  return(ecos)
}

commodityextract<-function(code.list, start, end, freq, type){
  ecos<-imf_datatools$ecos_sdmx_utilities$get_ecos_commodity_data(
    "WEO_PRIMARY_COMMODITY_PRICE_SYSTEM_LIVE",
    code.list, datatype = type, freq = freq) %>% 
    mutate(date=as.Date(row.names(.)))%>%
    filter(date>=start & date<=end)%>%
    select(date, everything())%>%
    pivot_longer(!date, names_to = "code", values_to = "value")%>%
    mutate(variable=str_sub(code,start=1, end=8)) %>% 
    select(-code)%>%
    pivot_wider(names_from=variable, values_from=value) %>% 
    ungroup() %>% 
    mutate_all( ~ case_when(!is.nan(.x) ~ .x)) %>% 
    as_tibble()
  return(ecos)
}

#*************************************************************
source("c:\\Projects\\Workbench\\chatgpt.R")

## the chat function is:
# "I want a clear and up to date summary of recent trends, speeches, and press releases associated with the 2025 Financing fior Development Conference" %>% gpt()


#*********************************************************************************
cutoff.date<-as.Date("2023-3-31")
cutoff.date<-as.Date(Sys.Date())
weo.codes<-imf_datatools$ecos_sdmx_utilities$get_weo_country_codes() %>% janitor::clean_names()
ssa.list<-weo.codes %>%
  filter(sub_sahara_africa==1) %>% pull(iso_3_code)
```

# Page 1

```{r}
#| label: GDP Dot Tetris Chart
#| output: false
#| echo: false


db = 'IMF.RES.GAS:GAS_LIVE'
# Find the right dimensions of the API key
imf_datatools$idata_utilities$get_dimensions(db)
#Find the right series
series<-imf_datatools$idata_utilities$get_dimension_values(db,"INDICATOR") %>% data.frame() %>% mutate(code=rownames(.))
series %>% filter(str_detect(str_to_lower(Name), "gdp")) %>% kbl("rst")
countries<-imf_datatools$idata_utilities$get_dimension_values(db,"COUNTRY") %>% data.frame() %>% mutate(code=rownames(.))
ssa.list<-weo.codes %>% filter(sub_sahara_africa==1) %>% pull(iso_3_code)

# extract data
raw<-idata.basic(c("NGDP_RPCH", "PPPGDP"), ssa.list, "IMF.RES.WEO:WEO_LIVE", "2023", "2026", "A") 

data<-raw |> 
  mutate(type=case_when(
    iso3c%in%oilexport~"Oil Exporter",
    iso3c%in%otherresource~"Other Resource",
    iso3c%in%nonresource~"Non Resource",
    TRUE~NA_character_
  )) |> 
  mutate(year=year(date)) |> 
  rename(value=ngdp_rpch) |> 
  filter(!iso3c%in%c("ERI", "SSD"))

ssa.av<-data %>% filter(year%in%2024:2025) %>% 
  group_by(year) %>% 
  summarize(value=weighted.mean(value, pppgdp, na.rm=T)) %>% 
  select(value) %>% 
  unlist() %>% as.vector()
# ssa.av<-ecosextract(code.list, "603", "WEO_WEO_LIVE", 2022,2025,"A")%>%
#   select(5)%>%unlist()%>%as.vector()


bw=.6
dot.data<-data %>% 
  group_by(iso3c) %>% 
  mutate(increase=value>=lag(value)) %>% 
  filter(year%in%c(2024:2025))
p.1<-ggplot(dot.data %>% filter(year==2024), aes(x = value, fill = increase)) +
  geom_dotplot(stackgroups = TRUE, binwidth = bw, method = "histodot", origin=0)
p.2<-ggplot(dot.data %>% filter(year==2025), aes(x = value, fill = increase)) +
  geom_dotplot(stackgroups = TRUE, binwidth = bw, method = "histodot", origin=0)
p.1/p.2

point.pos.1 <- layer_data(p.1)%>%
  arrange(x,stackpos)
point.pos.2 <- layer_data(p.2)%>%
  arrange(x,stackpos)

plotdata.1<-dot.data%>%
  filter(year==2024) %>% 
  mutate(bin=cut_width(value, width = bw, boundary=0)) %>% 
  group_by(bin) %>% 
  mutate(binx=mean(value))%>% 
  arrange(binx,increase)%>%
  cbind(point.pos.1) %>% 
  ungroup()
plotdata.2<-dot.data%>%
  filter(year==2025) %>% 
  mutate(bin=cut_width(value, width = bw, boundary=0)) %>% 
  group_by(bin) %>% 
  mutate(binx=mean(value))%>% 
  arrange(binx,increase)%>%
  cbind(point.pos.2) %>% 
  ungroup()


g.1<-ggplot(plotdata.1, aes(x = value, fill = increase, col=increase)) +
  geom_dotplot(stackgroups = T, binwidth = bw, method="histodot", origin=0, alpha=.6)+
  coord_fixed(ratio=4)+
  geom_text(aes(x, stackpos/6.5, label = iso3c), col=ssagrey5, size=6/.pt)+
  scale_x_continuous(breaks=c(-5,0,5,10,15))+
  # coord_cartesian(xlim=c(-5,15))+ ## check this
  scale_y_continuous(NULL, breaks = NULL)+
  theme(axis.line.y = element_blank())+
  scale_fill_manual(values=c(ssagrey2, fundblue), guide="none")+
  scale_color_manual(values=c(ssagrey2,fundblue), guide="none")+
  annotate("text", x=-5, y=1, label="")+
  annotate("text", x=11, y=0, label="")+
  labs(title = "2024")
# g.1
g.gdpdot<-ggplot(plotdata.2, aes(x = value, fill = increase, col=increase)) +
  geom_dotplot(stackgroups = T, binwidth = bw, method="histodot", origin=0, alpha=.6)+
  coord_fixed(ratio=4)+
  geom_text(aes(x, stackpos/6.6, label = iso3c), col=ssagrey5, size=6/.pt)+
  scale_x_continuous(breaks=c(-5,0,5,10,15))+
  # coord_cartesian(xlim=c(-5,15))+ ## check this
  scale_y_continuous(NULL, breaks = NULL)+
  theme(axis.line.y = element_blank())+
  scale_fill_manual(values=c(ssagrey2, fundblue), guide="none")+
  scale_color_manual(values=c(ssagrey2,fundblue), guide="none")+
  annotate("text", x=-5, y=1, label="")+
  annotate("text", x=11, y=0, label="")+
  labs(title = "SSA. Real GDP Growth, 2025",
       subtitle = "(percent. Blue = rising, grey = falling)",
       caption = paste0("Source: IMF WEO database and IMF staff calculations","\n",
                        "SSA average growth rates for 2024 and 2025 are ", sprintf("%.2f", ssa.av[1]), "% and ", sprintf("%.2f", ssa.av[2]),"%, respectively."))
g.gdpdot
ggsave(filename = "gdpdot.png",  height = 3, width=6, dpi=1000,units="in", device="png", bg = "transparent")

```


```{r}
#| label: ODA line chart using data from CRS
#| output: false
#| echo: false
library(httr)
library(jsonlite)
library(rsdmx)



url<-"https://sdmx.oecd.org/public/rest/dataflow/OECD.DCD.FSD/DSD_DAC2@DF_DAC2A/1.2?references=all"

raw.struct <- readSDMX(url)

cls <- slot(raw.struct, "codelists")
#get list of codelists
codelists <- sapply(slot(cls, "codelists"), function(x) slot(x, "id"))
codelists %>% kbl("rst")
#get a codelist
price.list <- as.data.frame(slot(raw.struct, "codelists"), codelistId = "CL_PRICES") %>% 
  select(id, contains(".en"))
price.list %>% tail(30) %>% kbl("rst")
country.list <- as.data.frame(slot(raw.struct, "codelists"), codelistId = "CL_AREA_ORG") %>% 
  select(id, contains(".en"))
country.list %>% tail(30) %>% kbl("rst")
measure.list <- as.data.frame(slot(raw.struct, "codelists"), codelistId = "CL_DAC2_MEASURE") %>% 
  select(id, contains(".en"))
measure.list %>% kbl("rst")
type.list <- as.data.frame(slot(raw.struct, "codelists"), codelistId = "CL_FLOW_TYPE") %>% 
  select(id, contains(".en"))
type.list %>% kbl("rst")
unit.list <- as.data.frame(slot(raw.struct, "codelists"), codelistId = "CL_UNIT_MEASURE") %>% 
  select(id, contains(".en"))
unit.list %>% kbl("rst")
unit.list %>% filter(id=="V")

# get concepts from DSD
concepts <- as.data.frame(slot(raw.struct, "concepts"))
concepts


ssa.id<-country.list %>% rename(country=2) %>% 
  mutate(iso3c=countrycode(country, "country.name", "iso3c")) %>% 
  select(id, iso3c, country) %>% 
  filter(iso3c%in%ssa.list)

#build actual query
query.url<-"https://sdmx.oecd.org/public/rest/data/OECD.DCD.FSD,DSD_DAC2@DF_DAC2A,1.2/"
query.don<-"ALLD" #All donors
query.rec<-paste0(ssa.id$id, collapse="+") #list of SSA recipients
# query.rec<-"F6" #lOECD SSA recipients
query.aid<-"206" #Net ODA
query.dat<-"V" #V = Current prices and Q = constant prices
query.time<-"?startPeriod=1990&endPeriod=2024"
query.end<-"&dimensionAtObservation=AllDimensions"

  
query.full<-paste0(query.url,query.don,".", query.rec,".", query.aid,"..",query.dat, query.time, query.end)
query.full
# query.full<-"https://sdmx.oecd.org/public/rest/data/OECD.DCD.FSD,DSD_DAC2@DF_DAC2A,1.2/ALLD.F6+KEN+ETH+BDI.218+201+206..V?startPeriod=2022&endPeriod=2023&dimensionAtObservation=AllDimensions"
raw.sdmx<-readSDMX(query.full)
raw <- as.data.frame(raw.sdmx)
data<-raw %>% 
  select(1,2,3,4,7) %>% 
  purrr::set_names(nm=c("year", "donor", "id","measure", "value"))

data.oda <- data %>% 
  filter(measure=="206") %>% 
  left_join(ssa.id) %>% 
  select(iso3c, year, value) %>% 
  group_by(year) %>% 
  summarize(oda=sum(value)) %>% 
  ungroup() %>% 
  mutate(year=as.numeric(year))


data.gdp<-idata.basic(c("NGDPD"), ssa.list, "IMF.RES.WEO:WEO_LIVE", "1990", "2023", "A") %>% 
  mutate(year=year(date))%>%
  group_by(year) %>% 
  mutate(ngdpd=ifelse(iso3c=="ZAF"& year<=1991, 0,ngdpd))%>% 
  summarize(gdpd=sum(ngdpd, na.rm=T)) %>% 
  select(year, gdpd)
  
plot.data<-data.oda %>% 
  left_join(data.gdp) %>%
  mutate(odagdp=1000000*oda/gdpd*100) %>% 
  filter(year>=1990)

plot.data %>% tail()

new.data<-idata.basic(c("PCPI_PCH", "NGDPD"), c("USA", "G603"),"IMF.RES.WEO:WEO_LIVE", "2024", "2024", "A")
  
Newpoint<-plot.data %>%
  slice(n())%>%
  mutate(oda=oda*(1+new.data$pcpi_pch[2]/100)*(1-7.8/100)) %>%
  mutate(odagdp=oda/new.data$ngdpd[1]*1000000*100) %>%
  mutate(year=2024)

plot.data %>% rbind(Newpoint) %>% tail() %>% kbl("rst", digits=1)

g.oda<-ggplot(plot.data)+geom_line(aes(year, odagdp), col=ssapeach2, size=1.5, data=. %>% filter(year<=2023))+
 geom_point(aes(year, odagdp), col=ssapeach2, size=3, data=. %>% filter(year==2023))+
  geom_point(aes(year, odagdp), col=ssapeach2, size=3, data=Newpoint, shape=1)+
  annotate("text", x=2024, y=Newpoint$odagdp+0.15, label="Proj.", size=7/.pt, hjust=0.5)+
  geom_line(aes(year, mean(odagdp)), data=. %>% filter(year%in%2000:2009),lty=4, col=ssagrey3, size=1)+
   geom_line(aes(year, mean(odagdp)), data=. %>% filter(year%in%2010:2019),lty=4, col=ssagrey3, size=1)+
  geom_line(aes(year, mean(odagdp)), data=. %>% filter(year%in%1990:1999),lty=4, col=ssagrey3, size=1)+
      labs(title = str_wrap("Sub-Saharan Africa, ODA Inflows, 1990-2024",45),
       subtitle = "(Percent of SSA GDP)",
       caption = "Sources: OECD and IMF staff calculations")
g.oda
ggsave(filename = "oda.png",  height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")


```

```{r}
#| label: Spreads Ribbon Chart 
#| output: false
#| echo: false
series.list<-c('JPSSGAOB Index', # AGO Yes
               "JPSSGDGH Index", # GHA Yes
               "JPGCKESS Index", #KEN Yes
               "JPSSGNIG Index", #NGA Yes 
               "JPSSGSN Index", #SEN/WAEMU Yes
               "JPSSGSAF Index", #ZAF Yes
               # "JPSSGTZB Index", #TZA No
               "JPSSGZMB Index", #ZMB Yes
               "JPSSGCDI Index", #CIV Yes
               "JPEGETSS Index", #ETH Yes
               "JPSSGGA Index", #GAB Yes
               "JPSSGMZB Index",#MOZ Yes
               "JPSSGNMB Index",#NAM Yes
               # "JPGCCMSS Index",#CMR No
               "JPEIGLSP Index"
               # ,#EMBI Yes
               # "USGG10YR Index"#USA Yes
               )

raw = bbextract(series.list, "2019-01-1", Sys.Date()) 
raw %>% tail()


data<-raw %>%  
  tidyr::fill(everything())
# %>% 
  # filter(date<=cutoff.date)
plotlist<-data.frame(index=c('JPSSGAOB', # AGO Yes #
                             "JPSSGDGH", # GHA Yes #
                             "JPGCKESS", #KEN Yes #
                             "JPSSGNIG", #NGA Yes #
                             "JPSSGSN ", #SEN/WAEMU Yes #
                             "JPSSGSAF", #ZAF Yes #
                             "JPSSGZMB", #ZMB Yes
                             "JPSSGCDI", #CIV Yes #
                             "JPEGETSS", #ETH Yes
                             "JPSSGGA ", #GAB Yes #
                             "JPSSGMZB",#MOZ Yes
                             "JPSSGNMB",#NAM Yes
                             "JPEIGLSP"),
                     iso3c=c(c("AGO", "GHA", "KEN","NGA","SEN", "ZAF", "ZMB", "CIV",
                               "ETH", "GAB", "MOZ", "NAM", "EMBI")
                     ))#EMBI Yes
                             
data %>% tail(10)
skim(data)
# data %>% write.csv(file = "spreads.csv")

spreads.data<-data %>% 
  rowwise() %>% 
  mutate(SSAx=mean(c(JPSSGSAF,JPSSGCDI,JPSSGNIG,`JPSSGGA `,JPSSGAOB,`JPSSGSN `, JPGCKESS, JPSSGMZB, JPSSGNMB), na.rm=T),
         SSA=mean(c(JPSSGSAF,JPSSGCDI,JPSSGNIG,`JPSSGGA `,JPSSGAOB,`JPSSGSN `,JPSSGDGH, JPSSGZMB, JPGCKESS,  JPSSGMZB, JPSSGNMB), na.rm=T))%>% 
  select(date, SSAx, JPEIGLSP, JPGCKESS) %>% #exclude Zambia and Ghana
  rename(EMBI.Global=3) %>% 
  filter(date>=as.Date("2018-06-30"))

plot.data<-spreads.data %>%
  filter(date>=as.Date("2021-9-1")-1) %>%
  mutate(gap=SSAx-EMBI.Global) %>% 
  ungroup()
max.data<-plot.data %>% 
  ungroup() %>% 
  filter(gap==max(gap))


lastobs<-plot.data %>% slice(n()) %>% pull(date) %>% format("%d %b %Y")
g.ribbon<-ggplot(plot.data)+ 
   geom_ribbon(aes(date, ymin=EMBI.Global, ymax=SSAx), fill=ssagrey1, alpha=.3)+
   geom_line(aes(date, SSAx), col=ssapeach3, size=1)+
   geom_line(aes(date, EMBI.Global), col=ssagrey3, size=1)+
  geom_segment(aes(x=date, xend=date, y=EMBI.Global+20, yend=SSAx-50), data=. %>% slice(1),
               arrow =  arrow(ends = "both",length=unit(0.01, "npc"),type="closed"),col="grey30")+
    annotate("text", x=min(plot.data$date)+60, y=400, 
             label=sprintf("%3.0f", first(plot.data$gap)), col="grey30", fontface="bold", size=2.5)+
  geom_segment(aes(x=date, xend=date, y=EMBI.Global+50, yend=SSAx-70), data=max.data,
               arrow =  arrow(ends = "both",length=unit(0.01, "npc"),type="closed"),col="grey30")+
    annotate("text", x=max.data$date+60, y=750, 
             label=sprintf("%3.0f", max.data$gap), col="grey30", fontface="bold", size=2.5)+
  geom_segment(aes(x=date, xend=date, y=EMBI.Global+50, yend=SSAx-50),
               data=. %>% slice(n()),
               arrow =  arrow(ends = "both",length=unit(0.01, "npc"),type="closed"),col="grey30")+
    annotate("text", x=max(plot.data$date)+60, y=450, 
             label=sprintf("%3.0f", last(plot.data$gap)), col="grey30", fontface="bold", size=2.5)+
  
   scale_x_date(breaks=seq(as.Date("2022-1-1"), Sys.Date(), by="6 months")-1,date_labels = "%b\n%y")+
    labs(title = "Sub-Saharan Africa. Sovereign Spreads",
       subtitle = "(bps, simple average, ex ZAM, GHA, ETH)",
       caption=paste0(str_wrap("Source: Bloomberg LLC and IMF staff calculations",75), "\n",str_wrap( "Note: Average includes ZAF, CIV, NGA, GAB, AGO, KEN, MOZ, NAM", 75)))+
  annotate("text", x=as.Date("2023-7-30"), y=450, label="EMBIG", size=2.5, col=ssagrey4)+
  annotate("text", x=as.Date("2023-7-30"), y=900, label="SSA", size=2.5, col=ssapeach4)

# g.ribbon+
#    theme(axis.text.x = element_blank(),
#          axis.text.y = element_blank()
#          )

ggsave(filename = "ribbon.png",
       height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")

plot.data %>% ungroup() %>% slice(1,(n()-30):n()) %>% kbl("rst", digits=0)



```




```{r}
#| label: Eurobond Issuance Bar Chart
#| output: false
#| echo: false
raw<-read_excel("Q:\\DATA\\AREO\\Spring 2025 - REO\\Data\\Bond issuances.xlsx", sheet = "SSA", range="An34:au53") %>%
  rename(year=1)


raw %>% filter(year%in%c(2007:2022)) %>%
  pivot_longer(2:8,names_to = "country", values_to = "value") %>%
  group_by(country) %>%
  summarize(total=sum(value, na.rm=T)) %>%
  arrange(-total)

plot.data<-raw %>%
  filter(year%in%c(2007:2025)) %>%
  pivot_longer(2:8,names_to = "country", values_to = "value") %>%
  mutate(region=case_when(
    country=="South Africa"~"ZAF",
    country=="Ghana"~"GHA",
    country=="CÃ´te d'Ivoire"~"CIV",
    country=="Nigeria"~"NGA",
    TRUE~ "Others"
  )) %>%
  mutate(region=factor(region, levels = c("Others",
                                   "CIV",
                                   "GHA",
                                   "NGA",
                                   "ZAF")))
plot.data.tot<-plot.data %>%
  group_by(year) %>%
  summarize(total=sum(value, na.rm=T))
label.val<-plot.data %>% 
  filter(year==2025) %>% 
  summarize(value=sum(value, na.rm=T)) %>% 
  pull(value)

g.issuance<-ggplot(plot.data %>% filter(year>=2010))+
  geom_bar(aes(year, value, fill=region), stat="identity")+
  # geom_line(aes(year, mean(total)), col=ssapeach5,lty=2, size=1,
  #           data=plot.data.tot %>%
  #                filter(year%in%c(2007:2009)))+
  # geom_line(aes(year, mean(total)), col=ssapeach5, lty=2, size=1,
  #           data=plot.data.tot %>%
  #                filter(year%in%c(2010:2014)))+
  # geom_line(aes(year, mean(total)), col=ssapeach5, lty=2, size=1,
  #           data=plot.data.tot %>%
  #                filter(year%in%c(2015:2019)))+
  #  geom_line(aes(year, mean(total)), col=ssapeach5, lty=2,size=1,
  #            data=plot.data.tot %>%
  #                filter(year%in%c(2020:2023)))+
  theme(legend.position = c(.2,.8),
        legend.title = element_blank(),
        legend.key.size = unit(.3, "cm"),
         # axis.text.x = element_blank(),
         # axis.text.y = element_blank()
         )+
  annotate("text", x=2025, y=label.val, label="1/", vjust=-.4, size=6/.pt)+
  coord_cartesian(xlim = c(2010,2025))+
  scale_x_continuous(breaks = seq(2010, 2025, by=5))+
  scale_fill_manual(values = c(ssagrey1, ssapeach1, ssapeach3, ssapeach5, ssapeach4))+
  labs(title = "SSA. Eurobond Issuance, 2010-25",
       subtitle = "(USD billions)",
       caption = paste0("Source: Bloomberg LLC", "\n", "1/ As of January, 2025"))
g.issuance

ggsave(filename = "issuance.png",
       height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")
```


```{r}
#| label: Exchange Rate Weighted Line Chart
#| output: false
#| echo: false
cutoff.date<-as.Date("2023-3-31")
cutoff.date<-as.Date(Sys.Date())

weights.trade<-idata.basic(c("NGDPD","BXGS_GDP_BP6", "BMGS_GDP_BP6"), ssa.list, "IMF.RES.WEO:WEO_LIVE", "2024", "2024", "A")%>% 
  mutate(importd=bmgs_gdp_bp6*ngdpd,
         exportd=bxgs_gdp_bp6*ngdpd)%>% 
  mutate(w=exportd+importd)%>%
   select(iso3c, w)

weights.ppp<-idata.basic(c("PPPGDP"), ssa.list, "IMF.RES.WEO:WEO_LIVE", "2024", "2024", "A")%>% 
  rename(w=pppgdp) %>% 
  select(iso3c, w)

weights<-weights.trade

weights %>% arrange(desc(w)) %>% 
  mutate(total=sum(w, na.rm=T)) %>% 
  mutate(w=w/total*100) %>% 
  select(iso3c, w) %>% 
  head(10)%>% ggplot(aes(w, fct_reorder(iso3c, w)))+geom_bar(stat="identity")


db='IMF.CSF:BBGDL'
bbseries<-imf_datatools$idata_utilities$get_dimension_values(db,"TICKER") %>% data.frame() %>% mutate(code=rownames(.))

# bbseries<-imf_datatools$idata_utilities$get_dimensions(db)


bbseries %>% 
  filter(str_detect(code, "CURNCY"))%>%
  filter(str_detect(code, "USD")) %>%
  head() %>% 
  kableExtra::kbl("rst")

series.list<-c(
  "USDAOA_CURNCY", # Angola
  "USDXOF_CURNCY", # Cote DIvoire (WAEMU)
  "USDETB_CURNCY", # Ethiopia
  "USDXAF_CURNCY", # Cameroon (CEMAC)
  "USDGHS_CURNCY", # Ghana
  "USDKES_CURNCY", # Kenya
  "USDMUR_CURNCY", # Mauritius
  "USDMZN_CURNCY", # Mozambique
  "USDNGN_CURNCY", # Nigeria
  "RWF_BNRW_CURNCY", # Rwanda
  "USDZAR_CURNCY", # South Africa
  "USDTZS_CURNCY", # Tanzania
  "USDUGX_CURNCY", # Uganda
  "USDZMW_CURNCY", # Zambia
  "USDBWP_CURNCY", # Botswana
  "USDBIF_CURNCY", # Burundi
  "USDCVE_CURNCY", # Cape Verde
  "USDKMF_CURNCY", # Comoros
  "USDCDF_CURNCY", # DR Congo
  "USDERN_CURNCY", # Eritrea
  "USDSZL_CURNCY", # Eswatini
  "USDGMD_CURNCY", # Gambia
  "USDGNF_CURNCY", # Guinea
  "USDLSL_CURNCY", # Lesotho
  "USDLRD_CURNCY", # Liberia
  "USDMGA_CURNCY", # Madagascar
  "USDMWK_CURNCY", # Malawi
  "USDNAD_CURNCY", # Namibia
  "USDSTN_CURNCY", # Sao Tome and Principe
  "USDSCR_CURNCY", # Seychelles
  "USDSLL_CURNCY", # Sierra Leone
  "USDZWL_CURNCY") # Zimbabwe

# series.list<-c("GBS_BGN_CURNCY")

raw = bbiextract(series.list, "PX_LAST", "2014-01-1", as.character(Sys.Date()), "D") 
raw %>% tail()

frame<-data.frame(date=seq(as.Date("2014-01-1"), as.Date(Sys.Date()), by="day"))


data.bbg<-frame %>% 
  left_join(raw) %>%  
  tidyr::fill(everything()) %>% 
  filter(date<=cutoff.date)


names(data.bbg)
names<-c("RWA", "AGO", "BDI", "BWA", "COD",
         "CPV", "ERI", "ETH", "GHA", "GMB",
         "GIN", "KEN", "COM", "LBR", "LSO",
         "MDG", "MUS", "MWI", "MOZ", "NAM",
         "NGA", "SYC", "SLE", "STP", "SWZ",
         "TZA", "UGA", "GAB", "CIV", "ZAF",
         "ZMB", "ZWE" )
countrycode(names, "iso3c", "country.name")
names(data.bbg)<-c("date", names)

base.date<-as.Date("2023-12-31")

frame<-data.frame(date=seq(base.date-30, as.Date(Sys.Date()), by="day"))


plot.data<-frame %>% 
  left_join(data.bbg) %>% 
  fill(everything()) %>%
  mutate(BEN=CIV, #WAEMU countries
         BFA=CIV,
         GNB=CIV,
         MLI=CIV,
         NER=CIV,
         SEN=CIV,
         TGO=CIV) %>% 
  mutate(CMR=GAB, #CEMAC countries
         CAF=GAB,
         TCD=GAB,
         COG=GAB,
         GNQ=GAB)%>% 
  pivot_longer(2:45, names_to = "iso3c", values_to = "er")%>% 
  group_by(iso3c)%>% 
  arrange(iso3c,date)%>% 
  mutate(base=mean(ifelse(date==base.date,er,NA), na.rm=T))%>%
  mutate(index=base/er*100) %>% 
  mutate(area=case_when(
    iso3c%in%WAEMU~"WAEMU",
    iso3c%in%CEMAC~"CEMAC",
    TRUE~"other"
  )) %>% 
  mutate(type=case_when(
    iso3c%in%oilexport~"Oil Exporter",
    iso3c%in%otherresource~"Other Resource",
    iso3c%in%nonresource~"Non Resource",
    TRUE~NA_character_
  )) 


ggplot(plot.data %>% filter(date>=base.date) )+
  geom_hline(yintercept=100, lty=2)+
  geom_line(aes(date, index, group=iso3c,
                col=area,
                size=area,
                alpha=area))+
  ggrepel::geom_text_repel(aes(date, index, group=iso3c, label=iso3c), size=5/.pt, data=. %>% group_by(iso3c) %>% slice(n()))+
  scale_color_manual(values=c(ssablue, "grey30", "firebrick"))+
  scale_alpha_manual(values=c( .2,.3,.2), guide=F)+
  scale_size_manual(values=c(1.2,.8, 1.2), guide=F)+
  scale_x_date(breaks = seq(as.Date("2020-1-1"), as.Date(Sys.Date()), by="6 months")-1,
               date_labels = "%b\n%y")+
  theme(legend.title = element_blank(),
        legend.position = "top")+
  labs(title = "SSA Exchange Rates, 2019-2022",
       subtitle = "(Index, Dec 31, 2023 = 100)")+
  facet_wrap(type~.)

line.data.all<-plot.data %>% 
  ungroup()%>% 
  left_join(weights)%>% 
  na.omit() %>% #for ERI
  group_by(date)%>% 
  summarize(mean=weighted.mean(index, w, na.rm=T))

euroraw<- bbiextract("USDEUR_CURNCY", "PX_LAST", "2019-12-31", "2025-12-31", "D") 

eurodata<-frame%>% 
  left_join(euroraw) %>%
  fill(everything()) %>% 
  janitor::clean_names()%>% 
  mutate(base=mean(ifelse(date==base.date,usdeur,NA), na.rm=T))%>%
  mutate(indexeur=base/usdeur*100)

  eurodata %>% tail()

line.data.all.eur<-line.data.all %>% 
  left_join(eurodata) %>% 
  mutate(meaneur=mean/indexeur*100)
line.data.all.eur %>% tail()

g.er<-ggplot(line.data.all.eur %>% filter(date>=base.date))+
  geom_ribbon(aes(date, ymin=mean, ymax=100), fill=ssagrey3, alpha=.5)+
  geom_line(aes(date, mean), col=ssagrey3, size=1)+
  geom_ribbon(aes(date, ymin=meaneur, ymax=100), fill=ssablue, alpha=.3)+
  geom_line(aes(date, meaneur), col=ssablue, size=1)+
  geom_hline(aes(yintercept=100), lty=2, col="grey30")+
  geom_point(aes(date, mean), size=3, col=ssagrey3, data=. %>% slice(n()))+
  geom_point(aes(date, meaneur), size=3, col=ssablue, data=. %>% slice(n()))+
  scale_x_date(breaks=seq(base.date, as.Date(Sys.Date()), by="3 months")-1,
               date_labels = "%b\n%y")+
  # geom_vline(aes(xintercept=as.Date("2024-11-04")), lty=2, size=.5, color="firebrick")+
  geom_vline(aes(xintercept=as.Date("2025-03-04")), lty=2, size=.5, color="firebrick")+
  geom_vline(aes(xintercept=as.Date("2025-04-03")), lty=2, size=.5, color="firebrick")+
  annotate("text", x=as.Date("2025-3-1")-25, y=102, label = "US Tariffs\nAnnouncement\nMarch", size=2.5, col="firebrick", hjust=1)+
  annotate("text", x=as.Date("2025-4-4")+25, y=102, label = "April 2", size=2.5, col="firebrick", hjust=0)+
  annotate("text", 
         x = as.Date(Sys.Date()), 
         y = last((line.data.all.eur %>% filter(date>=base.date))$mean), 
         label = "vs USD", size = 2.5, col = ssagrey4, hjust=-.3)+
  annotate("text", 
         x = as.Date(Sys.Date()), 
         y = last((line.data.all.eur %>% filter(date>=base.date))$meaneur), 
         label = "vs EUR", size = 2.5, col = ssablue, hjust=-.3)+
  labs(title = str_wrap(glue::glue("Sub-Saharan Africa: Exchange Rates, ",year(base.date)," - ",year(as.Date(Sys.Date()))),75),
       caption="Source: Bloomberg, WEO database, and IMF staff calculations",
       subtitle = glue::glue("(Trade weighted index, ",format(base.date, "%b %d %Y")," = 100)"))+
  coord_cartesian(ylim=c(87,103), xlim=c(base.date, as.Date(Sys.Date())+months(3)))
g.er


ggsave(filename = "ertrend.png",
       height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")

```

```{r}
#| label: Save charts for page 1
#| echo: false
#| output: false
#| warning: false

save(g.gdpdot, g.oda, g.ribbon, g.issuance, g.er,
     file="gallery_page1.RData")  
     
```

# Page 2

```{r}
#| label: USD Yield Chart using GAS projections
#| output: false
#| echo: false
db<-imf_datatools$idata_utilities$get_databases()
series<-imf_datatools$idata_utilities$get_dimension_values("IMF.RES.GAS:GAS_LIVE", "INDICATOR") %>% data.frame()
series %>% rownames_to_column("code") %>% filter(str_detect(code, c("FIGB"))) %>% kbl("rst")
series %>% rownames_to_column("code") %>% filter(str_detect(Name, c("yield"))) %>% kbl("rst")

comm.codes=c("FIGB", "FIST") # For GAS

from<-"2008"
to<-"2029"

gas.interest.now<-idata.basic("FIGB", "USA", "IMF.RES.GAS:GAS_LIVE", from, to, "Q") %>% 
  mutate(date=date+months(3)-1) %>%  #quarterly projections
  mutate(vintage="now")

plot.interest<-gas.interest.now %>%
  mutate(year=year(date)) %>%
  filter(year%in%2009:2027) %>% 
  mutate(precrisis=mean(ifelse(year%in%c(2009:2019),figb,NA), na.rm=T),
         preperiod=(year%in%c(2009:2019)))%>%   mutate(postcrisis=mean(ifelse(year%in%c(2022:2027),figb,NA), na.rm=T),
         postperiod=(year%in%c(2022:2027)))
  

g.ust<-ggplot(plot.interest %>% filter(date>=as.Date("2015-1-1")-1))+
  geom_line(aes(date,figb), size=1, col=ssagrey3)+
  geom_line(aes(date,precrisis), lty=2, data=. %>% filter(preperiod==T))+
  geom_line(aes(date,postcrisis), lty=2, data=. %>% filter(postperiod==T))+
  annotate("text", x=as.Date("2026-12-31"), y=3, label="Oct 24\nWEO", size=6/.pt, color=ssagrey4)+
  annotate("rect", xmin=as.Date(Sys.Date()), xmax=max(plot.interest$date), ymin=-Inf,ymax=Inf, fill=ssapeach1, alpha=.4)+
  scale_x_date(date_labels = "%b\n%Y",
               breaks=seq(as.Date("2015-1-1"), max(gas.interest.now$date), by="1 years")-1)+
  labs(title="United States. 10 Year Bond Yields",
       subtitle = "(percent)",
       caption = "Source: WEO Database")
g.ust$data %>% kbl("rst")
g.ust

ggsave(filename = "ust.png",
       height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")

```


```{r}
#| label: Risk Premia vs spread Scatter Plot
#| output: false
#| echo: false

bb.codes<-data.frame(country=c("Argentina",
"Bolivia",
"Brazil",
"Belize",
"Chile",
"Colombia",
"Costa Rica",
"Dominican Republic",
"Ecuador",
"Guatemala",
"Honduras",
"Jamaica",
"Mexico",
"Panama",
"Peru",
"Paraguay",
"Suriname",
"El Salvador",
"Trinidad and Tobago",
"Uruguay",
"Venezuela",
"Armenia",
"Azerbaijan",
"Belarus",
"Croatia",
"Georgia",
"Hungary",
"Kazakhstan",
"Lithuania",
"Poland",
"Romania",
"Russia",
"Serbia",
"Slovakia",
"Tajikistan",
"Turkey",
"Ukraine",
"Iraq",
"Jordan",
"Lebanon",
"Oman",
"United Arab Emerates",
"Bahrain",
"Kuwait",
"Qatar",
"Saudi Arabia",
"Egypt",
"Morocco",
"Tunisia",
"Angola",
"Cote d'Ivoire",
"Cameroon",
"Ethiopia",
"Gabon",
"Ghana",
"Kenya",
"Mozambique",
"Namibia",
"Nigeria",
"Senegal",
"South Africa",
"Zambia",
"China",
"Indonesia",
"India",
"Sri Lanka",
"Mongolia",
"Malaysia",
"Papua New Guinea",
"Philippines",
"Pakistan",
"Vietnam"),
code=c("JPSSGARG_INDEX",
       "JPSSGBOB_INDEX",
       "JPSSGBRA_INDEX",
       "JPSSGBE_INDEX",
       "JPSSGCHI_INDEX",
       "JPSSGCOL_INDEX",
       "JPSSGCTR_INDEX",
       "JPSSGDOR_INDEX",
       "JPSSGECU_INDEX",
       "JPSSGGTB_INDEX",
       "JPSSGHNB_INDEX",
       "JPSSGJM_INDEX",
       "JPSSGMEX_INDEX",
       "JPSSGPAN_INDEX",
       "JPSSGPER_INDEX",
       "JPSSGPYB_INDEX",
       "JPEGSRSS_INDEX",
       "JPSSGELS_INDEX",
       "JPSSGTT_INDEX",
       "JPSSGURG_INDEX",
       "JPSSGVEN_INDEX",
       "JPSSGAMB_INDEX",
       "JPSSGAZB_INDEX",
       "JPSSGBY_INDEX",
       "JPSSGCRO_INDEX",
       "JPSSGGE_INDEX",
       "JPSSGHNG_INDEX",
       "JPSSGKZ_INDEX",
       "JPSSGLIT_INDEX",
       "JPSSGPOL_INDEX",
       "JPSSGROM_INDEX",
       "JPSSGRUS_INDEX",
       "JPSSGSER_INDEX",
       "JPSSGSKB_INDEX",
       "JPEGTJSS_INDEX",
       "JPSSGTUR_INDEX",
       "JPSSGUKR_INDEX",
       "JPSSGIRQ_INDEX",
       "JPSSGJO_INDEX",
       "JPSSGLEB_INDEX",
       "JPEGOMSS_INDEX",
       "JPEGAESS_INDEX",
       "JPEGBHSS_INDEX",
       "JPEGKWSS_INDEX",
       "JPEGQASS_INDEX",
       "JPEGSASS_INDEX",
       "JPSSGEGY_INDEX",
       "JPSSGMOR_INDEX",
       "JPSSGTUN_INDEX",
       "JPSSGAOB_INDEX",
       "JPSSGCDI_INDEX",
       "JPEGCMSS_INDEX",
       "JPEGETSS_INDEX",
       "JPSSGGA_INDEX",
       "JPSSGGH_INDEX",
       "JPEGKESS_INDEX",
       "JPSSGMZB_INDEX",
       "JPSSGNMB_INDEX",
       "JPSSGNIG_INDEX",
       "JPSSGSN_INDEX",
       "JPSSGSAF_INDEX",
       "JPSSGZMB_INDEX",
       "JPSSGCHN_INDEX",
       "JPSSGIDO_INDEX",
       "JPSSGINB_INDEX",
       "JPSSGLK_INDEX",
       "JPSSGMNB_INDEX",
       "JPSSGMAL_INDEX",
       "JPEGPGSS_INDEX",
       "JPSSGPHL_INDEX",
       "JPSSGPAK_INDEX",
       "JPSSGVIE_INDEX"
))
bb.codes<-bb.codes %>% 
  mutate(iso3c=countrycode(country, "country.name", "iso3c"))

raw.s1 = bbiextract(bb.codes %>% slice(1:60) %>% pull(code), "PX_LAST", "2021-06-30", as.character(Sys.Date()), "D") 
raw.s2 = bbiextract(bb.codes %>% slice(61:80) %>% pull(code), "PX_LAST", "2021-06-30", as.character(Sys.Date()), "D") 
raw.s<-left_join(raw.s1, raw.s2, by="date")
raw.s %>% tail()

data.s<-raw.s %>%  
  tidyr::fill(everything()) %>% 
  filter(date<=cutoff.date)
start="2021-7-1"

data.s %>% tail(10)

plotlist<-bb.codes %>% 
  filter(iso3c%in%ssa.list) %>% 
  mutate(code=tolower(str_extract(code, ".+?(?=_)")))
data.s %>% tail(10)

spark.data.s<-data.s %>% 
    # select(-c(JPEIGLSP)) %>% 
    filter(date>=as.Date(start)) %>% 
    pivot_longer(-date,names_to = "code", values_to = "value") %>% 
    arrange(code,date) %>% 
    group_by(code) %>% 
    fill(value) %>% 
    mutate(base=sum(ifelse(date==as.Date(start),value,0))) %>% 
    mutate(change=value-base) %>% 
    mutate(max=max(change),
           min=min(change),
           latest=last(value),
           week=nth(change, -8)) %>% 
    mutate(pos=ifelse(change>=0,change,0),
           neg=ifelse(change<0,change,0))
last.date.s<-spark.data.s %>% pull(date) %>% max() %>% format("%d %b %Y")

risk.raw<-read_excel("C:\\Users\\atiffin\\OneDrive - International Monetary Fund (PRD)\\September 2025 Transfer\\Projects\\Ukraine\\spread_forcharts_at.xlsx", sheet="spread_forcharts", range="A1:t72") 



moodysmap<-data.frame(moodycode=c("Aaa",
                                  "Aa1", "Aa2","Aa3",
                                  "A1", "A2", "A3",
                                  "Baa1", "Baa2", "Baa3",
                                  "Ba1", "Ba2", "Ba3",
                                  "B1", "B2", "B3",
                                  "Caa1", "Caa2", "Caa3",
                                  "Ca", "C"),
                      moodyscore=c(1:21))
fitchmap<-data.frame(fitchcode=c("AAA",
                                  "AA+", "AA","AA-",
                                  "A+", "A", "A-",
                                  "BBB+", "BBB", "BBB-",
                                  "BB+", "BB", "BB-",
                                  "B+", "B", "B-",
                                  "CCC+", "CCC", "CCC-",
                                  "CC", "C",
                                 "DDD", "DD", "D"),
                      fitchscore=c(1:24))
SPmap<-data.frame(SPcode=c("AAA",
                                 "AA+", "AA","AA-",
                                 "A+", "A", "A-",
                                 "BBB+", "BBB", "BBB-",
                                 "BB+", "BB", "BB-",
                                 "B+", "B", "B-",
                                 "CCC+", "CCC", "CCC-",
                                 "CC", "C",
                                 "SD", "D"),
                     SPscore=c(1:23))

risk.data<-risk.raw %>% 
  select(iso3c,`Moody's`, `S&P`, Fitch ) %>% 
  rename(moodycode=`Moody's`, SPcode=`S&P`, fitchcode=Fitch) %>% 
  left_join(moodysmap) %>% 
  left_join(fitchmap) %>% 
  left_join(SPmap) %>% 
  select(iso3c, moodycode, moodyscore, fitchcode, fitchscore, SPcode, SPscore) %>%
  rowwise() %>% 
  mutate(riskscore=mean(c(moodyscore, fitchscore,SPscore), na.rm=T)) %>% 
  ungroup() %>% 
  mutate(region=ifelse(iso3c%in%ssa.list, "SSA", "Other EMDE")) 
plotlist2<-bb.codes %>% 
  # filter(iso3c%in%SSAlist) %>% 
  mutate(code=tolower(str_sub(code, 1,8)))

plot.data2<-spark.data.s %>% #meaSURING CHANGE SINCE CRISIS
  select(date, code, value) %>% 
  # filter(date<=as.Date("2022-12-31")) %>%
  filter(date>=as.Date("2025-4-1"))%>%
  # filter(date>=as.Date("2021-9-1"))%>%
  # filter(date>=as.Date(Sys.Date())-weeks(52)) %>%
  group_by(code) %>%
  slice(1,n())%>% 
  mutate(diff=value-lag(value),
         initial=lag(value))%>% 
  fill(diff, .direction = "up") %>% 
  left_join(plotlist2)  %>%
  filter(!is.na(iso3c)) %>% 
  mutate(country=countrycode(iso3c, "iso3c", "country.name")) %>% 
  slice(n()) %>% 
  left_join(risk.data) %>% 
  filter(!diff==0)

g.risk2<-ggplot(plot.data2 %>% filter(abs(diff)<=1000)) +
  # geom_smooth(aes(riskscore, diff), se=T, lty=2, size=.6, alpha=.5, method="gam",fullrange=T, col="grey30", fill="grey70", level=.95)+
  geom_smooth(aes(riskscore, diff, col=region, fill=region), se=F, lty=2, size=.6, alpha=.3, fullrange=T, level=.95, span=2, method="lm")+
  geom_point(aes(riskscore,diff, col=region), size=2, alpha=.5)+
  geom_hline(aes(yintercept=0), lty=2, col="grey30")+
  scale_color_manual(values = c("grey50", ssapeach4), guide=F)+
  scale_fill_manual(values = c("grey50", ssapeach4), guide=F)+
  ggrepel::geom_text_repel(aes(riskscore, diff, label=country, col=region), data=. %>% filter(abs(diff)>=100), size=3, force = 8)+
  annotate("text", x=8, y=50, label="Other EMDEs", col="grey50", size=3, fontface="italic", hjust=0)+
  annotate("text", x=8, y=120, label="SSA", col=ssapeach4, size=3, fontface="italic", hjust=0)+
  coord_cartesian(xlim=c(8, 21.5))+
  scale_x_continuous(breaks=c(8, 11,14,17, 21), labels = c("BBB+","BB+", "B+", "CCC+","D"))+
  xlab("Rating")+
  ylab("Change in Spread\n")+
  labs(title = "Change in Spread since Liberation Day vs. Rating (bps)",
       subtitle = paste0("(as of ",last.date.s,")"),
       caption="Source: Bloomberg LLC and IMF staff calculations")
g.risk2
ggsave(filename = "risk.png",
       height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")
       
```


```{r}
#| label: Debt Composition Alluvium Chart
#| echo: false
#| warning: false 
raw<-read_excel("Q:\\DATA\\AREO\\Fall 2025 - REO\\Data\\SSA debt data composition GG.xlsx", sheet = "REO CHART", range="a16:y26")%>% 
  rename(cat=1)%>% janitor::clean_names() %>% 
  pivot_longer(2:25, names_to = "year", values_to = "value") %>% 
  mutate(year=as.numeric(str_sub(year,2,-1))+1998)

plot.data<-raw %>% 
  filter(cat%in%c("Domestic debt",
    "Other external debt",
                  "Foreign commercial banks",
    "China",
    "External bonds",
    "Bilateral debt",
    "Multilateral debt")) %>% 
  pivot_wider(names_from = cat, values_from = value) %>% 
  mutate(`Other external debt`= `Other external debt`+`Foreign commercial banks`)%>% 
  mutate(`Bilateral debt`=`Bilateral debt`-`China`)%>% 
  select(-c(`Foreign commercial banks`)) %>% 
  pivot_longer(2:7, names_to = "cat", values_to = "value") %>% 
  group_by(year,cat) %>% 
  summarize(value=sum(value)) %>%
  mutate(cat=factor(cat, labels = c("Domestic",
                                    "Eurobonds",
                                    "Bilateral",
                                    "China",
                                    "Multilateral",
                                    "Other External"),
                    levels=c("Domestic debt",
                             "External bonds",
                             "Bilateral debt",
                             "China",
                             "Multilateral debt",
                             "Other external debt"))) %>% 
  group_by(year) %>% 
  # mutate(total=sum(value)) %>% mutate(value=value/total*100) %>% 
  filter(year%in%c(2000,2005,2010,2015,2020,2023))
  # filter(year%in%c(2000,2023))
  


g.debt<-ggplot(plot.data,
       aes(x = year, y = value, alluvium = cat)) +
  ggalluvial::geom_alluvium(aes(fill = cat, col=cat),alpha = .7, curve_type="sigmoid", width=0)+
  scale_fill_manual(values=c(ssagrey1, ssapeach1, ssapeach2, fundblue, ssapeach4, ssagrey4))+
  scale_color_manual(values=c(ssagrey1, ssapeach1, ssapeach2, fundblue, ssapeach4, ssagrey4))+
  scale_x_continuous(breaks=c(2000,2005,2010,2015,2020, 2023))+
  scale_y_continuous(breaks=c(0,20,40,60))+ guides(fill = guide_legend(ncol = 3))+
  theme(legend.position = "bottom", legend.text = element_text(size=7),
        legend.title = element_blank(),
        legend.key.size = unit(.3,"cm"))+
          labs(title = "Sub-Saharan Africa. Composition of Public Debt",
       subtitle = "(Percent of GDP)",
       caption = paste0(str_wrap("Sources: World Bank, International Debt Statistics; and IMF, World Economic Outlook database.
", 75),"\n", str_wrap("Note: Excludes Equatorial Guinea, Namibia, Seychelles, and South Sudan due to data availability", 75)))


ggsave(filename = "slide4a.png",
       height = 4, width=4, dpi=600,units="in", device="png", bg = "transparent")

alluvial.data<-plot.data %>% 
  filter(year%in%c(2000, 2023)) %>% 
  mutate(year=as.factor(year))
g.debta<-ggplot(alluvial.data,
       aes(x = year, y = value, alluvium = cat)) +
  ggalluvial::geom_alluvium(aes(fill = cat, col=cat),alpha = .3, curve_type="sigmoid", width=.6)+
  geom_col(aes(year, value, fill = cat), width =.6)+
  scale_fill_manual(values=c(ssagrey1, ssapeach1, ssapeach2, fundblue, ssapeach4, ssagrey4))+
  scale_color_manual(values=c(ssagrey1, ssapeach1, ssapeach2, fundblue, ssapeach4, ssagrey4))+
  coord_cartesian(ylim=c(0,60))+
  scale_y_continuous(breaks=c(0,20,40,60))+ guides(fill = guide_legend(ncol = 3))+
  theme(legend.position = "bottom", legend.text = element_text(size=7),
        legend.title = element_blank(),
        legend.key.size = unit(.3,"cm"))+
          labs(title = "Sub-Saharan Africa. Composition of Public Debt",
       subtitle = "(Percent of GDP)",
       caption = paste0(str_wrap("Sources: World Bank, International Debt Statistics; and IMF, World Economic Outlook database.
", 75),"\n", str_wrap("Note: Excludes Equatorial Guinea, Namibia, Seychelles, and South Sudan due to data availability", 75)))

ggsave(filename = "slide4b.png",
       height = 4, width=4, dpi=600,units="in", device="png", bg = "transparent")


```


```{r}
#| label: Eurobond Upcoming Maturities Bar Chart
#| output: false
#| echo: false

raw<-read_excel("Q:\\DATA\\AREO\\Fall 2025 - REO\\Data\\Bond Maturity.xlsx", sheet = "maturity", range="b2:s48", col_types = "numeric") %>% 
  rename(year=1)


raw %>% filter(year%in%c(2025:2025)) %>% 
  pivot_longer(2:17,names_to = "country", values_to = "value") %>% 
  group_by(country) %>% 
  summarize(total=sum(value, narm=T)) %>% 
  arrange(-total)%>% kbl("rst", digits=1)

plot.data<-raw %>% filter(year%in%c(2025:2027)) %>% 
  pivot_longer(2:17,names_to = "country", values_to = "value") %>% 
  mutate(region=case_when(
    country=="South Africa"~"ZAF",
    country=="Kenya"~"KEN",
    country=="Nigeria"~"NGA",
    TRUE~ "Others"
  ))%>% 
  mutate(region=factor(region, levels = c("Others",
                                   # "CIV",
                                   "KEN",
                                   "NGA",
                                   "ZAF"))) %>% 
  mutate(value=value/1000)

g.eb<-ggplot(plot.data)+geom_bar(aes(as.factor(year), value, fill=region), stat="identity")+
  scale_fill_manual(values = c(ssagrey1, ssapeach1, ssapeach3, ssapeach4),
                    labels=c("Others", "Ghana", "Nigeria", "S.Africa"))+
  theme(legend.title = element_blank(),
        legend.key.size = unit(.4, "cm"),
        legend.position = c(.8,.9))+
  labs(title = "SSA. Eurobond Repayments, 2025-27",
       subtitle = "(USD billions)",
       caption = "Source: Bloomberg")
g.eb  
plot.data %>% group_by(year) %>% 
  summarize(total=sum(value)) %>% kbl("rst", digits=1)


ggsave(filename = "slide5.png",
       height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")

```


```{r}
#| label: Inflation line chart with global composite
#| output: false
#| echo: false

raw<-read_excel(path="Q:\\DATA\\AREO\\Fall 2025 - REO\\Data\\SSA_Inflation.xlsx",
                    # sheet="Food CPI",
                    sheet="CPI (2)",
                    range="B1:ky47",
                    na=c("N.A.", "n.a.", "#N/A", "na", "NA"))

data<-raw %>% 
  rename(country=2) %>% 
  filter(!is.na(country)) %>% 
  mutate(iso3c=countrycode(country, "country.name", "iso3c")) %>% 
  select(-c(Series_code, country)) %>% 
  select(iso3c, everything()) %>% 
  pivot_longer(-c(1,2), names_to = "ym", values_to = "cpi") %>% 
  mutate(date=ym(ym)+months(1)-1,
         cpi=as.numeric(cpi)) %>% 
  select(date, iso3c, cpi) %>% 
  group_by(iso3c) %>% 
  mutate(cpi=zoo::na.approx(cpi, na.rm=F)) %>% 
  filter(iso3c!="ZWE")

data.seas<- data %>% 
  na.omit() %>% 
  mutate(ym=yearmonth(date))%>% 
  as_tsibble(index=ym, key=iso3c)%>% 
  # filter(iso3c%in%c("COM", "NGA"))%>%
  # model(x11=X_13ARIMA_SEATS(cpi~x11()))
  model(stl=STL(cpi))%>%
  components() %>% 
  as_tibble()%>% 
  mutate(date=as.Date(ym)+months(1)-1) %>% 
  select(date,iso3c,season_adjust) 

data.s<-data%>% 
  left_join(data.seas) %>% 
  rename(cpi.sa=season_adjust) %>% 
  group_by(iso3c) %>% 
  # mutate(cpim=zoo::rollmean(cpi.sa,12, align = "right", fill = NA))%>% 
  # mutate(pch=100*cpim/lag(cpim,12)-100) %>% 
  # mutate(pch=100*cpi.sa/lag(cpi.sa,12)-100) %>% # Seas.adj
  mutate(pch=100*cpi/lag(cpi,12)-100)%>% # not Seas.adj
  mutate(last=last(na.omit(pch)))%>% 
  ungroup() %>% 
  arrange(iso3c, date)
data%>% filter(iso3c=="KEN") %>%  tail(10)  

# Comparison with global trend --------------------------------------------

db="IMF.RES.WEO:WEO_LIVE"
ssa.weights.infl<-idata.basic("PPPGDP", ssa.list, db, "2000", "2025", "A") %>%
  mutate(pppgdp=ifelse(is.nan(pppgdp),NA,pppgdp)) %>%
  fill(pppgdp) %>%
  mutate(year=year(date)) %>%
  select(iso3c, year, pppgdp)

infl.list<-data.s %>% group_by(iso3c) %>%
  na.omit(pch)%>% 
  filter(date>=as.Date("2025-7-1")-1) %>% #Must have Jun 25 data
  slice(n())%>%
  pull(iso3c) %>% unlist()

length(infl.list)

weighted.geomean <- function(x, w, ...) exp(weighted.mean(log(x), w, ...))

m.codes<-c("N001PC@G10") # Composite global CPI index

haver.m<-imf_datatools$get_haver_data(m.codes) %>% 
  mutate(date=as.Date(row.names(.))+months(1)-1) %>% 
  filter(year(date)>=2002) %>% 
  select(date, everything()) %>%
  rename(cpi=2) %>% 
  mutate(pch.g=100*cpi/lag(cpi,12)-100) %>% 
  select(date, pch.g)

plot.infl.tot<-data.s%>% filter(iso3c%in%infl.list) %>% 
  filter(date<=as.Date("2025-6-30")) %>%
  select(date, iso3c, pch) %>%
  mutate(year=year(date)) %>% 
  left_join(ssa.weights.infl) %>% 
  group_by(date)%>% 
  arrange(date,pch) %>% 
  summarize(pch.m=100*weighted.geomean(1+pch/100,pppgdp, na.rm=T)-100,
            pch.med=median(pch, na.rm=T),
            pch.25=quantile(pch, .25, na.rm=T),
            pch.75=quantile(pch,.75, na.rm=T)) %>%
  left_join(haver.m) %>% 
  filter(year(date)>=2010) %>% 
  # filter(date<=as.Date("2022-12-31")) %>% #last date of chart
  ungroup()

  
g.infl<-ggplot(plot.infl.tot)+ 
  geom_ribbon(aes(date, ymin=pch.25, ymax=pch.75), fill=ssagrey2, alpha=.5)+
  geom_line(aes(date, pch.g), col=ssagrey3, size=1)+
  geom_point(aes(date, pch.g), col=ssagrey3, data = . %>% select(date,pch.g) %>% na.omit() %>% slice(n()), size=4)+
  # geom_line(aes(date, pch.m), col=ssapeach2, size=1.5)+
  geom_line(aes(date, pch.med), col=ssapeach4, size=1)+
  # geom_point(aes(date, pch.m), col=ssapeach2, data = . %>% slice(n()), size=4)+
  geom_point(aes(date, pch.med), col=ssapeach4, data = . %>% slice(n()), size=4)+
  # annotate("text", x=as.Date("2015-11-1"), y=12, label="SSA\n(Av.)", col=ssapeach2, size=2.5)+
  annotate("text", x=as.Date("2017-1-1"), y=8, label="SSA\n(Med.)", col=ssapeach4, size=2.5)+
  annotate("text", x=as.Date("2022-12-1"), y=2.5, label="Global\nComposite", col=ssagrey3, size=2.5)+
  scale_x_date(breaks=seq(as.Date("2011-1-1"), Sys.Date(), by="2 years")-1,
               date_labels = "%b\n%y")+
  theme(
    # axis.text = element_text(size=8),
        plot.title.position = "plot",
        plot.caption.position = "plot")+
  labs(title = "Sub-Saharan Africa. Headline Inflation, 2015-2025",
       subtitle = "(percent, y/y)",
       caption = "Source: Haver Analytics and IMF staff calculations")
g.infl$data %>% tail(20) %>% kableExtra::kbl("rst")
g.infl

ggsave(filename = "globalinfl.png",
       height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")

 
```



```{r}
#| label: Save charts for page 2
#| echo: false
#| output: false
#| warning: false

save(g.ust, g.risk2, g.debt, g.debta, g.eb, g.infl, 
     file="gallery_page2.RData")  
     
```

# Page 3

```{r}
#| label: Food Prices Line Chart
#| output: false
#| echo: false

# "https://www.fao.org/worldfoodsituation/foodpricesindex/en/"

raw<-read_excel("C:\\Projects\\OctREO25\\food_price_indices_data_oct.xls",
                sheet = "Indices_Monthly", range = "A3:h450")%>% 
  mutate(date=as.Date(Date)+months(1)-1) %>% 
  rename(food=2) %>% 
  select(date, food) %>% 
  na.omit()

plot.data<-raw %>% filter(date>=as.Date("2021-12-31"))
  
g.food<-ggplot(plot.data)+
  geom_line(aes(date, food), col=ssapeach3, size=1.5)+
  geom_area(aes(date, food), fill=ssapeach2, alpha=.4)+
  geom_point(aes(date, food), col=ssapeach3, data=. %>% slice(n()), size=4)+
  scale_linetype_manual(values=c(1,2,2), guide=F)+
  scale_size_manual(values=c(1.2,1,1), guide=F)+
  # scale_x_date(breaks=seq(as.Date("2001-1-1"), as.Date("2028-1-1"),
  #                         by="5 year")-1, date_labels="%Y")+
  scale_x_date(breaks=seq(as.Date("2021-1-1"), as.Date("2028-1-1"),
                          by="6 months")-1, date_labels="%b\n%y")+
  coord_cartesian(ylim=c(110,170))+
  theme(plot.title.position = "plot",
        plot.caption.position = "plot")+
  labs(title = "International Food Prices.",
       subtitle = "(Nominal Index, 2014-16=100)", 
       caption = "Source: FAO")
g.food$data %>% tail(25) %>% kbl("rst")

ggsave(filename = "food.png",
       height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")

```

```{r}
#| label: Hunger Chloropleth Map
#| output: false
#| echo: false

library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(ggrepel)

"https://www.fao.org/faostat/en/#data/FS"

# The whole world
sf::sf_use_s2(FALSE)
world <- ne_countries(scale = "medium", returnclass = "sf")

world_points<- st_centroid(world)
world_points <- cbind(world, st_coordinates(st_centroid(world$geometry)))%>%
  mutate(wb_a3=case_when(
    wb_a3=="ZAR" ~ "COD", # Map package is old. Still uses ZAR rather than COD
    TRUE ~ wb_a3)
  )
path<-"c://projects/AprREO25/"
raw<-read_csv(paste0(path,"FAOSTAT_data_en_1-15-2025.csv"))

raw$Area %>% unique()
breaks<-c(0,10,20,30, 40, Inf)
data<-raw %>% 
  janitor::clean_names()%>% 
  select(4,7,8, 10, 12)%>% 
  filter(item_code=="210401")%>%
  mutate(iso3c=countrycode(area, "country.name", "iso3c")) %>% 
  filter(iso3c%in%ssa.list)%>% 
  group_by(iso3c, value) %>% 
  slice(n()) %>% 
  select(iso3c, value) %>% 
  mutate(value=as.numeric(value)) %>% 
  rename(wb_a3=iso3c, hunger=value) %>% 
  mutate(hunger=cut(hunger, breaks=breaks))


# Select only African countries and merge with  data
ssa<-world_points%>%
  filter(wb_a3%in%c(ssa.list, NAFRlist)|su_a3%in%c("SAH", "SOL"))%>%
  left_join(data, by="wb_a3")%>%
  filter(!is.na(wb_a3)|su_a3%in%c("SAH", "SOL")) %>%
  mutate(naf=(wb_a3%in%NAFRlist|su_a3%in%c("SAH", "SOL")))  


# Chart Stuff


g.hunger<-ggplot(data = ssa ) +
  geom_sf(color = "grey80", fill="grey80", alpha=1, data=. %>% filter(naf==T))+
  geom_sf(color = ssagrey2, aes(fill=hunger), alpha=1, data=. %>% filter(naf==F))+
  scale_fill_manual(values=c(ssapeach1, ssapeach2, ssapeach3, ssapeach4, ssapeach5), na.value = ssagrey2, drop=F,na.translate=T,
                    labels=c("Less\nthan 10", "10-20", "20-30", "30-40", "40+", "No\nData"))+
  theme(axis.text.x = element_blank(),
        axis.text.y=element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        # legend.text = element_blank(),
        legend.text = element_text(size=12/.pt),
        legend.title = element_blank(),
        legend.position = c(.25,.4),
        legend.key.size = unit(.3, 'cm'),
        # legend.position = "none",
        legend.background = element_rect(fill="transparent", color="transparent"),
        legend.box.background = element_rect(fill="transparent", color="transparent"))+
  labs(title = "Prevalance of Severe Food insecurity.",
       subtitle = "(2021-23 average, percent of population)",
       caption = "Source: FAO Stat")
g.hunger
ggsave(filename = "foodinsec.png",  height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")
```


```{r}
#| label: Interrupted Recovery
#| output: false
#| echo: false

gdp.now<-idata.basic("NGDP_RPCH", "G603", "IMF.RES.WEO:WEO_LIVE", "2019","2025","A") %>%
  mutate(vintage="baseline") %>% 
  mutate(year=year(date)) %>%
  select(year,ngdp_rpch, vintage) %>% 
  rename(g=2)



gdp.then<-idata.basic("NGDP_RPCH", "G603", "IMF.RES.WEO:WEO_LIVE_2021_OCT_VINTAGE", "2019","2025","A") %>%
  mutate(vintage="old") %>% 
  mutate(year=year(date)) %>%
  select(year,ngdp_rpch, vintage) %>% 
  rename(g=2)

plot.data<-gdp.now %>% 
  rbind(gdp.then) %>% 
  filter(year%in%c(2022:2025))

g.interupt<-ggplot(plot.data)+
  geom_line(aes(year,g, col=vintage, lty=vintage), size=1.5)+
  geom_point(aes(year,g, col=vintage), size=6)+
  scale_color_manual(values=c(ssapeach4, ssagrey2), guide="none")+
  coord_cartesian(ylim=c(3.2,4.5), xlim=c(2021.75, 2025.25))+
  # scale_y_continuous(breaks=c(3.5,5))+
  scale_x_continuous(breaks=c(2022,2023, 2024, 2025))+
  annotate("text", x=2024, y=3.5, label="Current", size=7/.pt, color=ssapeach4)+
  annotate("text", x=2024, y=4.3, label="Pre-crisis", size=7/.pt, color=ssagrey3)+
  labs(title = "Current Growth Baseline vs Pre Ukraine Crisis, 2022-25",
       subtitle = "(perecnt)",
       caption="Source: WEO Database.")+
  theme(legend.position = "none",
        legend.title = element_blank())
g.interupt 

ggsave(filename = "slide8.png",
       height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")

```



```{r}
#| label: Growth Rebound Line Chart 
#| output: false
#| echo: false

growth.now<-idata.basic(c("NGDP_RPCH", "PPPGDP"), ssa.list,"IMF.RES.WEO:WEO_LIVE", "2022", "2025", "A") |> 
  mutate(vintage="Current") |> 
  mutate(year=year(date))
growth.now.ssa<-growth.now %>% 
  # filter(iso3c!="ZAF") %>%
  na.omit() %>% 
  group_by(year) %>%
  summarize(new=weighted.mean(ngdp_rpch, pppgdp, na.rm=T)) %>% 
  mutate(region="SSA") %>% 
  ungroup()

plot.growth<-growth.now %>%
  # filter(iso3c!="ZAF") %>%
  na.omit() %>% 
  mutate(region=case_when(
    iso3c%in%oilexport~"Oil Exporters",
    iso3c%in%c("ZAF")~"South Africa",
    iso3c%in%setdiff(nonresource, "ZAF")~"Non-Resource",
    iso3c%in%otherresource~"Other Resource\nex South Africa",
    TRUE~NA_character_
  ))%>%
  group_by(region, year) %>%
  summarize(new=weighted.mean(ngdp_rpch, pppgdp, na.rm=T))%>% 
  select(region,new,year) %>% 
  rbind(growth.now.ssa) %>% 
  pivot_wider(names_from = year, values_from = new) %>% 
  mutate(region=factor(region, levels=c("SSA",
                                    "Oil Exporters",
                                    "Other Resource\nex South Africa",
                                    "South Africa",
                                    "Non-Resource")))


g.rebound<-ggplot(plot.growth)+
    geom_segment(aes(x=`2022`, xend=`2023`, y=fct_reorder(region, desc(region)), yend=region, col=region),
                 size=1.2, alpha=1, lty=1,
                 position=position_nudge(y=0.3),
                 arrow = arrow(length=unit(.05, "inches")))+
    geom_segment(aes(x=`2023`, xend=`2024`, y=region, yend=region, col=region), size=1.2, 
                 position=position_nudge(y=-0.0), arrow = arrow(length=unit(.05, "inches")))+
  geom_segment(aes(x=`2024`, xend=`2025`, y=region, yend=region, col=region), size=1.2, 
                 position=position_nudge(y=-0.3), arrow = arrow(length=unit(.05, "inches")))+
  geom_point(aes(`2023`, region, col=region), size=2, shape="|", position=position_nudge(y=0.15))+
  geom_point(aes(`2024`, region, col=region), size=2, shape="|", position=position_nudge(y=-0.15))+
  # geom_vline(xintercept=100, lty=2, col="grey30")+
  scale_color_manual(values=c(fundblue,ssagrey2,ssapeach4, ssapeach2, ssagrey4, fundblue), guide=F)+
    annotate("text", x=4.5, y=4.3, label="2022-23", size=2.5,col="grey30")+
    annotate("text", x=4.2, y=4, label="2023-24", size=2.5,col="grey30")+
    annotate("text", x=4.3, y=3.7, label="2024-25", size=2.5,col="grey30")+
  labs(title = "GDP Growth, 2022-2025.",
     subtitle = "(Percent)",
     caption="IMF World Economic Database")+
  theme(plot.title=element_text(face="bold"),
        plot.caption = element_text(size=6, color="grey30"), 
        plot.title.position = "plot")

g.rebound

ggsave(filename = "rebound.png",
       height=3, width=3, dpi=600,units="in", device="png", bg = "transparent")
plot.growth %>% kableExtra::kbl("rst", digits = 1)

```


```{r}
#| label: Two Speed Growth Line Chart
#| output: false
#| echo: false

growth.now<-idata.basic(c("NGDP_RPCH", "PPPGDP"), ssa.list,"IMF.RES.WEO:WEO_LIVE", "2005", "2028", "A") |> 
  mutate(vintage="Current") |> 
  mutate(year=year(date))

growth.now.ssa<-growth.now %>% 
  # filter(iso3c!="ZAF") %>%
  na.omit() %>% 
  group_by(year) %>%
  summarize(new=weighted.mean(ngdp_rpch, pppgdp, na.rm=T)) %>% 
  mutate(region="SSA") %>% 
  ungroup()

plot.growth<-growth.now %>%
  # filter(iso3c!="ZAF") %>%
  na.omit() %>% 
  mutate(region=case_when(
    iso3c%in%c(oilexport, otherresource)~"Resource Intensive",
    iso3c%in%nonresource~"Non-Resource",
    TRUE~NA_character_
  ))%>%
  group_by(region, year) %>%
  summarize(growth=weighted.mean(ngdp_rpch, pppgdp, na.rm=T))%>% 
  select(region,growth,year)



g.two<-ggplot(plot.growth)+
  annotate("rect", xmin=decimal_date(as.Date(Sys.Date()))-1, xmax=Inf, ymin=-Inf, ymax=Inf, fill=ssagrey2, alpha=.3)+
  geom_line(aes(year, mean(growth)), col=fundblue, lty=4, 
            data=. %>% filter(year%in%2005:2014&region=="Non-Resource"), size=.5)+
  geom_line(aes(year, mean(growth)), col=fundblue, lty=4, 
            data=. %>% filter(year%in%2015:2024&region=="Non-Resource"), size=.5)+
  geom_line(aes(year, mean(growth)), col=ssapeach4, lty=4, 
            data=. %>% filter(year%in%2005:2014&region=="Resource Intensive"), size=.5)+
  geom_line(aes(year, mean(growth)), col=ssapeach4, lty=4, 
            data=. %>% filter(year%in%2015:2024&region=="Resource Intensive"), size=.5)+
    geom_line(aes(x=year, y=growth, col=region), size=1.2)+
  scale_color_manual(values=c(fundblue,ssapeach4, ssapeach2, ssagrey4, fundblue), guide=F)+
  geom_hline(aes(yintercept=0), lty=2, col=ssagrey4)+
  annotate("text", x=2027, y=2.8, label="Resource\nIntensive", size=2.5,col=ssapeach4)+
  annotate("text", x=2027, y=6.8, label="Non\nResource", size=2.5,col=fundblue)+
  labs(title = "GDP Growth, 2005-2028.",
     subtitle = "(Percent, dashed line = weighted average)",
     caption="Source: IMF World Economic Outlook database")+
  theme(plot.title=element_text(face="bold"),
        plot.caption = element_text(size=6, color="grey30"), 
        plot.title.position = "plot")
g.two

ggsave(filename = "twospeed.png",
       height=3, width=3, dpi=600,units="in", device="png", bg = "transparent")

plot.growth %>% kableExtra::kbl("rst", digits = 1)


```


```{r}
#| label: Debt Snake Chart
#| output: false
#| echo: false
 
database<-"IMF.RES.WEO:WEO_LIVE" # CSD submitted
country.list<-ssa.list
code.list<-c("GGXWDG_GDP", "PPPGDP")
data<-idata.basic(code.list, country.list, database, "1990","2028","A") %>% 
  rename(debt=3, ppp=4) |> 
  mutate(year=year(date)) %>%
  mutate(type=case_when(
    iso3c%in%oilexport~"Oil Exporter",
    iso3c%in%otherresource~"Other Resource",
    iso3c%in%nonresource~"Non Resource",
    TRUE~NA_character_
  ))

plot.data<-data %>% 
  filter(year%in%c(2000:2028)) %>% 
  group_by(year) %>% 
  summarize(mean=weighted.mean(debt, ppp, na.rm=T),
         median=median(debt, na.rm=T),
         q25=quantile(debt,.25, na.rm=T),
         q75=quantile(debt, .75, na.rm=T))

g.debtsnake<-ggplot(plot.data)+annotate("rect", xmin=2024.2, xmax=2028, ymin=-Inf, ymax=Inf, fill=ssablue, alpha=.2)+
  geom_ribbon(aes(year, ymin=q25, ymax=q75), fill=ssagrey3, alpha=.3)+
  geom_line(aes(year, median), col=ssapeach3, size=1.5, lty=1)+
  geom_point(aes(year, median), col=ssapeach3, size=3, data=. %>% slice(n()))+
  scale_x_continuous(breaks=seq(2000,2030, 5))+
  labs(title="Public Debt, 2000-2028",
       subtitle = "(median, percent of GDP)",
       caption = "WEO database.")
g.debtsnake 

ggsave(filename = "debtsnake.png",
       height = 4, width=4, dpi=600,units="in", device="png", bg = "transparent")

```

```{r}
#| label: Interest/Revenue Snake Chart
#| output: false
#| echo: false

raw<-idata.basic(c("GGEI", "GGR","GGRG", "DS", "ENDE"), ssa.list, "IMF.RES.WEO:WEO_LIVE", "1990","2028","A") |> 
  mutate(year=year(date))


data<-raw %>% 
  mutate(int=100*ggei/ggr,
         intexg=100*ggei/(ggr-ggrg),
         dsr=100*ds/(ggr/ende),
         dsexg=100*ds/((ggr-ggrg)/ende)) %>% 
  rename(value=intexg) %>% 
  select(year, iso3c, value) %>% 
  group_by(year) %>% 
  # mutate(mean=median(value, na.rm=T),
  mutate(median=median(value, na.rm=T),
         q75=quantile(value, probs=.75, na.rm=T),
         q25=quantile(value, probs = .25, na.rm=T))

g.intsnake<-ggplot(data %>% filter(year%in%c(1990:2025)) )+
  geom_ribbon(aes(year, ymin=q25, ymax=q75), fill=ssapeach2, alpha=.3)+
  geom_line(aes(year, median, group=iso3c),  col=ssagrey3, size=2, data = . %>% slice(n()))+
    geom_point(aes(year, median, group=iso3c),  col=ssagrey3, size=3, data = . %>% ungroup()%>% slice(n()))+
  # geom_line(aes(year, value, group=country), col="grey30", alpha=.2, size=1)+
  coord_cartesian(ylim=c(0,30))+
  scale_x_continuous(breaks=c(1990, 1995, 2000,2005, 2010, 2015, 2020, 2025))+
  labs(title = "SSA. Interest Payments to Revenue, 2000-24",
                  subtitle = "(percent, excl grants, median and 25-75 percentiles)",
       caption = "Source: WEO Database")

ggsave(filename = "intsnake.png",
       height = 4, width=4, dpi=600,units="in", device="png", bg = "transparent")
g.intsnake$data %>% tail(35) %>% kbl("rst", digits =1)

```

```{r}
#| label: Save charts for page 3
#| echo: false
#| output: false
#| warning: false

save(g.food, g.hunger, g.interupt, g.rebound, g.two, g.debtsnake, g.intsnake, 
     file="gallery_page3.RData")  
     
```

# Page 4

```{r}
#| label: Interest Payment Beeswarm Plot (AMS vs SSA)
#| output: false
#| echo: false

AMlist<-c("AUS", "AUT", "BEL", "CAN", "DNK", "FIN", "FRA", "DEU", "ISL", 
          "IRL", "ITA", "JPN", "KOR", "NLD", "NZL", "NOR", "PRT", "ESP", 
          "SWE", "CHE", "GBR", "USA")
raw<-idata.basic(c("GGEI", "GGR","GGRG", "DS", "ENDE"), c(ssa.list, AMlist), "IMF.RES.WEO:WEO_LIVE", "2025","2025","A") %>%
  mutate(year=year(date))
# raw<-ecosextract(c("GGEI", "GGR","GGRG", "DS", "ENDE"), as.character(c(afr.imf, AM.imf)), "WEO_WEO_LIVE", 2023,2023,"A")

plot.data<-raw %>% 
  mutate(int=100*ggei/ggr,
         intexg=100*ggei/(ggr-ggrg),
         dsr=100*ds/(ggr/ende),
         dsexg=100*ds/((ggr-ggrg)/ende)) %>% 
  rename(value=intexg) %>% # excluding grants grants
  # rename(value=int) %>% # including grants
  select(year, iso3c, value) %>% 
  mutate(region=case_when(
    iso3c%in%ssa.list~"SSA",
    # iso3c%in%AFRlist~"SSA",
    TRUE~"AM"
  )) %>% 
  na.omit()

g.intbee<-ggplot(plot.data)+
  geom_boxplot(aes(region, value, fill=region, color=region), outlier.colour = NA, width=.5, alpha=.2, size=.5)+
  ggbeeswarm::geom_quasirandom(aes(region, value, col=region), size=2, alpha=.4, width = .2)+
  scale_color_manual(values = c(ssagrey3, ssapeach5), guide="none")+
  scale_fill_manual(values = c(ssagrey3, ssapeach5), guide="none")+
  scale_x_discrete(labels=c("Advanced\nEconomies", "Sub-Saharan\nAfrica"))+
  labs(title = "Interest Payments to Revenue, excl. grants, 2025",
                  subtitle = "(percent)",
                  caption = "Source: IMF World Economic Outlook database")
layer_data(g.intbee)[,c(1,5)] %>% kbl("rst", digits=1)
g.intbee

ggsave(filename = "intswarm.png",
       height = 4, width=4, dpi=600,units="in", device="png", bg = "transparent")

```


```{r}
#| label: Per Capita GDP Levels, SSA and AEs, weighted by PPPGDP
#| output: false
#| echo: false

gdp.now<-idata.basic(c("NGDPRPC","PPPGDP"), c(ssa.list, AMlist), "IMF.RES.WEO:WEO_LIVE", "2019","2025","A") %>%
  mutate(year=year(date)) %>%
  mutate(vintage="baseline")%>%
  group_by(iso3c) %>% 
  mutate(base=sum(ifelse(year==2019,ngdprpc,0))) %>%
  mutate(n.gdp=ngdprpc/base*100) %>%
  arrange(iso3c, year) %>%
  ungroup() %>%
  select(year, iso3c, n.gdp,pppgdp,vintage)

gdp.then<-idata.basic(c("NGDPRPC","PPPGDP"), c(ssa.list, AMlist), "IMF.RES.WEO:WEO_LIVE_2020_JAN_VINTAGE", "2019","2025","A") %>%
  mutate(year=year(date)) %>%
  mutate(vintage="Jan20")%>%
  group_by(iso3c) %>% 
  mutate(base=sum(ifelse(year==2019,ngdprpc,0))) %>%
  mutate(n.gdp=ngdprpc/base*100) %>%
  arrange(iso3c, year) %>%
  ungroup() %>%
  select(year, iso3c, n.gdp,pppgdp,vintage)

gdp.now.w<-gdp.now %>% 
  mutate(region=case_when(
    iso3c%in%AMlist~"Advanced Economies",
    iso3c%in%ssa.list~"Sub-Saharan Africa",
    TRUE~NA_character_
  )) %>% 
  group_by(year, region) %>% 
  summarize(gdppc=weighted.mean(n.gdp,pppgdp,na.rm=T), vintage="baseline")
gdp.then.w<-gdp.then %>% 
  mutate(region=case_when(
    iso3c%in%AMlist~"Advanced Economies",
    iso3c%in%ssa.list~"Sub-Saharan Africa",
    TRUE~NA_character_
  )) %>% 
  group_by(year, region) %>% 
  summarize(gdppc=weighted.mean(n.gdp,pppgdp,na.rm=T), vintage="Jan20")

plot.data<-gdp.now.w %>% 
  bind_rows(gdp.then.w) %>% 
  pivot_wider(names_from = vintage, values_from = gdppc) %>% 
  group_by(region) %>% 
  mutate(Jan20=ifelse(is.na(Jan20), lag(Jan20)*(lag(Jan20)/lag(Jan20,2)), Jan20)) |> 
  filter(year<=2024)

g.ssa<-ggplot(plot.data %>% filter(region=="Sub-Saharan Africa"))+
  geom_line(aes(year, baseline), col=ssapeach4, size=.8)+
  geom_line(aes(year, Jan20), col=ssapeach4, size=.8, linetype="dashed")+
  geom_ribbon(aes(year, ymin=baseline, ymax=Jan20), fill="firebrick", alpha=.3)+
  geom_hline(yintercept = 100, col="grey30", linetype="dashed")+
  coord_cartesian(ylim=c(95,111))+
  scale_y_continuous(breaks=c(95,100,105, 110))+
  labs(title = "Sub-Saharan Africa. Per Capita GDP, 2019-2025",
  subtitle = "(Index, 2019=100)",
  caption = "Source: IMF World Economic Outlook Database")
g.am<-ggplot(plot.data %>% filter(region=="Advanced Economies"))+
  geom_line(aes(year, baseline), col=ssagrey3, size=.8)+
  geom_line(aes(year, Jan20), col=ssagrey3, size=.8, linetype="dashed")+
  geom_ribbon(aes(year, ymin=baseline, ymax=Jan20), fill=ssagrey3, alpha=.3)+
  geom_hline(yintercept = 100, col="grey30", linetype="dashed")+
  coord_cartesian(ylim=c(95,111))+
  scale_y_continuous(breaks=c(95,100,105, 110))+
  labs(title = "Adv. Markets. Per Capita GDP, 2019-2025",
  subtitle = "(Index, 2019=100)",
  caption = "Source: IMF World Economic Outlook Database")
# # g.am+g.ssa
g.am+g.ssa+plot_layout(ncol=1, heights = c(1,1))+
  plot_annotation(title = "Per Capita GDP, 2019-2025",
  subtitle = "(Index, 2019=100)",
  caption = "Source: IMF World Economic Outlook Database")

library(ggpubr)
g.converge<-ggarrange(g.am, g.ssa,
          ncol=1, nrow=2,
          labels = NULL,
          common.legend = TRUE, legend="bottom") %>%
  annotate_figure(top = text_grob("Per Capita GDP, 2019-2025", face = "bold", size = 9, hjust=1.3),
                  bottom = text_grob("Source: IMF World Economic Outlook Database", size = 6, hjust=1.2),
                  left = text_grob("(Index, 2019=100)", rot = 90, size = 6))
g.converge

ggsave(filename = "converge.png",
       height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")

plot.data %>% 
  group_by(region) %>% 
  mutate(g=100*baseline/lag(baseline)-100) %>% 
  kableExtra::kbl("rst", digits=1)

```


```{r}
#| label: Population Chart 
#| output: false
#| echo: false

NAFRlist<-c("DZA", "DJI", "EGY", "LBY", "MRT", "MAR", "SOM", "SDN", "TUN")

raw.p<-read_csv("C:\\Users\\atiffin\\OneDrive - International Monetary Fund (PRD)\\September 2025 Transfer\\Projects\\AprREO23\\population-past-future.csv")%>% 
  rename(country=1, iso3c=2, year=3, pop=4, proj=5) %>% 
  mutate(pop=ifelse(!is.na(pop), pop, proj))%>% 
  filter(year>=1800) %>% 
  mutate(region=case_when(
    iso3c%in%ssa.list~"Sub-Saharan Africa",
    iso3c%in%c(NAFRlist)~"N.Africa",
    iso3c=="CHN"~"China",
    iso3c=="IND"~"India",
    TRUE~NA_character_
  )) %>% 
  filter(!is.na(region)) %>% 
  group_by(year, region)%>% 
  summarize(pop=sum(pop))%>% 
  pivot_wider(names_from = region, values_from = pop) %>% 
  mutate(Africa=`N.Africa`+`Sub-Saharan Africa`)%>% 
  pivot_longer(2:6, names_to = "region", values_to = "pop")

raw.p %>% group_by(region) %>% slice(n())

g.pop<-ggplot(raw.p %>% filter(region!="N.Africa"))+
  geom_ribbon(aes(year, ymin=-0.3,ymax=pop/1000000000,
                  fill=region,col=region,group=region,
                  size=region, linetype=region, alpha=region),
              data = . %>% filter(region!="Sub-Saharan Africa"))+
  geom_vline(xintercept = 2025, linetype=2, col="grey30")+ 
  geom_line(aes(year, pop/1000000000),
            col=ssapeach5, linetype=2, size=.8,
            data=. %>% filter(region=="Sub-Saharan Africa"))+
  coord_cartesian(ylim=c(0,4.5), xlim=c(1800, 2110))+
  scale_fill_manual(values=c(ssapeach5, fundblue, ssapeach2))+
  scale_alpha_manual(values=c(.15,.3,.3))+
  scale_color_manual(values=c(ssapeach5, fundblue, ssapeach2))+
  scale_size_manual(values=c(1, 1, 1))+
  scale_linetype_manual(values=c(1,1,1))+
  theme(legend.title = element_blank(),
        legend.position = c(.2,.8), legend.key.size = unit(.4,"cm"))+
          labs(title = "Population, Selected Regions, 1800-2100",
           subtitle = "(Billions)",
           caption = "Source: UN World Population Prospects 2022 Revision")
g.pop

ggsave(filename = "pop.png",  height = 3, width=3, dpi=1000,units="in", device="png", bg = "transparent")

```

```{r}
#| label: Working Age Population Chart
#| output: false
#| echo: false
 
estimates<-read_excel("C:\\Users\\atiffin\\OneDrive - International Monetary Fund (PRD)\\September 2025 Transfer\\projects\\Apr24REO\\WPP2022_POP_F01_1_POPULATION_SINGLE_AGE_BOTH_SEXES.xlsx", sheet = "Estimates", range="A17:DH20620") %>%
  janitor::clean_names()
Medium<-read_excel("C:\\Users\\atiffin\\OneDrive - International Monetary Fund (PRD)\\September 2025 Transfer\\projects\\Apr24REO\\WPP2022_POP_F01_1_POPULATION_SINGLE_AGE_BOTH_SEXES.xlsx", sheet = "Medium variant", range="A17:DH22620")%>%
  janitor::clean_names()

un.locations<-estimates %>%
  select(region_subregion_country_or_area, location_code, iso3_alpha_code) %>%
  unique() %>% rename(country=1, unpd=2)

un.locations %>%
  filter(country%in%c("WORLD", "Sub-Saharan Africa", "AFRICA"))
ssa.un<-countrycode(ssa.list, "iso3c", "unpd")

data.est<-estimates %>% 
   # filter(location_code%in%c(900, 1834))%>% #SSA
   filter(location_code%in%c(900, 903))%>%  #All Africa
  select(region_subregion_country_or_area, location_code,
         iso3_alpha_code,year,x15:x64) %>% 
  pivot_longer(-c(1:4), names_to = "age", values_to = "value") %>% 
  mutate(age=as.numeric(age), value=as.numeric(value)) %>% 
  group_by(location_code, year) %>% 
  summarize(work=sum(value)) %>% 
  mutate(work=work)


data.med<-Medium %>% 
   # filter(location_code%in%c(900, 1834))%>% #SSA
   filter(location_code%in%c(900, 903))%>% # all africa
  select(region_subregion_country_or_area, location_code,
         iso3_alpha_code,year,x15:x64) %>% 
  pivot_longer(-c(1:4), names_to = "age", values_to = "value") %>% 
  mutate(age=as.numeric(age), value=as.numeric(value)) %>% 
  group_by(location_code, year) %>% 
  summarize(work=sum(value)) %>% 
  mutate(work=work)

plot.data<-data.est %>% 
  rbind(data.med)%>% 
  pivot_wider(names_from=location_code, values_from = work) %>% 
  janitor::clean_names()%>% 
  rename(world=x900, africa=x903) %>%
  # rename(world=x900, africa=x1834) %>%
  mutate(row=world-africa) %>% 
  pivot_longer(2:4, names_to = "region", values_to = "pop") %>% 
  group_by(region) %>%
  # group_by(iso3c) %>% 
  mutate(change=(pop-lag(pop))/1000) %>%
  ungroup() %>% 
  arrange(region, year) %>% 
  filter(region!="world")





fill.data.afr<-predict(loess(change~year,
                         data = plot.data %>% filter(region=="africa"), span=.4)) %>% 
  data.frame() %>% 
  mutate(year=seq(1951,2100,by=1)) %>% 
  rename(pred=1)
fill.data.row<-predict(loess(change~year,
                         data = plot.data %>% filter(region=="row"), span=.4))%>% 
  data.frame() %>% 
  mutate(year=seq(1951,2100, by=1)) %>% 
  rename(pred=1)

plot.data %>% select(year, change, region) %>% pivot_wider(names_from = region, values_from = change) %>% 
  filter(abs(`africa`-`row`)<10) %>% kbl("rst", digits=1)

plot.data %>% filter(year%in%c(2023:2028)) %>% 
  group_by(region) %>% 
  summarize(change=mean(change))

plot.data %>% filter(year%in%c(2014:2019)) %>% 
  group_by(region) %>% 
  summarize(change=mean(change))

g.work<-ggplot(plot.data)+
  geom_smooth(aes(year, change, col=region), se=F, span=.4, size=1)+
  # geom_line(aes(year, mean(change), col=region), size=1, data=. %>% filter(year%in%c(2025:2029)& region=="africa"))+
  # geom_line(aes(year, mean(change), col=region), size=1, data=. %>% filter(year%in%c(2025:2029)& region=="row"))+
  # geom_line(aes(year, mean(change), col=region), size=1, data=. %>%
  # filter(year%in%c(2030:2034)& region=="africa"))+
  # geom_line(aes(year, mean(change), col=region), size=1, data=. %>% filter(year%in%c(2030:2034)& region=="row"))+
  geom_ribbon(aes(year, ymin=0, ymax=pred), fill=ssapeach4, alpha=.2, data=fill.data.afr)+
  geom_ribbon(aes(year, ymin=0, ymax=pred), fill=fundblue, alpha=.2, data=fill.data.row)+
  geom_hline(aes(yintercept=0), lty=2, col=ssagrey4)+
  # geom_vline(aes(xintercept=2027.5), lty=2, col=ssagrey3)+
  scale_color_manual(values=c(ssapeach5, fundblue), guide="none")

(g.work.ann<-g.work+coord_cartesian(xlim=c(1950,2150))+
    scale_x_continuous(breaks=c(1950, 2000, 2050, 2100))+
  annotate("text", x=2028, y=50, label="Within 5 years\nhalf of global\nadditions\nwill be from SSA", hjust=0, size=2.5, col="firebrick4", fontface="bold")+
  annotate("text", x=2105, y=10, label="Expanding\nworking age\npopulation", hjust=0, size=2.5, col=ssagrey3)+
  annotate("text", x=2105, y=-10, label="Shrinking\nworking age\npopulation", hjust=0, size=2.5, col=ssagrey3)+
  annotate("text", x=1995, y=30, label="Rest of\nWorld", hjust=0.5, size=2.8, col=fundblue, size=2.5, fontface="bold")+
  # annotate("text", x=2053, y=15, label="Sub-\nSaharan\nAfrica", hjust=0.5, size=2.8, col=ssapeach5, size=2.5, fontface="bold")+
  annotate("text", x=2053, y=15, label="Africa", hjust=0.5, size=2.8, col=ssapeach5, size=2.5, fontface="bold")+
    annotate("segment", x=2026, xend=2026, y=24, yend = 38, col="firebrick4", size=.5) +
    labs(title = str_wrap("Figure 1. Annual Additions to Global Working Age Population, 1950-2100",50),
         subtitle = "(Millions of people per year, ages 15 - 64)",
         caption = "Source: UN World Population Projections and IMF staff calculations")
  )



ggsave(filename = "workage.png",
       height = 3.5, width=3, dpi=600,units="in", device="png", bg = "transparent")

estimates<-NULL
Medium<-NULL

```

```{r}
#| label: Debt Distress Over Time 
#| output: false
#| echo: false

raw<-read_excel("//data2/AFR/DATA/AREO/Fall 2025 - REO/Data/Debt risk status.xlsx", sheet="Debt risk ratings", range="d48:w52") %>% 
  rename(category=1)%>% 
  pivot_longer(2:20,names_to = "year", values_to = "value") %>% 
  filter(year%in%c("2015", "2020", "2025")) %>%
 mutate(category=factor(category, levels = c("Low", "Moderate", "High", "Distress"))) %>% 
  mutate(bar_label=ifelse(value==0, "", as.character(value)))

dsa.list<-read_excel("//data2/AFR/DATA/AREO/Fall 2025 - REO/Data/Debt risk status.xlsx", sheet="Debt risk ratings", range="A2:b38") %>%na.omit() %>%  
  pull(1)
setdiff(ssa.list, dsa.list)

g.distress<-ggplot(raw) +
  ggalluvial::geom_alluvium(
    aes(
      year,
      value,
      fill = fct_reorder(category,-as.numeric(category)),
      alluvium = fct_reorder(category,-as.numeric(category))
    ),
    # curve_type = "linear",
    width = .6,
    alpha = .2
  ) +
  geom_col(aes(year, value, fill = fct_reorder(category,-as.numeric(category))), width =
             .6) +
  scale_fill_manual(values = c(ssapeach4, ssapeach2, ssagrey1, ssablue),
                    guide = F) +
  theme(
    # axis.text.x=element_blank(),
    axis.text.y = element_blank(),
    axis.line = element_blank(),
    axis.ticks = element_blank()
  )+
 geom_text(aes(year, value, label=bar_label), size=6/.pt,
           position = position_stack(vjust = .5),
           fontface="bold", color=ssagrey4)+
  labs(title = "SSA. Risk of Debt Distress, 2015-25",
       subtitle = "(No. of countries)",
       caption = str_wrap("Source: IMF, Debt Sustainability Analysis Low-Income Developing Countries database.", 75))+
  annotate("text", x=.5, y=4, label="Low", size=7/.pt, fontface="bold", color=ssablue)+
  annotate("text", x=3.5, y=8, label="Medium", size=7/.pt, fontface="bold", color=ssagrey2, hjust=0)+
  annotate("text", x=3.5, y=21, label="High", size=7/.pt, fontface="bold", color=ssapeach2, hjust=0)+
  annotate("text", x=3.5, y=31, label="Distress", size=7/.pt, fontface="bold", color=ssapeach4, hjust=0)+
  coord_cartesian(xlim = c(0.5,3.5))
g.distress

ggsave(filename = "slide13.png",
       height = 4, width=4, dpi=600,units="in", device="png", bg = "transparent")

g.time$data %>% pivot_wider(names_from = year, values_from = value)



```




```{r}
#| label: Adjustment Needs Chart
#| output: false
#| echo: false

debt.raw<-idata.basic(c("GGXWDG", "GGXCNL", "PPPGDP", "NGDP_FY", "GGEI", "GGX", "GGR"),
                      ssa.list, "IMF.RES.WEO:WEO_LIVE", "2010","2029","A") %>% 
  rename(ngdp=ngdp_fy) |> 
  mutate(year=year(date))

# Calculations ------------------------------------------------------------
# ######################################################################## 
debt.target <- 70
lambda.window <-4
pb.window <- 6
sfa<-1.5
ref.year<-2024
# ########################################################################

data.basic<-debt.raw%>% 
  group_by(iso3c) %>% 
  mutate(g=ngdp/lag(ngdp)-1,
         i=ggei/lag(ggxwdg),
         pb=(ggr-ggx+ggei)/ngdp,
         debtgdp=ggxwdg/ngdp*100,
         ppp=pppgdp)

data.lambda<-data.basic%>% 
  mutate(itemp=zoo::rollapply(i,lambda.window, mean, fill=NA, align="right")) %>% 
  mutate(gtemp=zoo::rollapply(g,lambda.window, mean, fill=NA, align="right")) %>% 
  mutate(lambda=((itemp-gtemp)/(1+gtemp))) %>%
  slice(n()) %>% 
  select(iso3c,lambda)
data.pb <- data.basic %>%
  mutate(pb.bench=zoo::rollapply(pb,pb.window, mean, fill=NA, align="right")*100) %>% 
    select(iso3c,year, pb, pb.bench)

data<-data.basic %>% 
  left_join(data.lambda) %>% 
  left_join(data.pb) %>% 
  mutate(dspb=lambda*lag(debtgdp)) %>%
  mutate(targetpb=(lambda/((1+lambda)^6-1))*(lag(debtgdp)*(1+lambda)^6-debt.target)) %>% 
  mutate(pb.dich=ifelse(lag(debtgdp)<debt.target, dspb, targetpb)) %>%
  mutate(gap=pb.dich-pb.bench+sfa)%>% 
  mutate(l.debtgdp=lag(debtgdp),debt.t=debt.target, pb=pb*100)%>% 
  filter(year==ref.year)%>% 
  ungroup() %>% 
  select(iso3c, pb, pb.bench, l.debtgdp, dspb,lambda, debt.t, targetpb, gap, ppp) %>% 
  mutate(segcol=gap>=0)
data %>% arrange(iso3c) %>% select(-ppp) %>% kbl("rst", digits=3)

# Chart -------------------------------------------------------------------
bw=1.2
g.adj<-ggplot(data %>% filter(iso3c!="ZWE"), aes(x = gap, fill = segcol, col=segcol)) +
  geom_dotplot(stackgroups = T, binwidth = bw, method="histodot", origin=0)+
  scale_x_continuous(breaks=c(-5,0,5,10,15))+
  scale_y_continuous(NULL, breaks = NULL)+theme(axis.line.y = element_blank())+
  # annotate("text", x=5, y=.7, label="Adjustment\nNeeds", col=ssapeach3, size=2.5, hjust=0)+
  # annotate("text", x=-3, y=.7, label="Fiscal\nSpace", col=ssagrey4, size=2.5, hjust=1)+
  scale_fill_manual(values=c(ssagrey4, ssapeach3, "grey40"), guide="none")+
scale_color_manual(values=c(ssagrey4,ssapeach3, "grey40"), guide="none")+coord_fixed(ratio=13)+
  labs(title="Fiscal Adjustment Needed to Stabilize\nDebt Below 70% of GDP",
                  subtitle = paste0("(percent of GDP, no. of countries)"),
                  caption="Source: National authorities, and IMF staff calculations\nNote: 70-percent threshold represents top one-third of countries. For\n          countries below this threshold, adjustment stabilizes debt at\n          end-2024 level. For those above, adjustment brings debt to 70\n          percent over the forecast horizon. ")
g.adj

ggsave(filename = "adjneeds.png",
       height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")


```



```{r}
#| label: DRM Chart 
#| output: false
#| echo: false

fuellist<-weo.codes %>%
  filter(emerging_market_and_developing_economies_by_source_of_export_earnings_fuel==1)%>%
  pull(iso_3_code)
EMDElist<-weo.codes |> 
  filter(emerging_and_developing_economies==1) |> 
  pull(iso_3_code)
EMDExlist<-setdiff(EMDElist, ssa.list)
AMlist<-weo.codes %>%
  filter(advanced_economies==1)%>%
  pull(iso_3_code)
world.list<-weo.codes |> pull(iso_3_code)

raw<-idata.basic("GGRT_GDP",world.list, "IMF.RES.WEO:WEO_LIVE", "2021", "2025", "A") |> 
  mutate(year=year(date))

data.ictd<-raw%>% 
  rename(year=4, iso3c=2, tax=3) %>% 
  group_by(iso3c) %>% 
  fill(tax) %>% 
  slice(n()) %>% # 2025 or latest available
  na.omit() %>% 
  mutate(region=case_when(iso3c%in%AMlist~"AMs",
                          iso3c%in%EMDExlist~"Non-SSA EMDEs",
                          iso3c%in%ssa.list~"SSA",
                          TRUE~NA_character_)) %>% 
  filter(!is.na(region)) %>% 
  mutate(nrtax=100*tax) %>% 
  mutate(fuel=ifelse(iso3c%in%fuellist, "Fuel EXporter", "Non-Fuel Exporter")) %>% 
  select(iso3c, tax, region, fuel ) 
g.ictd<-ggplot(data.ictd)+
  geom_boxplot(aes(region, tax, fill=region), alpha=.2, outlier.colour = "transparent")+
  ggbeeswarm::geom_quasirandom(aes(region, tax, col=region, shape=fuel, size=fuel), width=.25, alpha=.7)+slidetheme+
  scale_fill_manual(values = c(fundblue, ssapeach3, ssapeach5), guide=F)+
  scale_color_manual(values = c(fundblue, ssapeach3, ssapeach5), guide=F)+
  scale_shape_manual(values=c(20,1), guide=F)+
  scale_size_manual(values=c(5,2), guide=F)+
  coord_cartesian(ylim = c(0,40))+
  theme(plot.title.position = "plot",
        plot.caption.position = "plot")+
          labs(title = "Tax Revenue, Select Countries",
                       subtitle = "(Percent of GDP. Filled points = Fuel Exporters)", 
                       caption = "Sources: IMF World Economic Outlook database and IMF Staff calculations.")
g.ictd


ggsave(filename = "DRM.png",
       height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")

```

```{r}
#| label: Save charts for page 4
#| echo: false
#| output: false
#| warning: false

save(g.intbee, g.converge, g.pop, g.work.ann, g.distress, g.adj, g.ictd, g.ssa, g.am,
     file="gallery_page4.RData")  
     
```

# Page 5

```{r}
#| label: Inflation Tetris Chart
#| output: false
#| echo: false

peg<-c("BEN", "GAB", "BFA", "GNB","CPV", "LSO", "CMR","MLI", "CAF", "NAM",
       "TCD", "NER", "COM", "STP","COG","SEN", "CIV", "SWZ", "GNQ", "TGO",
       "ERI")
notpeg<-setdiff(ssa.list, peg)

data<-idata.basic(c("PCPI_PCH", "PPPGDP"), ssa.list, "IMF.RES.WEO:WEO_LIVE", "2024", "2024", "A") %>% 
  mutate(year=year(date)) %>%
  mutate(type=case_when(
    iso3c%in%peg~"Conventional Peg",
    iso3c%in%notpeg~"Without Conv. Peg",
    TRUE~NA_character_
  ))%>% 
  rename(value=3, w=pppgdp)%>% 
  na.omit(value) %>% 
  filter(iso3c!="ZWE")

weighted.geomean <- function(x, w, ...) exp(weighted.mean(log(x), w, ...))
afr.av<-data %>% 
  group_by(year) %>% 
  summarize(value=100*weighted.geomean(1+value/100,w, na.rm=T)-100) %>% 
  select(2) %>% unlist() %>% as.vector()
afr.av.peg<-data %>% 
  filter(type=="Conventional Peg") %>% 
  group_by(year) %>% 
  summarize(value=100*weighted.geomean(1+value/100,w, na.rm=T)-100) %>% 
  select(2) %>% unlist() %>% as.vector()
afr.av.nopeg<-data %>% 
  filter(type=="Without Conv. Peg") %>% 
  group_by(year) %>% 
  summarize(value=100*weighted.geomean(1+value/100,w, na.rm=T)-100) %>% 
  select(2) %>% unlist() %>% as.vector()

bw<-1.5 # Bandwidth set this to make the following chart look roughly OK
p.1<-ggplot(data%>%filter(year==2024), aes(x = value, fill = type)) +
  geom_dotplot(stackgroups = TRUE, binwidth = bw, method = "histodot")
p.1
# Get positions of points plotted by geom_dotplot
point.pos.1 <- layer_data(p.1)%>%
  arrange(x,stackpos)
plotdata.1<-data%>%
  filter(year==2024)%>%
  arrange(value)%>%
  cbind(point.pos.1)%>%
  arrange(type,stackpos)%>%
  mutate(fragile=iso3c%in%fragile)

# Plot Tetris 
g.infltetris<-ggplot(plotdata.1)+
  geom_vline(aes(xintercept = afr.av[1]), color="grey40", linetype="dashed", size=.5, alpha=.7)+
  geom_vline(aes(xintercept = afr.av.peg[1]), color=fundblue, linetype="dashed", size=.5, ALPHA=.7)+
  geom_vline(aes(xintercept = afr.av.nopeg[1]), color=ssapeach4, linetype="dashed", size=.5, ALPHA=.7)+
  geom_tile(aes(x,stackpos, width= bw,height=1,fill=type), color="white", alpha=.5)+
  geom_text(aes(x,stackpos,label=iso3c, color=fragile), size=4.5/.pt)+
  slidetheme+
  scale_color_manual(values=c("grey20", "firebrick"))+
  guides(color=F)+
  annotate("text", x=afr.av[1]-bw/2, y=14,
           label=paste0("Avg.\n",round(afr.av[1],1)),
           color="grey40", hjust=1, size=6/.pt)+
  annotate("text", x=afr.av.peg[1]+bw/2, y=14,
           label=paste0("Peg\n",round(afr.av.peg[1],1)),
           color=fundblue, hjust=0, size=6/.pt)+
  annotate("text", x=afr.av.nopeg[1]+bw/2, y=14,
           label=paste0("No Peg\n",round(afr.av.nopeg[1],1)),
           color=ssapeach4, hjust=0, size=6/.pt)+
  scale_fill_manual(values=c(fundblue,ssapeach4))+
  theme(legend.position = c(.85,.7),
        legend.title = element_blank(),
        axis.title = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        legend.background = element_rect(fill="transparent"),
        legend.key.size = unit(.3,"cm")
  )+
  labs(title = "Sub-Saharan Africa. Inflation 2024",
  subtitle="(percent annual avg., fragile countries in red, dashed lines = weighted averages)",
  caption="Source: IMF World Economic Outlook database.")+
  coord_cartesian(xlim = c(-2,38), ylim = c(0,14.5))
g.infltetris


ggsave(filename = "inflationtetris.png",
       height = 3, width=6, dpi=600,units="in", device="png", bg = "transparent")

plotdata.1 %>% select(iso3c, value, w) %>% filter(value>=-30) %>% arrange(value) %>% tail(5) %>%  kbl("rst", digits=1)
```


```{r}
#| label: IMF Disbursements Chart
#| output: false
#| echo: false
 
path<-"//data2/AFR/DATA/AREO/Fall 2025 - REO/Data/Disbursements since 1990.xlsx"
dis<-read_excel(path,
                sheet="Calcs", range="i10:as10", col_names = F, skip=0) %>% 
  janitor::clean_names() %>% 
  mutate(var="disbursement")
ccrt<-read_excel(path,
                sheet="Calcs", range="i21:as21", col_names = F, skip=0) %>% 
  janitor::clean_names() %>% 
  mutate(var="CCRT")
sdr<-read_excel(path,
                sheet="Calcs", range="i29:as29", col_names = F, skip=0) %>% 
  janitor::clean_names() %>% 
  mutate(var="SDR")

data<-dis %>% 
  rbind(ccrt) %>% 
  rbind(sdr) %>% 
  select(-1) %>% 
  pivot_longer(-var, names_to = "year", values_to = "value") %>% 
  group_by(var) %>% 
  mutate(year=1989+row_number()) %>% 
  pivot_wider(names_from = var, values_from = value)

plot.data<-data %>% 
  filter(year%in%c(2007:2025)) %>% 
           pivot_longer(2:4,names_to = "var", values_to = "value") %>% 
  mutate(var=factor(var, levels = c("SDR", "CCRT", "disbursement")))
g.imf<-ggplot(plot.data)+geom_bar(aes(year, value, fill=var), stat = "identity")+
  scale_fill_manual(values=c(ssagrey2, ssapeach4, ssapeach2),
                    labels=c("SDR\nAllocation", "CCRT", "Credits\nand Loans"))+
  scale_x_continuous(breaks=seq(2008,2024, 4))+
  theme(plot.caption = element_text(size=7, color="grey30"),
        axis.text=element_text(size=7),
        plot.title.position = "plot",
        plot.caption.position = "plot",
        legend.position = c(.2,.8), legend.title = element_blank(),
        legend.key.size = unit(.4, "cm"),
        # legend.text = element_text(size=7),
        # legend.text=element_blank(),
        legend.direction = "vertical")+
          labs(title = "IMF Disbursements, 2007-2025",
           subtitle = "(USD Billions)",
           caption = "Source: IMF Finance Department and IMF Staff calculations.")
           g.imf
ggsave(filename = "disburse.png",  height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")



```

```{r}
#| label: IMF Programs Map
#| warning: false
#| echo: false 

library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(ggrepel)

# The whole world
sf::sf_use_s2(FALSE)
world <- ne_countries(scale = "medium", returnclass = "sf")

world_points<- st_centroid(world)
world_points <- cbind(world, st_coordinates(st_centroid(world$geometry)))%>%
  mutate(wb_a3=case_when(
    wb_a3=="ZAR" ~ "COD", # Map package is old. Still uses ZAR rather than COD
    TRUE ~ wb_a3)
  )
path<-"\\\\data2\\AFR\\DATA\\Regional Studies\\Brief Materials\\"
raw<-read_excel(paste0(path,"IMF programs Map and table.xlsx"),
                            sheet="For Map",
                            range="A1:e46")

data<-raw %>% 
  mutate(iso3c=countrycode(Country, "country.name", "iso3c")) %>% 
  mutate(Dummy=ifelse(Dummy%in%c(1,3), 1,Dummy))%>%
  mutate(prog=factor(Dummy,labels=c("Program",
                                      "Near Program",
                                      "Surveillance"))) %>% 
  select(iso3c, prog) %>% 
  rename(wb_a3=iso3c)

# Select only African countries and merge with  data
ssa<-world_points%>%
  filter(wb_a3%in%c(ssa.list, NAFRlist)|su_a3%in%c("SAH", "SOL"))%>%
  left_join(data, by="wb_a3")%>%
  filter(!is.na(wb_a3)|su_a3%in%c("SAH", "SOL")) %>%
  mutate(naf=(wb_a3%in%NAFRlist|su_a3%in%c("SAH", "SOL")))  


# Chart Stuff


g.progmap<-ggplot(data = ssa ) +
  geom_sf(color = "grey90", fill="grey90", alpha=1, data=. %>% filter(naf==T))+
  geom_sf(color = ssagrey2, aes(fill=prog), alpha=1, data=. %>% filter(naf==F))+
  scale_fill_manual(values=c(ssapeach5,ssapeach3,ssapeach1), na.value = ssagrey1)+
  theme(axis.text.x = element_blank(),
        axis.text.y=element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        # legend.text = element_blank(),
        legend.title = element_blank(),
        legend.position = c(.2,.4),
        # legend.position = "none",
        legend.box.background = element_rect(fill="transparent", color="transparent"))+
  labs(title = "Sub-Saharan Africa. IMF Engagement, 2023")
g.progmap
ggsave(filename = "prog.png",  height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")

```
 


```{r}
#| label: Food Price Inflation Chart
#| echo: false
#| warning: false 

raw<-readxl::read_excel(path="Q:\\DATA\\AREO\\Fall 2025 - REO\\Data\\SSA_Inflation food and non.xlsx",
                    sheet="Food CPI",
                    # sheet="CPI",
                    range="B1:kw47",
                    na=c("N.A.", "n.a.", "#N/A", "na", "NA"))
data<-raw %>% 
  rename(country=2) %>% 
  filter(!is.na(country)) %>% 
  mutate(iso3c=countrycode(country, "country.name", "iso3c")) %>% 
  select(-c(Series_code, country)) %>% 
  select(iso3c, everything()) %>% 
  pivot_longer(-c(1,2), names_to = "ym", values_to = "cpi") %>% 
  mutate(date=ym(ym)+months(1)-1,
         cpi=as.numeric(cpi)) %>% 
  select(date, iso3c, cpi) %>% 
  group_by(iso3c) %>% 
  mutate(cpi=zoo::na.approx(cpi, na.rm=F)) %>% #interpolates missing values
  mutate(pch=100*cpi/lag(cpi,12)-100) %>% # not Seas.adj
  mutate(last=last(na.omit(pch))) %>% 
  ungroup() %>% 
  arrange(iso3c, date)

  
data %>% filter(iso3c=="ZWE") %>% tail()



back.gap<-3
data.med<-data %>% group_by(iso3c) %>%
  filter(date<=Sys.Date()-months(back.gap)) %>% 
  filter(date>=as.Date("2003-1-1")-1)
plot.list<-data.med%>% 
  slice(n()) %>% 
  na.omit() %>% pull(iso3c)

length(plot.list)

title.month<-data.med%>% 
  slice(n()) %>% 
  ungroup() %>% 
  mutate(last= format(max(date), "%B %Y")) %>% 
  select(last) %>% unique() %>% unlist()

plot.data<-data.med %>% 
  filter(iso3c%in%plot.list) %>% 
  group_by(date)%>% 
  summarize(med=median(pch, na.rm=T))
summary(data.med %>% filter(iso3c%in%plot.list) %>% 
  group_by(iso3c) %>% slice(n()))
plot.data %>% tail(20)
g.foodinfl<-ggplot(plot.data)+
  geom_line(aes(date,med), size=1, col=ssapeach3)+
  annotate("rect", xmin=as.Date("2007-1-1"), xmax = as.Date("2008-10-1"), ymin=-Inf, ymax=Inf, fill=ssagrey2, alpha=.2)+
  annotate("rect", xmin=as.Date("2022-2-20"), xmax = as.Date(Sys.Date()), ymin=-Inf, ymax=Inf, fill=ssagrey2, alpha=.2)+
  annotate("text", x=as.Date("2006-3-1"), y=17, col=ssagrey3, size=2.5, label="2007-08\nGlobal\nFood\nPrice\nCrisis", hjust=1)+
  annotate("text", x=as.Date("2022-1-1"), y=17, col=ssagrey3, size=2.5, label="Russian\nInvasion\nof Ukraine", hjust=1)+
  geom_point(aes(date,med), size=3, col=ssapeach3, data=. %>% slice(n()))+
  scale_x_date(breaks=seq(as.Date("2003-1-1"), Sys.Date(), by="4 years")-1,
               date_labels = "%b\n%Y")+
  theme(plot.caption = element_text(hjust = 0))+
  labs(title = "Sub-Saharan Africa. Food Price Inflation, 2002-2025",
       subtitle = "(percent y/y, median)",
       caption = "Sources: Haver, national authorities, and IMF staff calculations")
g.foodinfl
ggsave(filename = "foodcpi.png",  height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")

```


```{r}
#| label: Terms of Trade Arrow Chart
#| warning: false
#| echo: false 


tot.now<-idata.basic(c("TTT_PCH", "PPPGDP"), ssa.list,
                     "IMF.RES.WEO:WEO_LIVE", "2023", "2025", "A") %>% mutate(vintage="Current") |> 
                      mutate(year=year(date))

tot.now.ssa<-tot.now%>%
  mutate(region="SSA") 

plot.tot<-tot.now %>%
  na.omit() %>% 
  mutate(region=case_when(
    iso3c%in%oilexport~"Oil Exporters",
    iso3c%in%nonresource~"Non-Resource",
    iso3c%in%otherresource~"Other Resource",
    TRUE~NA_character_
  ))%>%
  rbind(tot.now.ssa)%>% 
  group_by(region, year) %>%
  summarize(new=weighted.mean(ttt_pch, pppgdp, na.rm=T))%>% 
  pivot_wider(names_from = year, values_from = new) %>%
  mutate(`2022`=100)%>%
  mutate(`2023`=`2022`*(1+`2023`/100))%>%
  mutate(`2024`=`2023`*(1+`2024`/100)) %>% 
  mutate(`2025`=`2024`*(1+`2025`/100))

g.tot<-ggplot(plot.tot)+
    geom_segment(aes(x=100, xend=`2023`, y=region, yend=region, col=region),
                 size=.9, alpha=.6, lty=5,
                 position=position_nudge(y=0.3),
                 arrow = arrow(length=unit(.06, "inches")))+
    geom_segment(aes(x=`2023`, xend=`2024`, y=region, yend=region, col=region), size=.9, alpha=.6, lty=5,
                 position=position_nudge(y=-0.0), arrow = arrow(length=unit(.06, "inches")))+
    geom_segment(aes(x=`2024`, xend=`2025`, y=region, yend=region, col=region), size=1, 
                 position=position_nudge(y=-0.3), arrow = arrow(length=unit(.06, "inches")))+
  geom_point(aes(`2023`, region, col=region), size=2, shape="|" ,position=position_nudge(y=0.15))+
  geom_point(aes(`2024`, region, col=region), size=2, shape="|", position=position_nudge(y=-0.15))+
  geom_vline(xintercept=100, lty=2, col="grey30")+
    scale_x_continuous(breaks = c(90,95,100,105, 110, 115))+
  scale_color_manual(values=c(fundblue, ssapeach4, ssapeach2, "grey30"), guide=F)+
    annotate("text", x=94, y=4.3, label="2023", size=2.5,col="grey50")+
    annotate("text", x=103, y=4, label="2024", size=2.5,col="grey50")+
    annotate("text", x=105, y=3.7, label="2025", size=2.5,col="grey30")+
  labs(title = "GAS. Terms of Trade, 2023-2025.",
     subtitle = "(Index, 2022=100)")+
  theme(plot.title=element_text(face="bold"),
        plot.caption = element_text(size=6, color="grey30"), 
        plot.title.position = "plot")
g.tot

ggsave(filename = "TOTgrowth.png",  height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")
```

```{r}
#| label: GDP Contributions Waterfall Chart 
#| warning: false
#| echo: false 

y1<-2024 ###set years
y2<-2025 ###Set years

data<-idata.basic("NGDP_RPCH", ssa.list, "IMF.RES.WEO:WEO_LIVE", as.character(y1-1),as.character(y2),"A") %>%
  mutate(year=year(date))%>%
  mutate(type=case_when(
    iso3c%in%oilexport~"Oil Exporter",
    iso3c%in%otherresource~"Other Resource",
    iso3c%in%nonresource~"Non Resource",
    TRUE~NA_character_
  )) %>% 
  rename(value=ngdp_rpch)

weights<-idata.basic("PPPGDP", ssa.list, "IMF.RES.WEO:WEO_LIVE", as.character(y1-1),as.character(y2),"A") %>%
  mutate(year=year(date))


ssa.av<-data %>% filter(year%in%y1:y2) %>% 
  left_join(weights) %>% 
  group_by(year) %>% 
  summarize(value=weighted.mean(value, pppgdp, na.rm=T)) %>% 
  select(value) %>% 
  unlist() %>% as.vector()
# ssa.av<-ecosextract(code.list, "603", "WEO_WEO_LIVE", 2022,2024,"A")%>%
#   select(5)%>%unlist()%>%as.vector()

data.contrib<-data %>% 
  left_join(weights) %>% 
  select(year, iso3c, value, pppgdp) %>%
  group_by(iso3c) %>% 
  mutate(change=value-lag(value)) %>% 
  group_by(year) %>% 
  filter(year!=y1-1) %>% 
  mutate(weight=pppgdp/sum(pppgdp, na.rm=T))%>% 
  mutate(contrib=weight*change)%>% 
  arrange(desc(abs(contrib)))%>% 
  mutate(total=weighted.mean(change, weight, na.rm=T),
         median=median(change, na.rm=T)) %>%
  slice(1:10)

data.contrib %>% kableExtra::kbl("rst")

ssa.av.con<-data %>% filter(year%in%c((y1-1):y2)) %>% 
  left_join(weights) %>% 
  group_by(year) %>% 
  summarize(value=weighted.mean(value, pppgdp, na.rm=T)) %>% 
  select(value) %>% 
  unlist() %>% as.vector()

plot.contrib<-function(yr){
  # yr=2023
  index=yr-(y1-1)
  plot.data.main<-data.contrib %>% 
    filter(year==yr) %>% 
    select(iso3c,year, contrib, total) %>% 
    arrange(-contrib) %>% 
    mutate(end=cumsum(contrib)) %>% 
    mutate(start=0+lag(end)) %>% 
    mutate(start=ifelse(is.na(start),0,start)) %>% 
    mutate(labcol=as.character(contrib>=0)) %>% 
    mutate(country=countrycode(iso3c, "iso3c", "country.name"))
  plot.data.other<-plot.data.main %>% 
    mutate(country="Others") %>% 
    slice(n())%>% 
    mutate(start=end,end=total, labcol="Other")
  plot.data<-plot.data.main %>% rbind(plot.data.other) %>% mutate(rr=row_number()) %>% 
    mutate(start=start+ssa.av.con[index], end=end+ssa.av.con[index]) %>% 
    mutate(end=ifelse(country=="Others",ssa.av.con[index+1], end))
  g<-ggplot(plot.data)+slidetheme+
    geom_segment(aes(x=start, xend=end, y=fct_reorder(country,-rr), yend=country, col=labcol),
                 size=1.5,arrow = arrow(length=unit(.1, "inches")))+
    geom_segment(aes(x=ssa.av.con[index], xend=ssa.av.con[index], y=0, yend=11), lty=2, col="grey30")+
    geom_segment(aes(x=ssa.av.con[index+1], xend=ssa.av.con[index+1], y=0, yend=1), lty=2, col="grey30")+
    scale_color_manual(values=c("firebrick", "grey30", ssablue), guide="none")+
    labs(title = paste0("Change in GDP Growth, ",yr-1," to ",yr,"."),
         subtitle = paste0("(Percent contributions. From ",
         sprintf("%3.1f",ssa.av.con[index]),
         " to ", sprintf("%3.1f",ssa.av.con[index+1]),")"))+
    theme(plot.title.position = "plot",
          plot.caption.position = "plot",
          plot.title=element_text(size=8, face="bold"),
        plot.subtitle=element_text(size=7),
        plot.caption = element_text(size=6, color="grey30"),
        axis.text = element_text(size=7))
  # g
  return(g)
}



g1<-plot.contrib(2024)
g2<-plot.contrib(2025)

g.contrib<-g2+labs(caption="Source: IMF World Economic Outlook database and IMF Staff calculations.")
g.contrib

ggsave(filename = "contribg.png",
       height = 3, width=6, dpi=600,units="in", device="png", bg = "transparent")

```

```{r}
#| label: Save charts for page 5
#| echo: false
#| output: false
#| warning: false

save(g.infltetris, g.imf, g.progmap, g.foodinfl, g.tot, g.contrib,afr.av,afr.av.peg, afr.av.nopeg, bw,ssa.av.con,
     file="gallery_page5.RData")  
     
```

# Page 6

```{r}
#| label: Parallel Exchange Rate Ribbon Chart 
#| warning: false
#| echo: false 

cutoff.date<-as.Date("2020-12-31")
db='IMF.CSF:BBGDL'
bbseries<-imf_datatools$idata_utilities$get_dimension_values(db,"TICKER") %>% data.frame() %>% mutate(code=rownames(.))

# bbseries<-imf_datatools$idata_utilities$get_dimensions(db)


bbseries %>% 
  filter(str_detect(code, "CURNCY"))%>%
  filter(str_detect(code, "ETB")|str_detect(Name, "NGN")) %>%
  # head() %>% 
  kableExtra::kbl("rst")

series.list<-c(
  # "USDAOA_CURNCY", # Angola
  # "USDXOF_CURNCY", # Cote DIvoire (WAEMU)
  "USDETB_CURNCY", # Ethiopia
  # "USDXAF_CURNCY", # Cameroon (CEMAC)
  # "USDGHS_CURNCY", # Ghana
  # "USDKES_CURNCY", # Kenya
  # "USDMUR_CURNCY", # Mauritius
  # "USDMZN_CURNCY", # Mozambique
  "USDNGN_CURNCY") # Nigeria
  # "RWF_BNRW_CURNCY", # Rwanda
  # "USDZAR_CURNCY", # South Africa
  # "USDTZS_CURNCY", # Tanzania
  # "USDUGX_CURNCY", # Uganda
  # "USDZMW_CURNCY", # Zambia
  # "USDBWP_CURNCY", # Botswana
  # "USDBIF_CURNCY", # Burundi
  # "USDCVE_CURNCY", # Cape Verde
  # "USDKMF_CURNCY", # Comoros
  # "USDCDF_CURNCY", # DR Congo
  # "USDERN_CURNCY", # Eritrea
  # "USDSZL_CURNCY", # Eswatini
  # "USDGMD_CURNCY", # Gambia
  # "USDGNF_CURNCY", # Guinea
  # "USDLSL_CURNCY", # Lesotho
  # "USDLRD_CURNCY", # Liberia
  # "USDMGA_CURNCY", # Madagascar
  # "USDMWK_CURNCY", # Malawi
  # "USDNAD_CURNCY", # Namibia
  # "USDSTN_CURNCY", # Sao Tome and Principe
  # "USDSCR_CURNCY", # Seychelles
  # "USDSLL_CURNCY", # Sierra Leone
  # "USDZWL_CURNCY") # Zimbabwe


raw = bbiextract(series.list, "PX_LAST", "2014-01-1", as.character(Sys.Date()), "D") 
raw %>% tail()

frame<-data.frame(date=seq(as.Date("2014-01-1"), as.Date(Sys.Date()), by="day"))


data.bbg<-frame %>% 
  left_join(raw) %>%  
  tidyr::fill(everything()) 

names(data.bbg)
names<-c("ETH", "NGA")
countrycode(names, "iso3c", "country.name")
names(data.bbg)<-c("date", names)


plot.data<-data.bbg %>% 
  pivot_longer(2:3, names_to = "iso3c", values_to = "er") %>% 
  group_by(iso3c)%>% 
  arrange(iso3c,date) %>% 
  # mutate(base=mean(ifelse(date=="2021-09-1",er,NA), na.rm=T)) %>%
  mutate(base=mean(ifelse(date==cutoff.date,er,NA), na.rm=T)) %>%
  mutate(index=base/er*100) 


paradata.eth<-read_excel("c:\\projects\\AprREO25\\ETB_official_parallel_UPDATE-MAR_13_2025.xlsx",
                         sheet="ETB_official_parallel", range="a1:d2500")%>% 
  rename(date=1, rate=4) %>% 
  select(date, rate) %>% 
   # mutate(base=mean(ifelse(date==cutoff.date,rate,NA), na.rm=T)) %>%
  # mutate(base=mean(ifelse(date=="2019-12-31",er,NA), na.rm=T)) %>%
  # mutate(para=base/rate*100) %>% 
  mutate(iso3c="ETH") %>%
  filter(!is.na(date)) %>% 
  mutate(rate=ifelse(rate==0,NA, rate)) %>%
  fill(everything()) %>%
  filter(date>=cutoff.date) %>%
  mutate(date=as.Date(date)) 
paradata.eth %>% tail(10)

paradata.nga<-read_excel("C:\\projects\\AprREO25\\NGA_ER _Parallel Market Data.xlsx",
                         sheet="Sheet1", range="a1:c1500")%>% 
  rename(date=1, rate=2)%>% 
  # select(date, rate) %>% 
  #  mutate(base=mean(ifelse(date==cutoff.date,rate,NA), na.rm=T)) %>%
  # # mutate(base=mean(ifelse(date=="2019-12-31",er,NA), na.rm=T)) %>%
  # mutate(para=base/rate*100) %>% 
  mutate(iso3c="NGA") %>%
  filter(!is.na(date)) %>% 
  fill(everything(), .direction = "up") %>%
  filter(date>=cutoff.date) %>% 
  mutate(date=as.Date(date)) 
paradata.nga %>% tail(10)

plot.parallel<-function(ctycode, low,high, title, labcol, paradata){
  # ctycode="ETH"
  # labcol=REOred
  # paradata=paradata.eth
  # low=24
  # high=110
  temp.data<-plot.data %>% 
    filter(iso3c==ctycode) %>% 
    select(date, iso3c, index, base, er) %>% 
    left_join(paradata) %>% 
    mutate(para=base/rate*100)  %>% 
    fill(everything()) |> 
    filter(date>=cutoff.date)
    g<-ggplot(temp.data)+
    geom_hline(aes(yintercept=100), lty=2, col="grey30")+
    geom_line(aes(date,index),col=labcol, size=1)+
    geom_line(aes(date,para),col=labcol, size=1, lty=2)+
    ggbraid::geom_braid(aes(date, ymin=para, ymax=index, fill=para>index), alpha=.3, na.rm=T)+ 
     geom_point(aes(date, index), size=3, col=labcol, data=. %>% slice(n()))+
      geom_text(aes(date, index, label=sprintf("%3.0f",index)), size=2.5,
                hjust=-.5,col=ssagrey4, data=. %>% slice(n()))+
     scale_x_date(breaks=seq(as.Date(cutoff.date)+1, as.Date(Sys.Date()%m+%months(2)), by="12 months")-1,
     date_labels = "%b %y")+
      scale_fill_manual(values=c(labcol, fundblue, labcol), guide="none", drop=F)+
    coord_cartesian(ylim = c(low, high), xlim = c(as.Date(cutoff.date), as.Date(Sys.Date())%m+%months(2)))+
    labs(title = title)
    return(g)
}
plot.parallel("NGA", 24,110, "Nigeria", ssablue, paradata.nga)+
  plot_annotation(title = "Exchange Rate vs USD. Selected Countries, 2021-25",
                  subtitle = paste0("(Index, ", as.character(format(as.Date(cutoff.date), "%d %b %Y")), " = 100, dashed line = parallel rate)"),
                  caption = "Source: Bloomberg")


g.eth<-plot.parallel("ETH", 20,110, "Ethiopia", ssablue, paradata.eth)+
  labs(title = "Exchange Rate vs USD. Ethiopia, 2020-25",
                  subtitle = paste0("(Index, ", as.character(format(as.Date(cutoff.date), "%d %b %Y")), " = 100, dashed line = parallel rate)"),
                  caption = "Source: Bloomberg LLC and IMF Staff calculations.")
g.eth
ggsave(filename = "er2.png",
       height = 4, width=4, dpi=600,units="in", device="png", bg = "transparent")

```


```{r}
#| label: Exchange Rate SSA Change Lollipop Chart 
#| warning: false
#| echo: false 

start="2025-4-1"
end="2024-12-31"
end=as.Date(Sys.Date())
series.list<-c(
  "USDAOA_CURNCY", # Angola
  "USDXOF_CURNCY", # Cote DIvoire (WAEMU)
  "USDETB_CURNCY", # Ethiopia
  "USDXAF_CURNCY", # Cameroon (CEMAC)
  "USDGHS_CURNCY", # Ghana
  "USDKES_CURNCY", # Kenya
  "USDMUR_CURNCY", # Mauritius
  "USDMZN_CURNCY", # Mozambique
  "USDNGN_CURNCY", # Nigeria
  "RWF_BNRW_CURNCY", # Rwanda
  "USDZAR_CURNCY", # South Africa
  "USDTZS_CURNCY", # Tanzania
  "USDUGX_CURNCY", # Uganda
  "USDZMW_CURNCY", # Zambia
  "USDBWP_CURNCY", # Botswana
  "USDBIF_CURNCY", # Burundi
  "USDCVE_CURNCY", # Cape Verde
  "USDKMF_CURNCY", # Comoros
  "USDCDF_CURNCY", # DR Congo
  "USDERN_CURNCY", # Eritrea
  "USDSZL_CURNCY", # Eswatini
  "USDGMD_CURNCY", # Gambia
  "USDGNF_CURNCY", # Guinea
  "USDLSL_CURNCY", # Lesotho
  "USDLRD_CURNCY", # Liberia
  "USDMGA_CURNCY", # Madagascar
  "USDMWK_CURNCY", # Malawi
  "USDNAD_CURNCY", # Namibia
  "USDSTN_CURNCY", # Sao Tome and Principe
  "USDSCR_CURNCY", # Seychelles
  "USDSLL_CURNCY", # Sierra Leone
  "USDZWL_CURNCY") # Zimbabwe


raw = bbiextract(series.list, "PX_LAST", "2014-01-1", as.character(Sys.Date()), "D") 
raw %>% tail()

frame<-data.frame(date=seq(as.Date("2014-01-1"), as.Date(Sys.Date()), by="day"))


data.bbg<-frame %>% 
  left_join(raw) %>%  
  tidyr::fill(everything()) 

names(data.bbg)
names<-c("RWA", "AGO", "BDI", "BWA", "COD",
         "CPV", "ERI", "ETH", "GHA", "GMB",
         "GIN", "KEN", "COM", "LBR", "LSO",
         "MDG", "MUS", "MWI", "MOZ", "NAM",
         "NGA", "SYC", "SLE", "STP", "SWZ",
         "TZA", "UGA", "GAB", "CIV", "ZAF",
         "ZMB", "ZWE" )
countrycode(names, "iso3c", "country.name")
names(data.bbg)<-c("date", names)



er.plot<-data.bbg %>% 
  filter(date>=as.Date(start)) %>% 
  filter(date!=as.Date(Sys.Date()))%>% 
  pivot_longer(-date, names_to = "iso3c", values_to = "value") %>%  
  arrange(iso3c, date) %>% 
  group_by(iso3c)%>% 
  mutate(base=sum(ifelse(date==as.Date(start),value,0)))%>% 
  mutate(change=100*base/value-100) %>% 
  # mutate(year=nth(change, -365))%>% 
  mutate(latest=last(change)) %>% 
  mutate(end=sum(ifelse(date==as.Date(end),change,0)))%>% 
  slice(n())%>% 
  mutate(country=countrycode(iso3c, "iso3c", "country.name"))%>% 
  filter(!country%in%c("Gabon"))%>%
  mutate(country=ifelse(iso3c%in%c(WAEMU, CEMAC),"WAEMU/CEMAC", country)) %>% 
  mutate(country=ifelse(country=="South Africa","South Africa", country))%>% 
  na.omit()



last.date.er<-er.plot %>% pull(date) %>% max() %>% format("%d %b %Y")

g.erseg<-ggplot(er.plot)+geom_segment(aes(x=0, xend=latest, y=fct_reorder(country, latest), yend=country, col=(iso3c%in%ssa.list)), size=1, alpha=.7)+
    # geom_point(aes(max,country), size=8, col="grey70", shape="|")+
    # geom_point(aes(min,country), size=8, col="grey70", shape="|")+
    # geom_point(aes(latest,country, col=(iso3c%in%ssa.list)), size=2)+
    geom_point(aes(latest,country,col=(iso3c%in%ssa.list)), size=4, shape="|")+
    geom_vline(aes(xintercept = 0), lty=2, col="grey30")+
  scale_color_manual(values=c(ssapeach4, fundblue), guide="none")+
    labs(title = str_wrap("Exchange Rate, Change since Liberation Day", 45),
         subtitle = paste0("(percent, as of ",last.date.er,")"),
         caption = "Source: Bloomberg")+
    theme(plot.title.position = "plot",
          plot.caption = element_text(hjust=0),
          panel.grid.major.x = element_line(color="grey90", linetype=2),
          panel.grid.major.y = element_line(color="grey90", linetype=2, size=.5))
g.erseg


ggsave(filename = "er3.png",  height = 6, width=4, dpi=600,units="in", device="png", bg = "transparent")
```


```{r}
#| label: International Markets Line Charts
#| warning: false
#| echo: false 

db='IMF.CSF:BBGDL'
bbseries<-imf_datatools$idata_utilities$get_dimension_values(db,"TICKER") %>% data.frame() %>% mutate(code=rownames(.))

bbseries %>% 
  filter(str_detect(code, "INDEX"))%>%
  filter(str_detect(code, "USG")) %>%
  # head() %>% 
  kableExtra::kbl("rst")

series.list<-c("MOVE_INDEX",
               "VIX_INDEX",
               "USGG10YR_INDEX")
raw<-bbiextract(series.list, "PX_LAST", "2015-12-31", as.character(Sys.Date()), "D")
raw %>% tail(20)
data<-raw %>% 
  rename(date=1, MOVE=2, UST=3, VIX=4) %>% 
  tidyr::fill(everything()) %>% 
  filter(date>=as.Date("2024-12-31"))%>% 
  pivot_longer(2:4,names_to = "var", values_to = "value") %>% 
  group_by(var) 
# %>% 
#   mutate(mean=ifelse(date<=as.Date("2019-12-31"), mean(value),NA))
  


g.ust<-ggplot(data %>% filter(var=="UST"))+geom_line(aes(date, value), size=1, col=ssablue)+
  geom_vline(aes(xintercept=as.Date("2025-4-2")), lty=2, size=.5, col="firebrick")+
  annotate("text", x=as.Date("2025-4-1"), y=4.7, label="Liberation\nDay", hjust=1, col="firebrick", size=7/.pt)+
  scale_x_date(breaks=seq(as.Date("2019-1-1"), as.Date(Sys.Date()), by="1 months")-1,
               date_labels = "%b %y")+
  labs(title = "US 10 year Yield (percent)")

g.vix<-ggplot(data %>% filter(var=="VIX"))+geom_line(aes(date, value), size=1, col=ssablue)+
  geom_vline(aes(xintercept=as.Date("2025-4-2")), lty=2, size=.5, col="firebrick")+
  annotate("text", x=as.Date("2025-4-1"), y=4.7, label="Liberation\nDay", hjust=1, col="firebrick", size=7/.pt)+
  scale_x_date(breaks=seq(as.Date("2019-1-1"), as.Date(Sys.Date()), by="1 months")-1,
               date_labels = "%b %y")+
  labs(title = "VIX (Index)")

g.move<-ggplot(data %>% filter(var=="MOVE"))+geom_line(aes(date, value), size=1, col="firebrick")+
  geom_vline(aes(xintercept=as.Date("2025-4-2")), lty=2, size=.5, col="firebrick")+
  annotate("text", x=as.Date("2025-4-1"), y=4.7, label="Liberation\nDay", hjust=1, col="firebrick", size=7/.pt)+
  scale_x_date(breaks=seq(as.Date("2019-1-1"), as.Date(Sys.Date()), by="1 months")-1,
               date_labels = "%b %y")+
  labs(title = "Bond Market Volatility (MOVE Index)")

g.mkt<-g.vix+labs(title = "International Markets. VIX, 2020-2025",
subtitle="Index",
caption = "Source: Bloomberg LLC and IMF Staff calculations.")
ggsave(filename = "bbg.png",  height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")


```



```{r}
#| label: Resource vs Non-resource GDP per capita Line Charts
#| warning: false
#| echo: false 

gdp.now<-idata.basic(c("NGDPRPC","PPPGDP"), c(ssa.list), "IMF.RES.WEO:WEO_LIVE", "2019","2025","A") %>%
  mutate(year=year(date)) %>%
  group_by(iso3c) %>% 
  mutate(base=sum(ifelse(year==2019,ngdprpc,0))) %>%
  mutate(n.gdp=ngdprpc/base*100) %>%
  arrange(iso3c, year) %>%
  ungroup() %>%
  select(year, iso3c, n.gdp,pppgdp)
gdp.now<-gdp.now %>% 
  filter(iso3c%in%ssa.list) %>% 
  mutate(region=case_when(
    iso3c%in%nonresource~"Non-resource Intensive",
    TRUE~"Resource Intensive"
  ))
gdp.now.w<-gdp.now %>% 
  group_by(year, region)%>% 
  summarize(gdppc=weighted.mean(n.gdp,pppgdp,na.rm=T))
plot.data<-gdp.now.w %>% 
  filter(year<=2025)

g.non<-ggplot(plot.data %>% filter(region=="Non-resource Intensive"))+
  geom_ribbon(aes(year, ymax=gdppc, ymin=100), fill=ssablue, alpha=.3)+
  geom_line(aes(year, gdppc), size=1.5, col=fundblue)+
  geom_point(aes(year, gdppc), size=5, col=fundblue, data=. %>% tail(1))+
  coord_cartesian(ylim = c(90, 120))+
  labs(title = "Non-Resource Intensive. Per Capita GDP (Index, 2019 = 100)",
       caption = "Source: IMF World Economic Outlook database and IMF Staff calculations.")
g.res<-ggplot(plot.data %>% filter(region=="Resource Intensive"))+
  geom_ribbon(aes(year, ymax=gdppc, ymin=100), fill=ssapeach3, alpha=.3)+
  geom_line(aes(year, gdppc), size=1.5, col=ssapeach3)+
  geom_point(aes(year, gdppc), size=5, col=ssapeach3, data=. %>% tail(1))+
  coord_cartesian(ylim = c(90, 120))+
  labs(title = "Resource Intensive. Per Capita GDP (Index, 2019 = 100)",
       caption = "Source: IMF World Economic Outlook database and IMF Staff calculations.")

g.non+g.res+plot_layout(ncol = 1, heights=c(1,1)) +plot_annotation(title="SSA. Per capita GDP (Index, 2019 = 100)")

ggsave(filename = "pcresource.png",  height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")


```

```{r}
#| label: Reserve Cover Chart
#| output: false
#| echo: false

res.list<-c(setdiff(ssa.list, c(WAEMU, CEMAC)), "G758","G759")
db = 'IMF.AFR:AFRREO'
# Find the right dimensions of the API key
imf_datatools$idata_utilities$get_dimensions(db)
#Find the right series
series<-imf_datatools$idata_utilities$get_dimension_values(db,"INDICATOR") %>% data.frame() %>% mutate(code=rownames(.))
series %>% filter(str_detect(str_to_lower(Name), "reserves")) %>% kbl("rst")
countries<-imf_datatools$idata_utilities$get_dimension_values(db,"COUNTRY") %>% data.frame() %>% mutate(code=rownames(.))
ssa.list<-weo.codes %>% filter(sub_sahara_africa==1) %>% pull(iso_3_code)

cover.data<-idata.basic("IAR_BP6_MI_MH", res.list, db, "2024", "2024", "A")%>% 
  mutate(year=year(date)) %>%
  mutate(iso3c=case_when(
    iso3c=="G759"~"WAEMU",
    iso3c=="G758"~"CEMAC",
    TRUE~iso3c
  )) 

plot.data<-cover.data%>% 
  rename(res=iar_bp6_mi_mh) %>% 
  select(iso3c, year, res) %>% 
  mutate(type=case_when(
    res>=5~"Comfortable",
    res>=3&res<5~"Adequate",
    res<3~"Low",
    TRUE~NA_character_
  )) %>% 
  mutate(area=iso3c%in%c("WAEMU", "CEMAC"))
  
g.cov<-ggplot(plot.data)+
  geom_hline(aes(yintercept=3), lty=2, size=1, col=ssagrey2)+
  geom_hline(aes(yintercept=5), lty=2, size=1, col=ssagrey2)+
  ggbeeswarm::geom_quasirandom(aes("SSA", res, col=type, alpha=area),
                               size=6, width=.3)+
  scale_color_manual(values=c(ssagrey3, fundblue, ssapeach5), guide="none")+
  scale_alpha_manual(values = c(.4,.9), guide="none")+
  scale_y_continuous(breaks=c(0,3,6,9))+
  labs(title = "Sub-Saharan Africa. Reserve Cover",
  subtitle="(months of imports)",
  caption="Source: IMF Internationsl Financial Statistics database")
g.cov

ggsave(filename = "cover.png",  height = 3, width=3, dpi=1000,units="in", device="png", bg = "transparent")

```

```{r}
#| label: Save charts for page 6
#| echo: false
#| output: false
#| warning: false

save(g.eth, g.erseg, g.mkt, g.non, g.res,ssa.list,g.cov,
     file="gallery_page6.RData")  
     
```

# Page 7
```{r}
#| label: FFR Projections Ridge Chart and fan chart with GAS
#| warning: false
#| echo: false 

db='IMF.RES.GAS:GAS_LIVE'
dbseries<-imf_datatools$idata_utilities$get_dimension_values(db,"INDICATOR") %>% data.frame() %>% mutate(code=rownames(.))

dbseries %>% 
  filter(str_detect(Name, "rate"))%>%
  # head() %>% 
  kableExtra::kbl("rst")
gas<-idata.basic("FIRF", "USA", "IMF.RES.GAS:GAS_LIVE", "2023","2027","Q") %>%
  mutate(date=date+months(3)-1) %>%
  mutate(year=year(date), quarter=quarter(date)) %>%
  arrange(date) |> 
  rename(gas=firf)

library(binsmooth)
target<-NULL
raw.prob<-read_excel("CMEdata.xlsx", sheet = "Probabilities")

prob.data<-raw.prob %>% 
  pivot_longer(-1, names_to = "range", values_to = "value") %>% 
  separate_wider_delim(range, "-", names=c("low", "up")) %>% 
  mutate(across(c(low,up), as.numeric)) %>% 
  mutate(mid=(low+up)/2) %>% 
  rename(meet=1) %>% 
  mutate(meet=as.Date(meet))

prob.data$meet %>% unique()
binedges <- c(unique(prob.data$up),NA)
binedges

bincount<-function(meet.date){
  # meet.date="2024-9-18"
  temp=prob.data %>% filter(meet==as.Date(meet.date)) %>% 
    mutate(value=ifelse(is.na(value),0,value)) %>% 
    select(value) %>% rbind(0) %>% mutate(value=value*1000) %>%  unlist()
  return(temp)
}
bincount("2025-12-10")


ridge.points<-function(meet.date, lower, upper, step){
  # meet.date="2023-12-13"
  binedges <- c(unique(prob.data$up),NA)
  temp=data.frame(x=seq(lower,upper,step)) %>% 
    mutate(d=splinebins(binedges, bincount(meet.date))$splinePDF(x)) %>% 
    mutate(meet=meet.date)
  return(temp)
}

meet.list<-prob.data %>%
  # filter(month(meet)%in%c(3,6,9,12)) %>% 
  select(meet) %>% mutate(meet=as.character(meet)) %>% unique() %>% unlist()

gas.data<-data.frame(date=seq(as.Date("2023-4-1"), as.Date("2027-12-31"), by="1 day")) %>% 
  left_join(gas) %>% 
  fill(everything(), .direction="up") %>% 
  filter(date%in%as.Date(meet.list)) %>% 
  mutate(meet=as.character(date)) %>% 
  select(meet, gas)


data.ridges <- purrr::map(meet.list, ridge.points, lower=200, upper=450, step=1) %>% 
  bind_rows() %>% 
  mutate(d=d*40) %>% 
  left_join(gas.data) %>% 
  mutate(date=format(as.Date(meet), "%b\n%y")) %>% 
  mutate(date=fct_reorder(date,as.Date(meet))) %>% 
  group_by(meet) %>% 
  mutate(max=max(d)) %>% 
  mutate(mode=ifelse(d==max,x,NA)) %>% 
  ungroup()
  

  

g.gas<-ggplot(data.ridges)+
  ggridges::geom_ridgeline(aes(x,fct_reorder(date,-desc(as.Date(meet))), height=d),
                           color=ssagrey2, size=.3, fill=fundblue, alpha=.4)+
  geom_point(aes(x=mode, y=date, group="1"), size=10,shape="-",fontface="bold", alpha=.8,col=fundblue, data=. %>% filter(!is.na(mode)))+
  annotate("text", x=300, y=2.5, label="current", vjust=1, hjust=0, col=ssagrey4)+
  geom_vline(aes(xintercept=382), lty=2, col=ssagrey4)+
  geom_point(aes(x=100*gas, y=date, group="1"), alpha=.8,col="firebrick", size=2,data=. %>% filter(!is.na(gas)))+
  geom_point(aes(x=382, y=0, group="1"), alpha=.8,col=ssagrey4, size=3, position = position_nudge(y=.5))+
  geom_curve(x=300, y=2.5, xend=382, yend=0.5, curvature = -.2, col=ssagrey4)+
  scale_size_manual(values=c(1.5,2.5), guide="none")+
  coord_flip()+
  theme(plot.caption = element_text(hjust=0))+
  labs(title=str_wrap("Federal Funds Rate. Market Expectations of FOMC Decisions",45),
       subtitle = '(basis points, blue = market projections, red dots = GAS assumptions)',
       caption = "Sources: CME Fedwatch Tool, IMF Global Assumptions Database")
g.gas

ggsave(filename = "FFR.png",
       height = 3, width=5, dpi=600,units="in", device="png", bg = "transparent")


# Fan chart of FFR projections taking splinebin pdfs 
library(ggfan)
library(pracma)

resample.points<-function(meet.date, reps, step){
  # meet.date="2023-12-13"
  binedges <- c(unique(prob.data$up),NA)
  sample=sb_sample(splinebins(binedges, bincount(meet.date)), n=reps)
  sample.out<-sample |> data.frame() |> rename(value=1) |> mutate(date=as.Date(meet.date))
  temp=quantile(sample, probs = seq(0,1, by=step/100)) %>% 
    as.tibble() |>
    rownames_to_column("q") |> 
  mutate(q=(step*as.numeric(q)-step)) |>
  mutate(distance=abs(q-50)) |> 
  mutate(date=as.Date(meet.date)) |> 
  group_by(date) |>
  slice(-c(1, n()))
  return(temp)
  # return(sample.out)
}
resample.points("2025-12-10", 100,1)

data.resample <- purrr::map(meet.list, resample.points, reps=2000, step=.5) %>% 
  bind_rows() |>
  select(q, date, value, distance) |>
  mutate(date=decimal_date(date)) |>
  arrange(q, date) |>
  group_by(q)
  

colors <- c(fundblue, "skyblue2", "lightblue1", "transparent")
# colors <- c(fundblue, fundmedblue, "lightblue1", "transparent")
g.fan<-ggplot(data.resample)+ geom_fan(aes(x=date, y=value))+
  scale_fill_gradientn(colors=colors)+
  annotate("text", y=420, x=2026.5, label="current", hjust=-.3, col=ssagrey4)+
  geom_hline(aes(yintercept=382), lty=2, col=ssagrey4) + 
  geom_point(aes(y=382, x=decimal_date(as.Date(Sys.Date())), group="1"), alpha=.8,col=ssagrey4, size=3, position = position_nudge(y=.5))+
  geom_curve(yend=420, x=decimal_date(as.Date(Sys.Date())), y=382, xend=2026.5, curvature = -.2, col=ssagrey4)+
  geom_point(aes(decimal_date(as.Date(meet)),gas*100 ), data=gas.data, alpha=.8, col="firebrick", size=2)+
  scale_x_continuous(breaks=seq(2025.99, 2027.99, by=.5), labels = c("Dec 25", "Jun 26", "Dec 26", "Jun 27", "Dec 27"))+
  coord_cartesian(ylim = c(200, 450))+
  theme(legend.position = c(.1,.3),
        legend.title = element_text(size=7),
        legend.key.width = unit(.2,"cm"),
        legend.key.height = unit(.3,"cm"),
        legend.text = element_text(size=7))+
  labs(fill="Prob.\nInterval")+
  labs(title = "Federal Funds Rate Projections Fan Chart",
       subtitle = '(basis points, blue = market projections, red dots = GAS assumptions)',
       caption = "Sources: CME Fedwatch Tool, IMF Global Assumptions Database")
g.fan

ggsave(filename = "FFRfan.png",
       height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")
```


```{r}
#| label: Global Inflation Comparison Line Chart
#| warning: false
#| echo: false 

AMlist<-weo.codes |> 
  filter(advanced_economies==1) %>% 
  pull(iso_3_code)
EM.list<-weo.codes |> 
  filter(emerging_market_and_middle_income_economies==1) %>% 
  pull(iso_3_code)
EMxlist<-setdiff(EM.list, ssa.list)
LIC.list<-weo.codes |> 
  filter(emerging_market_and_developing_economies_low_income_developing_countries==1)%>% 
  pull(iso_3_code)
LICxlist<-setdiff(LIC.list, ssa.list)
APDlist<-c("AUS", "BGD", "BTN", "BRN", "KHM", "CHN", "FJI", "HKG", "IND", "IDN", "JPN", "KIR", "KOR", "LAO",
             "MAC", "MYS", "MDV", "MHL", "FSM", "MNG", "MMR", "NRU", "NPL", "NZL", "PLW", "PNG", "PHL", "WSM",
             "SGP", "SLB", "LKA", "THA", "TLS", "TON", "TUV", "VUT", "VNM") # From IMF Department
WHDlist<-c("CAN", "MEX", "USA", "CRI", "DOM", "SLV", "GTM", "HND", "NIC", "PAN", "ARG", "BOL", "BRA", "CHL",
             "COL", "ECU", "PRY", "PER", "URY", "VEN", "AIA", "ATG", "ABW", "BHS", "BRB", "BLZ", "CUW", "DMA",
             "GRD", "GUY", "HTI", "JAM", "MSR", "KNA", "LCA", "SXM", "VCT", "SUR", "TTO") # From IMF Department
emx.av<-idata.basic(c("PCPIE_PCH", "PPPGDP"), setdiff(EMxlist, "CHN"), "IMF.RES.WEO:WEO_LIVE", "2019","2025", "A") %>%
  mutate(type="non-SSA EMs")
licx.av<-idata.basic(c("PCPIE_PCH", "PPPGDP"), LICxlist, "IMF.RES.WEO:WEO_LIVE", "2019","2025", "A") %>%
  mutate(type="non-SSA LICs")
ssa.av<-idata.basic(c("PCPIE_PCH", "PPPGDP"), ssa.list, "IMF.RES.WEO:WEO_LIVE", "2019","2025", "A") %>%
  mutate(type="SSA")
chn.av<-idata.basic(c("PCPIE_PCH", "PPPGDP"), c("CHN"), "IMF.RES.WEO:WEO_LIVE", "2019","2025", "A") %>%
  mutate(type="China")
am.av<-idata.basic(c("PCPIE_PCH", "PPPGDP"), AMlist, "IMF.RES.WEO:WEO_LIVE", "2019","2025", "A") %>%
  mutate(type="AMs")
apd.av<-idata.basic(c("PCPIE_PCH", "PPPGDP"), APDlist, "IMF.RES.WEO:WEO_LIVE", "2019","2025", "A") %>%
  mutate(type="Asian Countries")
whd.av<-idata.basic(c("PCPIE_PCH", "PPPGDP"), WHDlist, "IMF.RES.WEO:WEO_LIVE", "2019","2025", "A") %>%
  mutate(type="WHD Countries")

weighted.geomean <- function(x, w, ...) exp(weighted.mean(log(x), w, ...))
comp.data<-am.av %>% 
  rbind(ssa.av) %>% 
  rbind(emx.av) %>% 
  rbind(licx.av) %>%
  # rbind(whd.av) %>% 
  # rbind(chn.av) %>% 
  # filter(!iso3c%in%c("ZWE"))%>% # ZWE has huge revision
  mutate(year=year(date)) %>%
  group_by(type, year) %>% 
  summarize(pch=100*weighted.geomean(1+pcpie_pch/100,pppgdp, na.rm=T)-100,
            pch.med=median(pcpie_pch, na.rm=T)) %>%
  group_by(type) %>% 
  mutate(base=sum(ifelse(year==2019,pch,NA), na.rm=T),
         base.med=sum(ifelse(year==2019,pch.med,NA), na.rm=T)) %>% 
  mutate(diff=pch-base,
         diff.med=pch.med-base.med)

g.av<-ggplot(comp.data)+annotate("rect", xmin=decimal_date(Sys.Date())-1, xmax=Inf,ymin=-Inf, ymax=Inf, alpha=.2, fill=ssagrey3)+
  geom_hline(aes(yintercept=0), col="grey30", lty=2)+
  geom_line(aes(year, diff, col=type), size=1)+
  scale_color_manual(values=c(fundblue, ssagrey3, ssapeach1, ssapeach5))+
  geom_point(aes(year, diff, col=type), data=. %>% filter(year==2025), size=3)+
  theme(legend.position = c(.2,.8),
        legend.title = element_blank(),
        plot.title.position = "plot",
        legend.background = element_rect(fill="transparent", colour = "transparent"),
        legend.box.background  = element_rect(fill="transparent", colour = "transparent"))+
labs(title = "Global Inflation During the Crisis, Average.",
       subtitle = "(percentage point difference to pre-pandemic level)",
       caption="Source: WEO Live")+
  coord_cartesian(ylim = c(-2,9))

  coord_cartesian(ylim = c(-2,8))

g.med<-ggplot(comp.data)+annotate("rect", xmin=decimal_date(Sys.Date())-1, xmax=Inf,ymin=-Inf, ymax=Inf, alpha=.2, fill=ssagrey3)+
  geom_hline(aes(yintercept=0), col="grey30", lty=2)+
  geom_line(aes(year, diff.med, col=type), size=1)+
  scale_color_manual(values=c(fundblue, ssagrey3, ssapeach1, ssapeach5), guide="none")+
  geom_point(aes(year, diff.med, col=type), data=. %>% filter(year==2025), size=3)+
  theme(legend.position = NULL,
        legend.title = element_blank(),
        plot.title.position = "plot",
        legend.background = element_rect(fill="transparent", colour = "transparent"),
        legend.box.background  = element_rect(fill="transparent", colour = "transparent"))+
  labs(title = "Global Inflation During the Crisis, Median.",
       subtitle = "(percentage point difference to pre-pandemic level)",
       caption="Source: WEO Live")+
  coord_cartesian(ylim = c(-2,9))

g.av+g.med+
  plot_annotation(title = "Global Inflation During the Crisis",
       subtitle = "(percentage point difference to pre-pandemic level)",
       caption="Source: WEO Live")
ggsave(filename = "globalcompline.png",
       height = 3, width=6, dpi=600,units="in", device="png", bg = "transparent")

```


```{r}
#| label: Coups Bar Chart and map
#| warning: false
#| echo: false 

raw.coup<-read_excel("C:\\Users\\atiffin\\OneDrive - International Monetary Fund (PRD)\\September 2025 Transfer\\Projects\\Apr24REO\\Coup_Dataset.xls")
summary(raw.coup)

year.df<-data.frame(year=c(1960:2023))
coup.data<-raw.coup %>% 
  rename(iso3c=ISO) %>% 
  filter(iso3c%in%ssa.list) %>%
  mutate(period = cut(year, breaks = c(1950, 1960, 1970, 1980, 1990, 2000, 2010, 2020, 2030), labels = F, right=F)) %>% 
  mutate(period=factor(period, levels = 1:8,
                       labels=c("1950-\n1959",
                                "1960-\n1969",
                                "1970-\n1979",
                                "1980-\n1989",
                                "1990-\n1999",
                                "2000-\n2009",
                                "2010-\n2019",
                                "2020-\n2023"
                                )))%>% 
  select(iso3c, year, period, success_coup, unsuccess_coup) %>% 
  pivot_longer(4:5, names_to = "success",values_to = "number") %>% 
  group_by(period, success) %>% 
  summarize(number=sum(number))

coup.data.1<-raw.coup %>% 
  rename(iso3c=ISO) %>% 
  filter(iso3c%in%ssa.list) %>% 
  right_join(year.df) %>% 
  select(iso3c, year, success_coup, unsuccess_coup) %>% 
  pivot_longer(3:4, names_to = "success",values_to = "number")%>% 
  group_by(year, success)%>% 
  summarize(number=sum(number))%>%
  mutate(number=ifelse(is.na(number), 0,number)) %>% 
  mutate(period = cut(year, breaks = c(1950, 1960, 1970, 1980, 1990, 2000, 2010, 2020, 2030), labels = F, right=F)) %>% 
  mutate(period=factor(period, levels = 1:8,
                       labels=c("1950-\n1959",
                                "1960-\n1969",
                                "1970-\n1979",
                                "1980-\n1989",
                                "1990-\n1999",
                                "2000-\n2009",
                                "2010-\n2019",
                                "2020-\n2023"
                                ))) %>% 
  group_by(period, success)%>% 
  summarize(number=mean(number))


g.1<-ggplot(coup.data)+geom_bar(aes(period, number, fill=fct_reorder(success, desc(success))), stat="identity")+
  scale_fill_manual(values = c(ssapeach2, ssapeach3),labels=c("Unsuccessful", "Successful"))+
  coord_cartesian(ylim=c(0,40))+
  theme(legend.title = element_blank(),
        legend.position = c(.85,.9),
        legend.background = element_rect(fill="transparent"))+
  labs(title = "Sub-Saharan Africa. Coups, 1950-2023",
       subtitle = "(Number of Episodes)")

g.coup<-ggplot(coup.data.1)+geom_bar(aes(period, number, fill=fct_reorder(success, desc(success))), stat="identity")+
  scale_fill_manual(values = c(ssapeach2, ssapeach3),labels=c("Unsuccessful", "Successful"))+
  coord_cartesian(ylim=c(0,4))+
  theme(legend.title = element_blank(),
        legend.position = c(.85,.9),
        legend.background = element_rect(fill="transparent"))+
  labs(title = "Sub-Saharan Africa. Coups, 1950-2023",
       subtitle = "(Average Number of Episodes per Year)")

g.1+g.coup

g.coup
ggsave(filename = "coups.png",
       height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")

map.data<-raw.coup %>% 
  rename(iso3c=ISO) %>% 
  filter(iso3c%in%c(ssa.list, NAFRlist)) %>%
  filter(year%in%c(1953:2023)) %>% 
  select(iso3c, year, nbre_coup) %>%
  group_by(iso3c) %>% 
  mutate(total=sum(nbre_coup)) %>% 
  slice(n()) %>% 
  rename(wb_a3=iso3c) %>% 
  select(wb_a3, total)%>% 
  filter(total>=5)
  
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(ggrepel)



# The whole world
sf::sf_use_s2(FALSE)
world <- ne_countries(scale = "medium", returnclass = "sf")

world_points<- st_centroid(world)
world_points <- cbind(world, st_coordinates(st_centroid(world$geometry)))%>%
  mutate(wb_a3=case_when(
    wb_a3=="ZAR" ~ "COD", # Map package is old. Still uses ZAR rather than COD
    TRUE ~ wb_a3)
  )

ssa<-world_points%>%
  filter(wb_a3%in%c(ssa.list, NAFRlist)|su_a3%in%c("SAH", "SOL"))%>%
  left_join(map.data) %>% 
  filter(!is.na(wb_a3)|su_a3%in%c("SAH", "SOL")) %>%
  mutate(naf=(wb_a3%in%NAFRlist|su_a3%in%c("SAH", "SOL"))) 

map.coup<-ggplot(data = ssa ) +
  geom_sf(color = "grey90", fill="grey80", alpha=1)+
  geom_sf(color="grey90", fill=ssapeach4, data=. %>% filter(!is.na(total)))+
  theme(axis.text.x = element_blank(),
        axis.text.y=element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        # legend.text = element_blank(),
        legend.text = element_text(size=4),
        legend.title = element_blank(),
        legend.position = c(.1,.4),
        legend.key.size = unit(.5, 'cm'),
        # legend.position = "none",
        legend.background = element_rect(fill="transparent", color="transparent"),
        legend.box.background = element_rect(fill="transparent", color="transparent"),
        plot.caption = element_text(hjust=0))+
  labs(title = "Countries in Africa with the Most Coups",
       subtitle = "(More than 5 successful or attempted coups, 1950-2023)",
       caption="Source: J. Powell, Univ. Central Florida and C.Thyne, Univ. Kentucky")
map.coup
ggsave(filename = "coupmap.png",
       height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")
  
```


```{r}
#| label: Refugee Flows Map
#| warning: false
#| echo: false 

raw<-read_csv("C:\\Users\\atiffin\\OneDrive - International Monetary Fund (PRD)\\September 2025 Transfer\\Projects\\AprREO25\\drcrefugees.csv", skip=14) %>% 
  select(-2) %>% 
  janitor::clean_names() %>% 
  mutate(iso3c=countrycode(country_of_asylum, "country.name", "iso3c"))
library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(ggrepel)

refugee.data<-raw %>% 
  filter(iso3c%in%ssa.list) %>% 
  filter(year==2024) %>% 
  filter(iso3c!="COD") %>% 
  mutate(refugees=refugees_under_unhc_rs_mandate+asylum_seekers) %>% 
  select(iso3c, country_of_asylum, refugees) %>% 
  rename(country=country_of_asylum) %>% 
  # filter(refugees>=10000) %>% 
  filter(rank(desc(refugees))<=10)


dest.list<-refugee.data %>% pull(iso3c)

# The whole world
sf::sf_use_s2(FALSE)
world <- ne_countries(scale = "medium", returnclass = "sf")

world_points<- st_centroid(world)
world_points <- cbind(world, st_coordinates(st_centroid(world$geometry)))%>%
  mutate(wb_a3=case_when(
    wb_a3=="ZAR" ~ "COD", # Map package is old. Still uses ZAR rather than COD
    TRUE ~ wb_a3)
  )

origincoord<-world_points %>% data.frame() %>% 
  rename(iso3c=iso_a3) %>% 
  filter(iso3c%in%c("COD")) %>% 
  select(iso3c, X, Y) %>% 
  mutate(X=X+3, Y=Y+3) %>% 
  rename(orig.x=X, orig.y=Y)
dest.coord<-world_points %>% data.frame() %>% 
  rename(iso3c=iso_a3) %>% 
  left_join(refugee.data) %>% 
  filter(!is.na(refugees)) %>% 
  select(iso3c, X, Y, refugees) %>% 
  rename(dest.x=X, dest.y=Y)
breaks<-c(0,20,50, 100,500, Inf)  
arrow.data<-origincoord %>% 
  full_join(dest.coord) %>% 
  fill(everything()) %>% 
  na.omit() %>% 
  rename(wb_a3=iso3c) %>% 
  mutate(refugees=refugees/1000) %>% 
  mutate(flows=cut(refugees, breaks))

# Select only African countries and merge with  data
ssa<-world_points%>%
  filter(wb_a3%in%c(ssa.list, NAFRlist)|su_a3%in%c("SAH", "SOL"))%>%
  left_join(arrow.data) %>% 
  filter(!is.na(wb_a3)|su_a3%in%c("SAH", "SOL")) %>%
  mutate(naf=(wb_a3%in%NAFRlist|su_a3%in%c("SAH", "SOL")))  


# Chart Stuff

levels(arrow.data$flows)
map.drcrefugee<-ggplot(data = ssa ) +
  geom_sf(color = "grey80", fill="grey80", alpha=1)+
  geom_sf(color = ssagrey2, fill=ssagrey3, alpha=1, data=. %>%filter(wb_a3=="COD"))+
  geom_sf(color = ssagrey2, aes(fill=flows),
          show.legend=T, alpha=1, data=. %>%filter(wb_a3%in%dest.list))+
   geom_curve(aes(x=orig.x, y=orig.y, xend=dest.x, yend=dest.y,
                 size=refugees/1000), arrow = arrow(length=unit(.04, "inches"), type="open"), curvature = .2, lineend = "round", col=ssagrey4, data = arrow.data, alpha=.5) +
  scale_size(range=c(.2,1.), guide="none")+
  scale_fill_manual(values = c(ssapeach1, ssapeach2, ssapeach3, ssapeach4, ssapeach5),
                    limits=levels(arrow.data$flows), 
                    labels=c("< 20", "20-50", "50-100", "100-500", ">500"),
                    drop=FALSE)+
  theme(axis.text.x = element_blank(),
        axis.text.y=element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        # legend.text = element_blank(),
        legend.text = element_text(size=4),
        legend.title = element_blank(),
        legend.position = c(.1,.4),
        legend.key.size = unit(.5, 'cm'),
        # legend.position = "none",
        legend.background = element_rect(fill="transparent", color="transparent"),
        legend.box.background = element_rect(fill="transparent", color="transparent"),
        plot.caption = element_text(hjust=0))+
  labs(title = str_wrap("Figure 10. Top 10 Refugee and Asylum-Seeker Destinations from Dem. Rep. Congo, 2024",40),
       subtitle = "(thousands of people, stock as of Oct 2024)",
       caption=paste0("Source: UNHCR", "\n", str_wrap("Note: Internally Displaced Persons in Dem. Rep. Congo = 7 million", 75)))
map.drcrefugee
ggsave(filename = "DRC.png",
       height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")

```


```{r}
#| label: Capital Flows Chart
#| warning: false
#| echo: false 

# Capital flows -----------------------------------------------------------
# SSA Weekly bond flows ETFs and Mutual Funds
ssabond.list<-data.frame(codes=c(
        "CWBBAOC", "CWBBETC","CWBBGAC","CWBBGHC","CWBBICC",
        "CWBBKEC","CWBBMUC","CWBBMZC","CWBBNAC","CWBBNIC",
        "CWBBRWC","CWBBSFC","CWBBTZC","CWBBUGC","CWBBZAC"),
        database="EPFRBCF") %>% 
  mutate(index=paste0(codes,"@",database)) %>% 
  pull(index) %>% unlist()
raw.ssabonds<-imf_datatools$get_haver_data(ssabond.list)
raw.ssabonds[is.na(raw.ssabonds)] <- 0
data.ssabonds<-raw.ssabonds%>%
  mutate(date=as.Date(row.names(.))+6) %>%
  filter(date>=as.Date("2019-1-1"))%>% 
  select(date,(everything()))%>% 
  purrr::set_names(nm=c("date",
                        "AGO", "ETH", "GAB", "GHA", "CIV",
                        "KEN", "MUS", "MOZ", "NAM", "NGA",
                        "RWA", "ZAF", "TZA", "UGA", "ZMB"
                        )) %>% 
  pivot_longer(-date, names_to = "iso3c", values_to = "bonds")

# SSA Weekly equity flows ETFs and Mutual Funds
ssaequity.list<-data.frame(codes=c(
  "CWEBBOC","CWEBGHC","CWEBICC","CWEBKEC","CWEBMAC",
  "CWEBMUC","CWEBNIC","CWEBRWC","CWEBSFC","CWEBTZC",
  "CWEBZAC","CWEBZIC"),
  database="EPFRECF") %>% 
  mutate(index=paste0(codes,"@",database)) %>% 
  pull(index) %>% unlist()
raw.ssaequity<-imf_datatools$get_haver_data(ssaequity.list)  
raw.ssaequity[is.na(raw.ssaequity)] <- 0
data.ssaequity<-raw.ssaequity%>%
  mutate(date=as.Date(row.names(.))+6)%>%
  filter(date>=as.Date("2019-1-1")) %>% 
  select(date, everything()) %>% 
  purrr::set_names(nm=c("date",
                        "BWA", "GHA", "CIV", "KEN", "MWI",
                        "MUS", "NGA", "RWA", "ZAF","TZA",
                        "ZMB", "ZWE")) %>% 
  pivot_longer(-date, names_to = "iso3c", values_to = "equity")

data.ssatotal <-data.ssabonds %>% 
  full_join(data.ssaequity) %>% 
  arrange(iso3c, date) %>% 
  rowwise() %>% 
  mutate(total=sum(bonds,equity, na.rm=T)) %>% 
  ungroup() %>% 
  group_by(iso3c) %>% 
  mutate(month=zoo::rollapply(total,4,sum, na.rm=T, align="right", fill=NA))

data.ssareg<-data.ssatotal %>% 
  group_by(date) %>% 
  summarize(total=sum(total),
            bonds=sum(bonds, na.rm=T),
            equity=sum(equity, na.rm=T)) %>% 
  ungroup() %>% 
  mutate(month=zoo::rollapply(total,4,sum, na.rm=T, align="right", fill=NA)) %>% 
  mutate(iso3c="SSA") %>% 
  select(names(data.ssatotal)) %>% 
  filter(year(date)>=2022) %>% 
  mutate(ytd=cumsum(total))

lastobs<-data.ssareg %>% slice(n()) %>% pull(date) %>% format("%b %d")

plot.data<-data.ssareg %>% 
  select(date, bonds,equity) %>% 
  pivot_longer(-date,names_to = "type", values_to = "value")




data.ssaequity.long<-raw.ssaequity%>%
  mutate(date=as.Date(row.names(.))+6)%>%
  filter(date>=as.Date("2010-1-1")) %>% 
  select(date, everything()) %>% 
  purrr::set_names(nm=c("date",
                        "BWA", "GHA", "CIV", "KEN", "MWI",
                        "MUS", "NGA", "RWA", "ZAF","TZA",
                        "ZMB", "ZWE")) %>% 
  pivot_longer(-date, names_to = "iso3c", values_to = "equity")%>% 
  mutate(ym=ceiling_date(date, "month")-1)%>% 
  group_by(ym) %>% 
  summarize(equity=sum(equity, na.rm=T))


data.ssabonds.long<-raw.ssabonds%>%
  mutate(date=as.Date(row.names(.))+6) %>%
  filter(date>=as.Date("2010-1-1"))%>% 
  select(date,(everything()))%>% 
  purrr::set_names(nm=c("date",
                        "AGO", "ETH", "GAB", "GHA", "CIV",
                        "KEN", "MUS", "MOZ", "NAM", "NGA",
                        "RWA", "ZAF", "TZA", "UGA", "ZMB"
  )) %>% 
  pivot_longer(-date, names_to = "iso3c", values_to = "bonds") %>% 
  mutate(ym=ceiling_date(date, "month")-1) %>% 
  group_by(ym) %>% 
  summarize(bonds=sum(bonds, na.rm=T))

plot.data.long<-data.ssabonds.long %>% 
  left_join(data.ssaequity.long)%>%
  # filter(week(ym)<=week(Sys.Date())+10)%>% #takes to latest complete month
  pivot_longer(2:3, names_to = "type", values_to = "value") %>% 
 group_by(ceiling_date(ym, "year")) %>% 
  mutate(total=sum(value))%>% 
  slice(n())%>% 
  mutate(year=year(ym))
plot.data.long %>% tail()  
end.val<-plot.data.long %>% ungroup() %>% slice(n()) %>% select(total) %>% pull()

g.flow<-ggplot(plot.data.long %>% filter(year%in%2013:2025))+
  geom_bar(aes(year,total/1000, alpha=(year==2025), fill=(total>=0)),
           stat="identity", position = position_dodge(width = -.5))+
  annotate("text", x=2025, y=end.val/1000 +.5,
           label="1/",
           hjust=.5, size=3, color="grey20")+
  scale_x_continuous(breaks=c(2013, 2016, 2019, 2022, 2025))+
  scale_fill_manual(values=c(ssapeach4, fundblue), guide="none")+
  scale_alpha_manual(values=c(.5,1), guide="none")+
  theme(axis.text=element_text(size=7))+
  labs(title="Sub-Saharan Africa. Net Portfolio Fund Flows, 2013-25.",
       subtitle = "(USD billions)",
       # subtitle = paste0("(Data as of ",lastobs,", 2022)"),
       caption=paste0("Source: EPFR and IMF staff calculations", "\n", "1/ As of October 2025"))+
  theme(plot.title=element_text(size=8, face="bold"),
        plot.subtitle=element_text(size=6),
        plot.caption = element_text(size=6, color="grey30", hjust=0),
        plot.title.position = "plot",
        plot.caption.position = "plot",
        axis.text = element_text(size=7))
g.flow
ggsave(filename = "capflowREO.png",  height = 3, width=3, dpi=1000,units="in", device="png", bg = "transparent")

```

```{r}
#| label: Save charts for page 7
#| echo: false
#| output: false
#| warning: false

save(g.gas, g.fan,g.av, g.med, g.coup, g.flow, map.coup, map.drcrefugee,
     file="gallery_page7.RData")  
     
```

# Page 8

```{r}
#| label: Loosening Cycle Chart
#| warning: false
#| echo: false 

series.list<-c("FDTRMID Index", "USGG10YR Index")

raw = bbextract(series.list, "1990-01-1", Sys.Date()) 
raw %>% tail()


data<-raw %>%  
  tidyr::fill(everything()) %>% 
  rename(ten=2, ffr=3) %>% 
 mutate(month=ceiling_date(date, unit="month")-1) %>% 
  group_by(month) %>% 
  slice(n())
data %>% tail()

ggplot(data)+
  geom_line(aes(date, ten), col=ssapeach3)+
  geom_line(aes(date, ffr), col=fundblue)

series<-imf_datatools$ecos_sdmx_utilities$get_all_series("WEO_GAS_LIVE") %>% data.frame()
comm.codes=c("FIST") # For GAS

imf_datatools$ecos_sdmx_utilities$get_ecos_sdmx_metadata("WEO_GAS_LIVE", "FIRF") 
# db<-"WEO_GAS_LIVE"
db<-"WEO_WEO_LIVE"
from<-1990
to<-2028

# gas.raw<-ecosextract(comm.codes, "001", "WEO_GAS_LIVE", from, to, "Q") %>% 
#   mutate(date=date+months(2)) #quarterly projections
gas.interest<-ecosextract(c("FIGB", "FIRF"), "111", "WEO_GAS_LIVE", from, 2027, "Q") %>% 
  mutate(date=date+months(3)-1) #quarterly projections
gas.interestyr<-ecosextract(c("FIGB", "FIRF"), "111", "WEO_GAS_LIVE", 2028, 2030, "A") %>% 
  mutate(date=date+months(12)-1) #quarterly projections
data.gas<-gas.interest %>% 
  rbind(gas.interestyr) %>% 
  filter(date>=as.Date(Sys.Date())) %>% 
  select(1,5,6) %>% 
  rename(ten=2, ffr=3) 

g.loose<-ggplot(data %>% 
  filter(date>=as.Date("1999-12-31")))+
  annotate("rect",xmin = as.Date(Sys.Date()), xmax=max(data.gas$date), ymin=-Inf, ymax=Inf, fill=ssagrey1, alpha=.2 )+
  geom_line(aes(date, ten), col=ssapeach4, size=1)+
  geom_line(aes(date, ten), col=ssapeach4, data=data.gas, lty=4, size=1)+
  geom_line(aes(date, ffr), col=ssablue, size=1)+
  geom_line(aes(date, ffr), col=ssablue, data = data.gas, lty=4, size=1)+
  labs(title = "USA. Policy Rates and 10-year Yields",
       subtitle = "(percent)",
       caption="Bloomberg LLC and IMF GAS database.")+
  annotate("text", x=as.Date("2015-7-30"), y=4, label="US 10 Yr", size=2.5, col=ssapeach4)+
  annotate("text", x=as.Date("2004-7-30"), y=.4, label="Fed Funds\nRate", size=2.5, col=fundblue)
g.loose
ggsave(filename = "loosening.png",
       height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")

```


```{r}
#| label: Rebased Commodity Prices Chart with forecasts
#| warning: false
#| echo: false 

comm.codes=c("PFOODW", "POILAPSP", "PWHEAMT", "PGOLD", "PCOPP", "PFERTW", "PCOFFAVG", "PCOCO") # For GAS
hist.codes=c("POILAPSP", "PWHEAMT", "PGOLD", "PCOPP", "PCOFFAVG", "PCOCO") # For PCPS in USD
index.codes=c("PFOOD", "PFERT") # For PCPS INdexes
ssa.imf<-countrycode::countrycode(ssa.list, "iso3c", "imf")
index.raw<-commodityextract(index.codes, as.Date("2010-12-31"), as.Date("2025-6-30"), freq = "M", type="Index")
hist.raw<-commodityextract(hist.codes, as.Date("2010-12-31"), as.Date("2025-6-30"), freq = "M", type="USD")%>% 
  left_join(index.raw) %>% 
  mutate(date=date+months(1)-1)

hist.raw %>% tail(2)

db<-"WEO_GAS_LIVE"
ctry.list<-as.character(ssa.imf)
from<-2010
to<-2028

gas.raw<-ecosextract(comm.codes, "001", "WEO_GAS_LIVE", from, to, "Q") %>% 
  mutate(date=date+months(3)-1) #quarterly projections
gas.raw %>% tail()
gas.rawyr<-ecosextract(comm.codes, "001", "WEO_GAS_LIVE", 2027, to, "A") %>% 
  mutate(date=date+months(12)-1) #yearly projections for longer horizon

data.hist<-hist.raw %>% 
  rename(date=1, gold=PGOLD_US, copper=PCOPP_US, wheat=PWHEAMT_, food=PFOOD_In, oil=POILAPSP, fertilizer=PFERT_In, cocoa=PCOCO_US) %>% 
  select(date, oil, gold, copper, food, wheat, fertilizer, cocoa) %>%
  mutate(vintage="history")
final.obs=data.hist %>% 
  slice(n())
data.new<-gas.raw %>% 
  rbind(gas.rawyr)%>% 
  select(-c(2:4))%>%
  rename(date=1, coffee=2, cocoa=3, copper=4, fertilizer=5, food=6, gold=7, oil=8, wheat=9) %>% 
  select(date, oil, gold, copper, food, wheat, fertilizer, cocoa) %>% 
  filter(date>=as.Date("2025-09-1")-1) %>% 
  mutate(vintage="new") %>% 
  rbind(final.obs) %>% 
  mutate(vintage="new")
plot.data<-data.hist %>% 
  rbind(data.new)

g.food<-ggplot(plot.data %>% filter(date>=as.Date("2012-1-1")-1))+geom_line(aes(date, food, lty=vintage), col=ssapeach3)+
  scale_linetype_manual(values=c(1,2,2), guide=F)+
  scale_size_manual(values=c(1.2,1,1), guide=F)+
  labs(title = "Food Prices.",
       subtitle = "(Index, 2016=100)")+
  scale_x_date(breaks=seq(as.Date("2011-1-1"), as.Date("2029-1-1"),
                          by="5 years")-1, date_labels="%b %y")

g.copper<-ggplot(plot.data %>% filter(date>=as.Date("2012-1-1")-1))+geom_line(aes(date, copper, lty=vintage), col=ssapeach3)+
  scale_linetype_manual(values=c(1,2,2), guide=F)+
  scale_size_manual(values=c(1.2,1,1), guide=F)+
  labs(title = "Copper Prices.",
       subtitle = "(Index, 2016=100)")+
  scale_x_date(breaks=seq(as.Date("2011-1-1"), as.Date("2029-1-1"),
                          by="5 years")-1, date_labels="%b %y")
g.gold<-ggplot(plot.data %>% filter(date>=as.Date("2012-1-1")-1))+geom_line(aes(date, gold, lty=vintage), col=ssapeach3)+
  scale_linetype_manual(values=c(1,2,2), guide=F)+
  scale_size_manual(values=c(1.2,1,1), guide=F)+
  labs(title = "Gold Prices.",
       subtitle = "(Index, 2016=100)")+
  scale_x_date(breaks=seq(as.Date("2011-1-1"), as.Date("2029-1-1"),
                          by="5 years")-1, date_labels="%b %y")

g.oil<-ggplot(plot.data%>% filter(date>=as.Date("2012-1-1")-1))+geom_line(aes(date, oil, lty=vintage), col=ssagrey4)+
  scale_linetype_manual(values=c(1,2,2), guide=F)+
  scale_size_manual(values=c(1.2,1,1), guide=F)+
  labs(title = "Oil Prices.",
       subtitle = "(USD, APSP)")+
  scale_x_date(breaks=seq(as.Date("2011-1-1"), as.Date("2029-1-1"),
                          by="5 years")-1, date_labels="%b %y")

# g.coffee<-ggplot(plot.data%>% filter(date>=as.Date("2012-1-1")-1))+geom_line(aes(date, coffee, lty=vintage), col=ssagrey4)+
#   scale_linetype_manual(values=c(1,2,2), guide=F)+
#   scale_size_manual(values=c(1.2,1,1), guide=F)+
#   labs(title = "Coffee Prices.",
#        subtitle = "(USD, APSP)")+
#   scale_x_date(breaks=seq(as.Date("2011-1-1"), as.Date("2029-1-1"),
#                           by="5 years")-1, date_labels="%b %y")

g.cocoa<-ggplot(plot.data%>% filter(date>=as.Date("2012-1-1")-1))+geom_line(aes(date, cocoa, lty=vintage), col=ssagrey4)+
  scale_linetype_manual(values=c(1,2,2), guide=F)+
  scale_size_manual(values=c(1.2,1,1), guide=F)+
  labs(title = "Cocoa Prices.",
       subtitle = "(USD, APSP)")+
  scale_x_date(breaks=seq(as.Date("2011-1-1"), as.Date("2029-1-1"),
                          by="5 years")-1, date_labels="%b %y")


g.food+g.oil+g.copper+g.gold+g.cocoa+plot_layout(ncol = 2)

data.rebase<-plot.data %>% pivot_longer(-c(date, vintage), names_to = "type", values_to = "value") %>% 
  arrange(type, date) %>% 
  group_by(type) %>% 
  mutate(base=mean(ifelse(year(date)%in%2010:2019,value, NA),na.rm=T)) %>% 
  mutate(index=value/base*100) %>% 
  select(date, type, index, vintage) %>% 
  pivot_wider(names_from = type, values_from = index)

lab1<-data.rebase %>% select(copper) %>% slice(n()) %>% unlist()
lab2<-data.rebase %>% select(gold) %>% slice(n()) %>% unlist()

g.comm1<-ggplot(data.rebase)+annotate("rect", xmin=as.Date(Sys.Date()), xmax=as.Date(Sys.Date())+years(5), ymin=-Inf, ymax=Inf, fill="lightblue", alpha=.4)+
  geom_line(aes(date, gold, lty=vintage), col=ssapeach3, size=1)+
  geom_line(aes(date, copper, lty=vintage), col=ssamedblue, size=1)+
  annotate("text", x=as.Date("2027-12-31"), y=lab1, label="Copper", vjust=3,col=ssamedblue, size=2.5)+
   annotate("text", x=as.Date("2027-12-31"), y=lab2, label="Gold", vjust=3, col=ssapeach3, size=2.5)+
  scale_linetype_manual(values=c(1,2,2), guide=F)+
  labs(title = "Commodity Prices.",
       subtitle = "(Index, 2010-2019 = 100)",
       caption = str_wrap("Source: WEO Database, GAS Database, and IMF staff calculations", 78))+
  scale_x_date(breaks=seq(as.Date("2011-1-1"), as.Date("2029-1-1"),
                          by="3 years")-1, date_labels="%b\n%y")
g.comm1

lab1<-data.rebase %>% select(food) %>% slice(n()) %>% unlist()
lab2<-data.rebase %>% select(cocoa) %>% slice(n()) %>% unlist()

g.comm2<-ggplot(data.rebase)+annotate("rect", xmin=as.Date(Sys.Date()), xmax=as.Date(Sys.Date())+years(5), ymin=-Inf, ymax=Inf, fill="lightblue", alpha=.4)+
  geom_line(aes(date, food, lty=vintage), col=ssapeach5, size=1)+
  geom_line(aes(date, cocoa, lty=vintage), col=ssagrey2, size=1)+
  annotate("text", x=as.Date("2027-12-31"), y=lab1, label="Food", vjust=-3,col=ssapeach5, size=2.5)+
   annotate("text", x=as.Date("2027-12-31"), y=lab2, label="Cocoa", vjust=-2, col=ssagrey2, size=2.5)+
  scale_linetype_manual(values=c(1,2,2), guide=F)+
  labs(title = "Commodity Prices.",
       subtitle = "(Index, 2010-2019 = 100)",
       caption = str_wrap("Source: WEO Database, GAS Database, and IMF staff calculations", 78))+
  scale_x_date(breaks=seq(as.Date("2011-1-1"), as.Date("2029-1-1"),
                          by="3 years")-1, date_labels="%b\n%y")

g.comm1+g.comm2

ggsave(filename = "commgas.png",
       height = 4, width=6, dpi=600,units="in", device="png", bg = "transparent")
```


```{r}
#| label: Geopolitics Chart
#| warning: false
#| echo: false 

raw.gpr<-read_excel("c:\\\\projects\\AprREO25\\data_gpr_export.xls", guess_max = 1400) %>% 
  # mutate(date=as.Date(month)c+months(1)-1)%>% 
  mutate(date=as.Date(month)-1)%>% 
  select(date, GPR) %>% 
  na.omit()

raw.ship<-imf_datatools$get_haver_data(c("W1DCOMP@TRANSPRT","W1DSHRT@TRANSPRT","BDI@BALTIC")) %>% 
  mutate(date=as.Date(row.names(.))+months(1)-1) %>% 
  mutate(across(1:3, ~na_if(.,NaN))) %>% 
  fill(everything()) %>% 
  rename(ship=3) %>% 
  select(date, ship)


data<-raw.gpr %>% 
  left_join(raw.ship) %>% 
  pivot_longer(-date, names_to = "type", values_to = "value")%>% 
  arrange(type, date) %>% 
  group_by(type) %>% 
  mutate(base=mean(ifelse(year(date)%in%2020:2020,value, NA),na.rm=T)) %>% 
  mutate(index=value/base*100) %>% 
  select(date, type, index) %>% 
  pivot_wider(names_from = type, values_from = index) %>% 
  filter(date>=as.Date("2016-1-1")-1) %>% 
  fill(everything())
  


g.geo<-ggplot(data)+
  geom_line(aes(date, GPR), col=ssagrey4, size=1)+
  geom_point(aes(date, GPR), col=ssagrey4, size=3, data=. %>% slice(n()))+
  geom_line(aes(date, ship), col=ssablue, size=1)+
  geom_point(aes(date, ship), col=ssablue, size=3, data=. %>% slice(n()))+
  annotate("text", x=as.Date(Sys.Date()-months(8)), y=300, label="Geopolitical\nRisk", vjust=0,col=ssagrey4, size=2.5, hjust=0.5)+
   annotate("text", x=as.Date(Sys.Date()-months(24)), y=10, label="Baltic Dry Index", vjust=-0, col=ssablue, size=2.5, hjust=.5)+
  scale_linetype_manual(values=c(1,2,2), guide=F)+
  labs(title = "Geopolitical Risk and Shipping Costs.",
       subtitle = "(Index, 2022 = 100)",
       caption = paste0(str_wrap("Source: Haver, Dario and Iacoviello (2022), and IMF staff calculations.", 78),"\n", str_wrap("Note: Dario and Iacoviello (2022) data downloaded Jan 16, 2025 from https://www.matteoiacoviello.com/gpr.htm.", 78)))+
  scale_x_date(breaks=seq(as.Date("2011-1-1"), as.Date("2029-1-1"),
                          by="2 years")-1, date_labels="%b %y")
g.geo
ggsave(filename = "gpr.png",
       height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")
```

```{r}
#| label: Social Exclusion Boxplot and Scatter Charts
#| warning: false
#| echo: false 

raw<-read_excel("Q:\\DATA\\AREO\\Archives\\Fall 2024 - REO\\Data\\Exclusion index world 2023.xlsx") %>% 
  select(1:5)
world.imf<-weo.codes |> pull(code)
plot.data<-raw %>% 
  filter(iso3c%in%ssa.list) %>% 
  mutate(region=case_when(
    iso3c%in%nonresource~"Non-Resource",
    iso3c%in%oilexport~"Oil Exporter",
    iso3c%in%otherresource~"Other Resource",
    TRUE~NA_character_
  )) %>% 
  group_by(region) %>% 
  mutate(mean=mean(exclusion, na.rm=T))


g.exclbox<-ggplot(plot.data)+
  geom_boxplot(aes(exclusion, fct_reorder(region,mean), fill=region), alpha=.3, outliers=F, col=ssagrey3)+
  ggbeeswarm::geom_quasirandom(aes(exclusion, region, col=region), alpha=.5, size=3, width=.2)+
  scale_fill_manual(values = c(fundblue, ssapeach4, ssagrey3), guide="none")+
  scale_color_manual(values = c(fundblue, ssapeach4, ssagrey3), guide="none")+
  labs(title="Sub-Saharan Africa: Perceptions of Social Exclusion",
                                                       subtitle = "(Index, 0-100, higher = more exclusion)",
                                                       caption=paste0(str_wrap("Sources: .",75)))
g.exclbox

ggsave(filename = "excludea.png",
       height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")


d<-raw%>%
  rename(wb_a3=iso3c) %>% 
  select(wb_a3,exclusion) 




#######################################################################
# Build Database with map coordinates
#######################################################################
# The whole world
library(rnaturalearth)
library(rnaturalearthdata)
library(sf)
world <- ne_countries(scale = "medium", returnclass = "sf")
world_points<- st_centroid(world)
world_points <- cbind(world, st_coordinates(st_centroid(world$geometry)))%>%
  mutate(wb_a3=case_when(
    wb_a3=="ZAR" ~ "COD", # Map package is old. Still uses ZAR rather than COD
    TRUE ~ wb_a3)
  )

# Build add unsers to map database and calculate regional means
map.data<-world_points%>%
  left_join(d)%>%
  filter(!is.na(wb_a3))%>%
  filter(!region_wb=="Antarctica") %>% 
  group_by(region_wb)%>%
  mutate(mean=mean(exclusion, na.rm = T)) %>% 
  mutate(bin=cut(mean, breaks = c(0,40,50, 60, 100)))

Mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}

table<-map.data%>%
  select(region_wb,mean, bin)%>%
  summarize(mean=mean(mean, na.rm=T), bin=Mode(bin))%>%
  data.frame()%>%
   select(region_wb,mean, bin)%>%
  mutate(mean=round(mean, digits=2))
table

################################################################################################
# Build Plot
###############################################################################################

g<-ggplot(data = map.data) +
  geom_sf(color = "transparent", aes(fill = bin))+
  scale_fill_manual(values=c(ssablue, ssamedblue, ssapeach1, ssapeach3, ssapeach5), drop=F,
                    labels=c("< 40", "40 to 50", "50 to 60", "60 +"))+
  theme(axis.line.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank(),
        legend.position=c(.1,.4),
        legend.title = element_blank(),
        legend.key.size = unit(.5, "cm"),
        legend.background = element_rect(fill="transparent"))+
  labs(title="Perceptions of Social Exclusion",
                                                       subtitle = "(Index, 0-100, higher = more exclusion)",
                                                       caption=paste0(str_wrap("Sources: .",75)))
g #1000 by 500 for copy


ggsave(g, filename = "excludeb.png",  height = 3, width=6, dpi=1000,units="in", device="png", bg = "transparent")

tax.data<-ecosextract(c("GGRT_GDP"), as.character(world.imf),
                     "WEO_WEO_LIVE", 2023, 2023, "A")
plot.data<-tax.data%>% 
  left_join(raw)%>% 
  select(year, iso3c, GGRT_GDP,exclusion )
  
g.exclscatter<-ggplot(plot.data)+
  geom_smooth(aes(GGRT_GDP, exclusion), method="lm", se=F, lty=2, col=ssagrey4)+
  # geom_vline(aes(xintercept=15), lty=2, col=ssagrey4, size=.5)+
  # geom_point(aes(GGRT_GDP, exclusion, col=iso3c%in%ssa.list, size=iso3c%in%ssa.list), alpha=.6)+
  geom_text(aes(GGRT_GDP, exclusion, col=iso3c%in%ssa.list,  label=iso3c), size=6/.pt)+
  scale_color_manual(values=c(ssagrey3, ssapeach4), guide="none")+
  scale_size_manual(values=c(2,3), guide="none")+
  theme(axis.title.x = element_text(size=6))+
  xlab("\nTax Revenue (percent of GDP)")+
  labs(title="Perceptions of Social Exclusion",
                                                       subtitle = "(Index, 0-100, higher = more exclusion)",
                                                       caption=paste0(str_wrap("Sources: .",75)))
g.exclscatter

ggsave(filename = "excludec.png",  height = 3, width=3, dpi=1000,units="in", device="png", bg = "transparent")

```

```{r}
#| label: Save charts for page 8
#| echo: false
#| output: false
#| warning: false

save(g.loose, g.comm1, g.comm2, g.geo, g.exclbox, g.exclscatter,
     file="gallery_page8.RData")  
     
```


# Page 9

```{r}
#| label: Commodity Prices Charts
#| warning: false
#| echo: false 

# Commodity prices --------------------------------------------------------
comm.list<-c("GC1 Comdty",
             # "NG1 Comdty",
             # "W 1 Comdty",
             # "RR1 Comdty",
             # "GC1 Comdty",
             # "CL1 Comdty",
             # "PA1 Comdty",
             "HG1 Comdty",
             # "C 1 Comdty",
             "KC1 Comdty",
             "CC1 Comdty")
             # "S 1 Comdty",
             # "SB1 Comdty")
raw.comm = bbextract(comm.list, "1999-12-31", Sys.Date()) 
raw.comm %>% tail()

comm.data<-raw.comm %>% 
  fill(everything()) %>% 
  filter(date!=Sys.Date()) %>% 
  rename(date=1, Gold=`GC1 Comd`, Copper=`HG1 Comd`, Coffee=`KC1 Comd`, Cocoa=`CC1 Comd`) %>%
  select(date, Gold, Copper, Coffee, Cocoa)
# , Wheat=`W 1 Comd`, Copper=`HG1 Comd`,
#          Corn=`C 1 Comd`, Gas=`NG1 Comd`, Gold=`GC1 Comd`, Rice=`RR1 Comd`,
#          Soybean=`S 1 Comd`, Sugar=`SB1 Comd`, Coffee=`DF1 Comd`, Cocoa=`QC1 Comd`)%>% 
  # select(date, Oil, Gas, Soybean, Wheat, Rice, Corn, Sugar, Gold, Copper)

lastobs<-max(comm.data$date)%>% format("%b %d, %Y")
comm.data %>% filter(Gold==max(Gold, na.rm=T)) %>% kbl("rst")
comm.data %>% tail() %>% kbl("rst")

# Function to plot data ---------------------------------------------------



comm.plot<-function(cdty, D, startdate, period, color){
  # cdty="Oil"
  # D=comm.data
  D %>% select(date, cdty)%>% 
    filter(date>=startdate) %>% 
    ggplot()+
    geom_line(aes(date,!!sym(cdty)), col=color, size=.8)+
    geom_point(aes(date, !!sym(cdty)), col="firebrick", size=3, data = . %>% slice(n()))+
    # annotate("rect", xmin=as.Date(Sys.Date())-weeks(1), xmax = as.Date (Sys.Date()),
    #          ymin=-Inf, ymax = Inf, fill="grey40", alpha=.3)+
    scale_x_date(breaks=seq(as.Date(startdate), Sys.Date(), by=period)-1,
                 # date_labels = "%b")+
                 date_labels = "%b\n%Y")+
    labs(title=cdty)->g
  return(g)
}

# Plot with Rice and Wheat ------------------------------------------------

# g.rice<-comm.plot("Rice", D=comm.data, startdate="2023-06-30", period="3 months", color=ssamedblue)
# g.gold<-comm.plot("Gold", D=comm.data, startdate="2023-06-30", period="3 months", color=REOorange)
# g.copper<-comm.plot("Copper", D=comm.data, startdate="2023-06-30", period="3 months", color=ssamedblue)
# g.wheat<-comm.plot("Wheat", D=comm.data, startdate="2023-06-30", period="3 months", color=REOorange)
g.gld<-comm.plot("Gold", D=comm.data, startdate="2022-12-31", period="6 months", color=ssapeach3)+
  geom_vline(aes(xintercept=as.Date("2025-4-1")), lty=2, size=.5, col="firebrick")+
    annotate("text", x=as.Date("2025-4-1"), y=2500, label="April 2", col="firebrick", size=7/.pt, hjust=1.1)+
  labs(title = str_wrap("Gold Price, 2022-25",50),
       subtitle = paste0("(USD per oz, as of ", lastobs," )"),
       caption = str_wrap("Source: Bloomberg LLC.", 75))
g.cu<-comm.plot("Copper", D=comm.data, startdate="2022-12-31", period="6 months", color=ssamedblue)+
  geom_vline(aes(xintercept=as.Date("2025-4-1")), lty=2, size=.5, col="firebrick")+
    annotate("text", x=as.Date("2025-4-1"), y=360, label="April 2", col="firebrick", size=7/.pt, hjust=1.1)+
  labs(title = str_wrap("Copper Price, 2022-25",50),
       subtitle = paste0("(USD per 100 lb, as of ", lastobs," )"),
       caption = str_wrap("Source: Bloomberg LLC.", 75))
g.cof<-comm.plot("Coffee", D=comm.data, startdate="2022-12-31", period="6 months", color=ssapeach5)+
  geom_vline(aes(xintercept=as.Date("2025-4-1")), lty=2, size=.5, col="firebrick")+
    annotate("text", x=as.Date("2025-4-1"), y=200, label="April 2", col="firebrick", size=7/.pt, hjust=1.1)+
  labs(title = str_wrap("Coffee Price, 2022-25",50),
       subtitle = paste0("(USD per 100 lb, as of ", lastobs," )"),
       caption = str_wrap("Source: Bloomberg LLC.", 75))
g.coc<-comm.plot("Cocoa", D=comm.data, startdate="2022-12-31", period="6 months", color=ssagrey3)+
  geom_vline(aes(xintercept=as.Date("2025-4-1")), lty=2, size=.5, col="firebrick")+
    annotate("text", x=as.Date("2025-4-1"), y=6000, label="April 2", col="firebrick", size=7/.pt, hjust=1.1)+
  labs(title = str_wrap("Cocoa Price, 2022-25",50),
       subtitle = paste0("(USD per MT, as of ", lastobs," )"),
       caption = str_wrap("Source: Bloomberg LLC.", 75))
  
g.gld
ggsave(filename = "comm1.png",
       height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")

g.cu
ggsave(filename = "comm2.png",
       height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")
g.cof
ggsave(filename = "comm3.png",
       height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")
g.coc
ggsave(filename = "comm4.png",
       height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")

```


```{r}
#| label: US 10-year Yield Chart
#| warning: false
#| echo: false 

code.list<-c("USGG10YR Index")

raw.comm = bbextract(code.list, "1999-12-31", Sys.Date()) %>% 
  rename(yield=2) %>% 
  fill(yield)

bbg.plot<-function(D, startdate, period, color){
  # cdty="Oil"
  # D=comm.data
  D %>% select(date, yield)%>% 
    filter(date>=startdate) %>% 
    ggplot()+
    geom_line(aes(date,yield), col=color, size=.8)+
    geom_point(aes(date, yield), col="firebrick", size=3, data = . %>% slice(n()))+
    # annotate("rect", xmin=as.Date(Sys.Date())-weeks(1), xmax = as.Date (Sys.Date()),
    #          ymin=-Inf, ymax = Inf, fill="grey40", alpha=.3)+
    scale_x_date(breaks=seq(as.Date(startdate), Sys.Date(), by=period)-1,
                 # date_labels = "%b")+
                 date_labels = "%b\n%Y")->g
  return(g)
}

g.usyield<-bbg.plot(raw.comm, "2019-12-31", "12 month", ssagrey4)+
  labs(title="US Generic 10-year Yield, 2019-25",
       subtitle = "(percent)",
       caption = "Source: Bloomberg, LLC.")

ggsave(filename = "yield.png",
       height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")

```



```{r}
#| label: Oil Price Chart
#| warning: false
#| echo: false 

# Commodity prices --------------------------------------------------------
comm.list<-c("CL1 Comdty")
             # "NG1 Comdty",
             # "W 1 Comdty",
             # "RR1 Comdty",
             # "GC1 Comdty")
             # "PA1 Comdty",
             # "HG1 Comdty")
             # "C 1 Comdty",
             # "S 1 Comdty",
             # "SB1 Comdty")
raw.comm = bbextract(comm.list, "1999-12-31", Sys.Date()) 
raw.comm %>% tail()

comm.data<-raw.comm %>% 
  fill(everything()) %>% 
  filter(date!=Sys.Date()) %>% 
  rename(date=1, Oil=`CL1 Comd`) %>%
  select(date, Oil) %>% 
  rbind(c(as.Date(Sys.Date()), 61.19))


comm.data %>% tail()
# , Wheat=`W 1 Comd`, Copper=`HG1 Comd`,
#          Corn=`C 1 Comd`, Gas=`NG1 Comd`, Gold=`GC1 Comd`, Rice=`RR1 Comd`,
#          Soybean=`S 1 Comd`, Sugar=`SB1 Comd`)%>% 
  # select(date, Oil, Gas, Soybean, Wheat, Rice, Corn, Sugar, Gold, Copper)

lastobs<-max(comm.data$date)%>% format("%b %d, %Y")

# Function to plot data ---------------------------------------------------



comm.plot<-function(cdty, D, startdate, period, color){
  # cdty="Oil"
  # D=comm.data
  D %>% select(date, cdty)%>% 
    filter(date>=startdate) %>% 
    ggplot()+
    geom_vline(aes(xintercept=as.Date("2025-4-1")), lty=2, size=.5, col="firebrick")+
    annotate("text", x=as.Date("2025-4-1"), y=90, label="April 2", col="firebrick", size=7/.pt, hjust=1.1)+
    geom_line(aes(date,!!sym(cdty)), col=color, size=.8)+
    geom_point(aes(date, !!sym(cdty)), col="firebrick", size=3, data = . %>% slice(n()))+
    # annotate("rect", xmin=as.Date(Sys.Date())-weeks(1), xmax = as.Date (Sys.Date()),
    #          ymin=-Inf, ymax = Inf, fill="grey40", alpha=.3)+
    scale_x_date(breaks=seq(as.Date(startdate), Sys.Date(), by=period)-1,
                 # date_labels = "%b")+
                 date_labels = "%b\n%Y")+
    labs(title=cdty)->g
  return(g)
}

# Plot with Rice and Wheat ------------------------------------------------

# g.rice<-comm.plot("Rice", D=comm.data, startdate="2023-06-30", period="3 months", color=REOmedblue)
g.oil<-comm.plot("Oil", D=comm.data, startdate="2023-06-30", period="3 months", color=ssagrey4)+
  labs(title = str_wrap("Oil Price, 2023-25",50),
       subtitle = paste0("(USD/barrel, as of ", lastobs,")"),
       caption = str_wrap("Source: Bloomberg LLC.", 75))

g.oil

ggsave(filename = "oil.png",
       height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")

```

```{r}
#| label: Save charts for page 9
#| echo: false
#| output: false
#| warning: false

save(g.gld, g.cu, g.cof, g.coc, g.oil,g.usyield,
     file="gallery_page9.RData")  
     
```

# Page 10

```{r}
#| label: Debt Decomposition Chart
#| warning: false
#| echo: false 

# gather data -------------------------------------------------------------
ssa.imf<-countrycode::countrycode(ssa.list, origin = "iso3c", destination = "imf")
# database<-"WEO_COPY_OF_AFRREO_1" # CSD submitted
data.raw <-
  ecosextract(
    c("NGDPD",
      "NGDP",
      "NGDP_FY",
      "NGDP_R",
      "ENDE",
      "GGEI",
      "GGXCNL_GDP",
      "GGXWDG",
      "GGXWDGCF",
      "GGXWDG_GDP"
    ),
    as.character(ssa.imf),
    # as.character(c(ssa.imf)),
    # "WEO_WEO_LIVE",
    "WEO_WEO_STAGING",
    2013,
    2025,
    "A"
  )
missing.list<-data.raw %>% select(iso3c, year, GGXWDGCF) %>% 
  group_by(iso3c) %>% 
  mutate(count=sum(!is.na(GGXWDGCF))) %>% 
  filter(count==0) %>% 
  pull(iso3c) %>% unique()
  


filepath<-"q:/DATA/AREO/Spring 2025 - REO/Data/"

# foreign debt not available in WEO for a few countries, compile hard data
data.teams<-read_excel(
  paste0(filepath,"FXdebt.xlsx"),
  sheet = "Debt foreign_new",
  range="A2:AR49") %>% 
  slice(3:n())%>% 
  janitor::clean_names() %>% 
  filter(x6%in%missing.list) %>%
  select(x6,x2000:x2029) %>% 
  pivot_longer(-1,names_to = "year", values_to = "value") %>% 
  mutate(year=as.numeric(str_sub(year,2,-1)),
         value=as.numeric(value)) %>% 
  mutate(value=value*1000000000) %>% 
  rename(fordebt.team=value,
         iso3c=x6)


data <- data.raw %>%
  # filter(iso3c=="AGO") %>%
  filter(iso3c != "SSD") %>%
  left_join(data.teams)%>%  #### add hard data from teams
  mutate(gdp.nom = ifelse(
    iso3c %in% c("LSO", "MWI", "NAM", "RWA", "SWZ", "ZMB"),
    NGDP_FY,
    NGDP
  )) %>%
  mutate(gdp.r = NGDP_R) %>%
  group_by(iso3c) %>%
  mutate(g.nom = gdp.nom / lag(gdp.nom) - 1,
         g.r = gdp.r / lag(gdp.r) - 1) %>%
  mutate(defl = gdp.nom / gdp.r * 100) %>%
  mutate(infl = defl / lag(defl) - 1) %>%
  mutate(rho = (1 + g.r) * (1 + infl)) %>%
  mutate(er = ENDE) %>%
  mutate(epsilon = er / lag(er) - 1) %>%
  mutate(int.nom = GGEI) %>%
  mutate(int.gdp = int.nom / gdp.nom * 100) %>%
  mutate(net.lend = GGXCNL_GDP) %>%
  mutate(net.lend.prim = net.lend + int.gdp) %>%
  mutate(debt.nom = GGXWDG) %>%
  mutate(int.rate = int.nom / lag(debt.nom)) %>%
  mutate(debt.f = GGXWDGCF)%>%
  mutate(debt.f = ifelse(is.na(GGXWDGCF), fordebt.team,GGXWDGCF))%>%
  mutate(debt.f.gdp = debt.f / gdp.nom * 100) %>%
  mutate(debt.gdp = GGXWDG_GDP) %>%
  mutate(total = debt.gdp - lag(debt.gdp)) %>%
  mutate(c1 = (1 / rho) * epsilon * lag(debt.f.gdp)) %>%
  mutate(c2 = (1 / rho) * int.rate * lag(debt.gdp)) %>%
  mutate(c3 = -(1 / rho) * infl * lag(debt.gdp)) %>%
  mutate(c4 = -(1 / rho) * g.r * (1 + infl) * lag(debt.gdp)) %>%
  mutate(c5 = -net.lend.prim) %>%
  mutate(c6 = total - c1 - c2 - c3 - c4 - c5)%>%
  # select(iso3c, year, 14:38)
  select(iso3c, year, NGDPD, 16:40) %>% 
  filter(!is.na(c1))


data %>% select(iso3c) %>% unique() %>% pull()

# Plot Waterfall Summary -------------------------------------------------- ***
# ChatGPT output:
#
# This R code defines a function named "plot.water" which generates a plot
# showing the cumulative contributions of six variables to the debt-to-GDP ratio
# of one or more countries over a specified period of time.
#
# The function takes in four arguments: - `country.list`: A vector of country
# codes for which the plot will be generated. - `plottitle`: A string specifying
# the title of the plot. - `start`: An integer indicating the starting year of
# the time period for which the plot will be generated. - `end`: An integer
# indicating the ending year of the time period for which the plot will be
# generated.
#
# The function then performs these steps: 1. Subset the "data" dataset by
# selecting only the variables related to the `country.list` vector, start and
# end years, total, c1 to c6 variables, and debt-to-GDP ratio. 2. Reshape the
# dataset so that variables c1 to c6 have their own rows, rather than columns.
# 3. Calculate the mean value of each variable by year and contribute to the
# dataset. 4. Pivot the dataset so that each variable has its own column. 5.
# Calculate the cumulative sum of each variable and add columns for this
# information to the dataset. 6. Select only the variables related

plot.water <- function(country.list, plottitle, start, end) {
  # country.list=ssa.list
  
  water.data <- data %>%
    select(iso3c, year, NGDPD, total, c1:c6, debt.gdp) %>%
    filter(iso3c %in% country.list) %>%
    filter(year %in% c(start:end))%>%
    pivot_longer(4:11, names_to = "contrib", values_to = "value") %>%
    group_by(year, contrib)%>%
    summarize(value = weighted.mean(value, coalesce(NGDPD,0), na.rm = T))%>%##################weighted mean?
    pivot_wider(names_from = contrib, values_from = value) %>%
    ungroup() %>%
    mutate(
      total.cuml = cumsum(total),
      c1.cuml = cumsum(c1),
      c2.cuml = cumsum(c2),
      c3.cuml = cumsum(c3),
      c4.cuml = cumsum(c4),
      c5.cuml = cumsum(c5),
      c6.cuml = cumsum(c6)
    ) %>%
    select(year, ends_with("cuml"), debt.gdp)
  
  start.debt <- water.data %>%
    filter(year == start) %>%
    pull(debt.gdp)
  
  end.debt <- water.data %>%
    filter(year == end) %>%
    pull(debt.gdp)
  
  water.plot <- water.data %>%
    filter(year == end) %>%
    select(ends_with("cuml")) %>%
    select(-total.cuml) %>%
    pivot_longer(1:6, names_to = "contrib", values_to = "value") %>%
    mutate(endbar = cumsum(value)) %>%
    mutate(startbar = lag(endbar)) %>%
    mutate(startbar = ifelse(is.na(startbar), 0, startbar)) %>%
    mutate(barcol = as.factor(sign(value))) %>%
    mutate(x.label = as.numeric(factor(contrib)))
  
  g <- ggplot(water.plot) +
    geom_segment(
      aes(
        x = ifelse(x.label == last(x.label),
                   last(x.label),
                   x.label),
        xend = ifelse(x.label == last(x.label),
                      last(x.label),
                      x.label + 1),
        y = endbar,
        yend = endbar
      ),
      col = ssagrey2,
      size = .2,
      linetype = 2
    ) +
    geom_segment(
      aes(
        x = x.label,
        xend = x.label,
        y = startbar,
        yend = endbar,
        col = contrib
      ),
      size = 10,
      alpha = .9
    ) +
    geom_text(
      aes(x.label, (endbar + startbar) / 2, label = sprintf("%3.1f", value)),
      size = 2.5,
      col = ssagrey4,
      hjust = 0.5
    ) +
    scale_color_manual(
      values = c(
        ssapeach1,
        ssapeach3,
        ssapeach4,
        ssapeach5,
        fundblue,
        ssagrey2
      ),
      guide = "none"
    ) +
    geom_hline(aes(yintercept = 0), col = ssagrey4, lty = 2) +
    coord_cartesian(xlim = c(.5, 6.5)) +
    scale_x_continuous(
      breaks = c(1:6),
      labels = c(
        "Deprec.",
        "Int.\nrate",
        "Inflation",
        "Real\ngrowth",
        "Prim.\ndeficits",
        "Stock-\nflow"
      )
    ) +
    labs(
      title = paste0(plottitle, ". Debt Drivers, ", start, " to ", end),
      subtitle = "(Percent of GDP, cumulative contribution)"
    )
  return(g)
}
g.debtwater<-plot.water(ssa.list, "SSA", 2020, 2024)
g.debtwater


ggsave(
  filename = "debtdecomp.png",
  height = 3,
  width = 3,
  dpi = 600,
  units = "in",
  device = "png",
  bg = "transparent"
)
```


```{r}
#| label: US ODA Chart using OECD API
#| warning: false
#| echo: false 

library(httr)
library(jsonlite)
library(rsdmx)
library(ggsankey)



url<-"https://sdmx.oecd.org/public/rest/dataflow/OECD.DCD.FSD/DSD_DAC2@DF_DAC2A/1.2?references=all"

raw.struct <- readSDMX(url)

cls <- slot(raw.struct, "codelists")
#get list of codelists
codelists <- sapply(slot(cls, "codelists"), function(x) slot(x, "id"))
codelists %>% kbl("rst")
#get a codelist
price.list <- as.data.frame(slot(raw.struct, "codelists"), codelistId = "CL_PRICES") %>% 
  select(id, contains(".en"))
price.list %>% tail(30) %>% kbl("rst")
country.list <- as.data.frame(slot(raw.struct, "codelists"), codelistId = "CL_AREA_ORG") %>% 
  select(id, contains(".en"))
country.list %>% tail(30) %>% kbl("rst")

country.list %>% filter(str_detect(`label.en`, "United Arab Emirates")) %>% kbl("rst")

country.list %>% filter(str_detect(`id`, "ALLD")) %>% kbl("rst")

measure.list <- as.data.frame(slot(raw.struct, "codelists"), codelistId = "CL_DAC2_MEASURE") %>% 
  select(id, contains(".en"))
measure.list %>% kbl("rst")
type.list <- as.data.frame(slot(raw.struct, "codelists"), codelistId = "CL_FLOW_TYPE") %>% 
  select(id, contains(".en"))
type.list %>% kbl("rst")
unit.list <- as.data.frame(slot(raw.struct, "codelists"), codelistId = "CL_UNIT_MEASURE") %>% 
  select(id, contains(".en"))
unit.list %>% kbl("rst")
unit.list %>% filter(id=="V")

# get concepts from DSD
concepts <- as.data.frame(slot(raw.struct, "concepts"))
concepts


ssa.id<-country.list %>% rename(country=2) %>% 
  mutate(iso3c=countrycode(country, "country.name", "iso3c")) %>% 
  select(id, iso3c, country) %>% 
  filter(iso3c%in%ssa.list) %>% slice(1:45)

#build actual query just USA as donot
query.url<-"https://sdmx.oecd.org/public/rest/data/OECD.DCD.FSD,DSD_DAC2@DF_DAC2A,1.2/"
query.don<-"USA" #United States
query.rec<-paste0(ssa.id$id, collapse="+") #list of SSA recipients
# query.rec<-"F6" #OECD SSA recipients
query.aid<-"206" #Net ODA
query.dat<-"V" #V = Current prices and Q = constant prices
query.time<-"?startPeriod=1990&endPeriod=2023"
query.end<-"&dimensionAtObservation=AllDimensions"

  
query.full<-paste0(query.url,query.don,".", query.rec,".", query.aid,"..",query.dat, query.time, query.end)
query.full
# query.full<-"https://sdmx.oecd.org/public/rest/data/OECD.DCD.FSD,DSD_DAC2@DF_DAC2A,1.2/ALLD.F6+KEN+ETH+BDI.218+201+206..V?startPeriod=2022&endPeriod=2023&dimensionAtObservation=AllDimensions"
raw.sdmx<-readSDMX(query.full)
raw <- as.data.frame(raw.sdmx)
data.us<-raw %>% 
  select(1,2,3,4,7) %>% 
  purrr::set_names(nm=c("year", "donor", "id","measure", "value"))



#build actual query SAU/TUR/UAE as donor

query.don<-"TUR+SAU+ARE+QAT" #Turkey, Saudi, UAE, Qata
  
query.full<-paste0(query.url,query.don,".", query.rec,".", query.aid,"..",query.dat, query.time, query.end)
query.full
# query.full<-"https://sdmx.oecd.org/public/rest/data/OECD.DCD.FSD,DSD_DAC2@DF_DAC2A,1.2/ALLD.F6+KEN+ETH+BDI.218+201+206..V?startPeriod=2022&endPeriod=2023&dimensionAtObservation=AllDimensions"
raw.sdmx<-readSDMX(query.full)
raw <- as.data.frame(raw.sdmx)
data.tur<-raw %>% 
  select(1,2,3,4,7) %>% 
  purrr::set_names(nm=c("year", "donor", "id","measure", "value"))

data.tur %>% pull(donor) %>% unique()

#build actual query all donors
query.don<-"ALLD" #All donors

query.full<-paste0(query.url,query.don,".", query.rec,".", query.aid,"..",query.dat, query.time, query.end)
query.full
# query.full<-"https://sdmx.oecd.org/public/rest/data/OECD.DCD.FSD,DSD_DAC2@DF_DAC2A,1.2/ALLD.F6+KEN+ETH+BDI.218+201+206..V?startPeriod=2022&endPeriod=2023&dimensionAtObservation=AllDimensions"
raw.sdmx<-readSDMX(query.full)
raw <- as.data.frame(raw.sdmx)
data.all<-raw %>% 
  select(1,2,3,4,7) %>% 
  purrr::set_names(nm=c("year", "donor", "id","measure", "value"))


data.oda <- data.us %>% 
  rbind(data.tur) %>% 
  rbind(data.all) %>% 
  filter(year==2023)%>% 
  select(-measure) %>% 
  pivot_wider(names_from = donor, values_from = value)%>% 
  rowwise() %>% 
  mutate(otherd=ALLD-sum(USA,ARE,TUR,QAT, na.rm=T))%>% 
  mutate(nontrad=sum(c(ARE,TUR,QAT), na.rm=T)) %>% 
  ungroup() %>% 
  mutate(fracus=USA/ALLD*100,
         fracnt=nontrad/ALLD*100) %>% 
  arrange(-fracus)

data.oda %>% 
  summarize(USA=sum(USA, na.rm=T),
            NT=sum(nontrad, na.rm=T),
            ALLD=sum(ALLD, na.rm=T)) %>%
  mutate(propus=USA/ALLD*100,
         propnt=NT/ALLD*100) %>% 
  kbl("rst", digits=1)

final.data<-data.oda %>% 
  mutate(across(everything(), ~replace_na(.x, 0))) %>% 
  mutate(rank=rank(desc(USA))) %>% 
  arrange(rank)%>%
  mutate(id=ifelse(rank<=8, id, "rest")) %>% 
  group_by(id)%>% 
  summarize(USA=sum(USA, na.rm=T),
            ALLD=sum(ALLD, na.rm=T)) %>% 
  mutate(other=ALLD-USA) %>% 
  arrange(desc(USA))
final.data%>% kbl("rst")

plot.data<-final.data %>% 
  select(-ALLD) %>% 
  pivot_longer(2:3, names_to = "donor", values_to = "value")%>% 
  select(donor, id, value)%>% 
  make_long(donor, id, value=value)%>% 
  mutate(node=factor(node, levels=c("other", "USA", 
                                    "rest",  "TZA", "MOZ",  "UGA", "SSD", "KEN", "NGA", "COD", "ETH")))%>% 
  mutate(next_node=factor(next_node, levels=c("other", "USA", 
                                    "rest",  "TZA", "MOZ",  "UGA", "SSD", "KEN", "NGA", "COD", "ETH")))

g.oecd1<-ggplot(plot.data, aes(x=x, value=value/1000, next_x=next_x, node=node, next_node=next_node, fill=factor(node)))+
  geom_sankey(flow.alpha=.4, width=.05, space=1)+
  scale_fill_manual(values=c(
                              # ssagrey4,
                             ssablue,
                              ssapeach3,
                             ssagrey4,
                             # ssapeach3,
                            ssagrey2,
                            ssagrey2,
                            ssagrey2,
                            ssagrey2,
                            ssagrey2,
                            ssagrey2,
                            ssagrey2,
                            ssagrey2,
                            ssagrey2,
                            ssagrey2,
                            ssagrey2
                             ))+
  annotate("text", x=.9, y=20, label="USA", size=7/.pt, color=ssapeach3, hjust=1)+
  annotate("text", x=.9, y=-15, label="Other\nOfficial\nDonors", size=7/.pt, color=ssablue, hjust=1)+
  annotate("text", x=2.1, y=28, label="ETH", size=7/.pt, color=ssagrey3, hjust=0)+
  annotate("text", x=2.1, y=22, label="COD", size=7/.pt, color=ssagrey3, hjust=0)+
  annotate("text", x=2.1, y=17, label="NGA", size=7/.pt, color=ssagrey3, hjust=0)+
  annotate("text", x=2.1, y=13, label="KEN", size=7/.pt, color=ssagrey3, hjust=0)+
  annotate("text", x=2.1, y=10, label="SSD", size=7/.pt, color=ssagrey3, hjust=0)+
  annotate("text", x=2.1, y=7, label="UGA", size=7/.pt, color=ssagrey3, hjust=0)+
  annotate("text", x=2.1, y=3, label="MOZ", size=7/.pt, color=ssagrey3, hjust=0)+
  annotate("text", x=2.1, y=-1, label="TZA", size=7/.pt, color=ssagrey3, hjust=0)+
  annotate("text", x=2.1, y=-15, label="Other\nRecipients", size=7/.pt, color=ssagrey4, hjust=0)+
  # scale_y_continuous(breaks = c(-20,0,20), labels=c("0", "20", "40"))+
  theme(axis.line = element_blank(),
        axis.ticks.x = element_blank(),
        legend.position = "none)",
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_blank())+labs(title = "Sub-Saharan Africa, ODA Flows, 2023",
       subtitle = "(USD Billions)",
       caption = "Sources: OECD and IMF staff calculations")
g.oecd1

ggsave(filename = "ODA.png",  height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")

data.gdp<-ecosextract("NGDPD", as.character(ssa.imf),"WEO_WEO_LIVE", 2024, 2024, "A") %>% 
  rename(id=iso3c) %>% 
  select(id, NGDPD)

plot.data<-data.oda %>% 
  left_join(data.gdp) %>% 
  mutate(usagdp=USA*1000000/NGDPD*100,
         othergdp=otherd*1000000/NGDPD*100) %>% 
  arrange(desc(usagdp)) %>% 
  slice(1:10) %>% 
  select(id, usagdp, othergdp) %>% 
  pivot_longer(2:3, names_to = "cat", values_to = "value") %>% 
  mutate(country=countrycode(id, "iso3c", "country.name")) %>% 
  mutate(country=ifelse(id=="COD", "Dem. Rep. Congo", country)) %>% 
  group_by(id) %>% 
  mutate(order=sum(ifelse(cat=="usagdp", value, 0)))


g.oecd2<-ggplot(plot.data)+geom_bar(aes(value, fct_reorder(country, order), fill=cat), stat="identity", alpha=.7)+
  scale_fill_manual(values=c(ssablue, ssapeach3), labels=c("Other Official\nDonors", "USA"))+
  labs(title = str_wrap("Sub-Saharan Africa. Top 10 most Exposed Recipients, 2023",45),
       subtitle = "(Percent of GDP)",
       caption = "Sources: OECD and IMF staff calculations")+
  theme(legend.position = c(.7,.1),
        legend.title = element_blank(),
        legend.key.size = unit(.5, "cm"),
        legend.background = element_rect(fill="transparent"))
g.oecd2

g.oecd1+g.oecd2+plot_layout(widths = c(1,1))

ggsave(filename = "ODA.png",  height = 3, width=6, dpi=600,units="in", device="png", bg = "transparent")

data.oda %>%
  left_join(data.gdp) %>%
  mutate(usagdp=USA*1000000/NGDPD*100,
         othergdp=otherd*1000000/NGDPD*100) %>%
  arrange(desc(usagdp)) %>% head() %>% kbl("rst")

data.oda %>%
  left_join(data.gdp) %>%
  summarize(USA=sum(USA, na.rm=T),
            otherd=sum(otherd, na.rm=T),
            NGDPD=sum(NGDPD, na.rm=T)) %>% 
  mutate(usagdp=USA*1000000/NGDPD*100,
         othergdp=otherd*1000000/NGDPD*100)%>% 
    mutate(frac=USA/otherd*100)%>% kbl("rst") 
  
  # mutate(usagdp=USA*1000000/NGDPD*100,
  #        othergdp=otherd*1000000/NGDPD*100) %>%
  # arrange(desc(usagdp)) %>% head() %>% kbl("rst") %>% 
  #   mutate(frac=USA/otherd*100)

  ### repeat sankey chart for FCS countries
  
  
data.oda %>% 
  summarize(USA=sum(USA, na.rm=T),
            ALLD=sum(ALLD, na.rm=T)) %>%
  mutate(prop=USA/ALLD*100) %>% 
  kbl("rst", digits=1)

final.data<-data.oda %>% 
  mutate(across(everything(), ~replace_na(.x, 0))) %>% 
  mutate(rank=rank(desc(USA))) %>% 
  arrange(rank) %>%
  mutate(id=ifelse(id%in%fragile, "FCS", "rest")) %>% 
  group_by(id)%>% 
  summarize(USA=sum(USA, na.rm=T),
            # NT=sum(nontrad, na.tm=T),
            ALLD=sum(ALLD, na.rm=T)) %>% 
  mutate(other=ALLD-USA) %>% 
  # mutate(other=ALLD-USA-NT) %>% 
  arrange(desc(USA))
final.data%>% kbl("rst")

plot.data<-final.data %>% 
  select(-ALLD) %>% 
  pivot_longer(2:3, names_to = "donor", values_to = "value") %>% 
  select(donor, id, value)%>% 
  make_long(donor, id, value=value)%>% 
  mutate(node=factor(node, levels=c("other", "USA", 
                                    "rest",  "FCS")))%>% 
  mutate(next_node=factor(next_node, levels=c("other", "USA", 
                                    "rest",  "FCS")))

g.1fcs<-ggplot(plot.data, aes(x=x, value=value/1000, next_x=next_x, node=node, next_node=next_node, fill=factor(node)))+
  geom_sankey(flow.alpha=.4, width=.05, space=1)+
  scale_fill_manual(values=c(
                              # ssagrey4,
                             ssablue,
                              ssapeach3,
                             ssagrey4,
                            ssapeach5,
                             # ssapeach3,
                            ssagrey2,
                            ssagrey2,
                            ssagrey2,
                            ssagrey2,
                            ssagrey2,
                            ssagrey2,
                            ssagrey2,
                            ssagrey2,
                            ssagrey2,
                            ssagrey2,
                            ssagrey2
                             ))+
  annotate("text", x=.9, y=20, label="USA", size=7/.pt, color=ssapeach3, hjust=1)+
  annotate("text", x=.9, y=-15, label="Other\nOfficial\nDonors", size=7/.pt, color=ssablue, hjust=1)+
  annotate("text", x=2.1, y=13, label="Fragile and\nConflict\nAffected\nStates", size=7/.pt, color=ssapeach5, hjust=0)+
  annotate("text", x=2.1, y=-15, label="Other\nRecipients", size=7/.pt, color=ssagrey4, hjust=0)+
  # scale_y_continuous(breaks=c(-40, 0,40))+
  scale_y_continuous(breaks = c(-25,0,25), labels=c("0", "25", "50"))+
  theme(axis.line = element_blank(),
        axis.ticks.x = element_blank(),
        legend.position = "none)",
        # axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_blank())+labs(title = str_wrap("US Role in Total ODA Flows to sub-Saharan Africa, 2023",45),
       subtitle = "(USD Billions)",
       caption = "Sources: OECD and IMF staff calculations")
g.1fcs
ggsave(filename = "ODA.png",  height = 2.5, width=2.5, dpi=600,units="in", device="png", bg = "transparent")




  
```


```{r}
#| label: US ODA Chart using foreignassistance.gov data
#| warning: false
#| echo: false 

system.time(raw.dt<-data.table::fread("C:\\projects\\AprREO25\\us_foreign_aid_complete.csv") %>% 
  janitor::clean_names())

data.small<-raw.dt %>% 
  janitor::clean_names() %>% 
  filter(fiscal_year==2024) %>% 
  filter(country_code%in%ssa.list) %>% 
  filter(transaction_type_name=="Disbursements")
  # filter(transaction_type_name=="Obligations")

raw.dt<-NULL

data.small %>% select(international_category_name, international_sector_name, international_purpose_name, international_sector_code) %>%
  unique()%>%arrange(international_category_name, international_sector_name, international_purpose_name, international_sector_code) %>%  kbl("rst")

data.small %>% select(us_category_name, international_sector_name, international_purpose_name) %>%
  unique()%>%arrange(us_category_name, international_sector_name, international_purpose_name) %>%  kbl("rst")

data.small %>% pull(funding_account_name) %>% unique()

catlist<-c("Developmental Food Aid/Food Security Assistance",
           "Basic Education",
           "Basic Health",
           "HIV/AIDS",
           "Emergency Response")

data.small %>% 
  mutate(USAID=(managing_agency_acronym=="USAID"|str_detect(funding_account_name, "Agency for International Development"))) %>%
  # filter(managing_agency_acronym=="USAID") %>% 
  mutate(cat=ifelse(international_sector_name%in%catlist, international_sector_name, "other")) %>% 
  # group_by(us_category_name) %>% 
  group_by(international_category_name) %>% 
  summarize(value=sum(current_dollar_amount, na.rm=T)/1000000,
            USAID=sum(USAID*current_dollar_amount, na.rm=T)/1000000)%>% 
  mutate(total=sum(value),
         USAID.tot=sum(USAID)) %>% 
  mutate(frac=value/total*100,
         usaid.frac=USAID/USAID.tot*100,
         usaid.share=USAID/value*100) %>% 
  arrange(desc(frac)) %>% 
  kbl("rst", digits=1)

data.small %>% 
  mutate(USAID=(managing_agency_acronym=="USAID"|str_detect(funding_account_name, "Agency for International Development"))) %>%
  filter(international_sector_code%in%120:139) %>% # Only Health, including family planning but excluding WASH
  mutate(cat=ifelse(international_sector_name%in%catlist, international_sector_name, "other")) %>% 
  group_by(country_code, international_category_name) %>% 
  summarize(value=sum(current_dollar_amount, na.rm=T)/1000000,
            USAID=sum(USAID*current_dollar_amount, na.rm=T)/1000000)%>% 
  mutate(total=sum(value),
         USAID.tot=sum(USAID)) %>% 
  mutate(frac=value/total*100,
         usaid.frac=USAID/USAID.tot*100,
         usaid.share=USAID/value*100) %>% 
  arrange(desc(frac)) %>% 
  select(country_code, value, USAID, usaid.share) %>% 
  kbl("rst", digits=1)


data.small %>% 
  filter(managing_agency_acronym=="USAID"|str_detect(funding_account_name, "Agency for International Development")) %>%
  # filter(managing_agency_acronym=="USAID") %>% 
  mutate(cat=ifelse(international_sector_name%in%catlist, international_sector_name, "other")) %>% 
  group_by(cat) %>% 
  # group_by(us_category_name) %>% 
  summarize(value=sum(current_dollar_amount, na.rm=T)/1000000) %>% 
  mutate(total=sum(value)) %>% 
  mutate(frac=value/total*100) %>% 
  arrange(desc(frac)) %>% 
  kbl("rst", digits=1)

data.small %>% 
  filter(managing_agency_acronym=="USAID"|str_detect(funding_account_name, "Agency for International Development")) %>%
  # filter(managing_agency_acronym=="USAID") %>% 
  mutate(cat=ifelse(international_sector_name%in%catlist, international_sector_name, "other")) %>%
  # filter(us_category_name=="Humanitarian Assistance") %>% 
  # group_by(us_sector_name) %>% 
  filter(cat=="Basic Health") %>%
  group_by(international_purpose_name) %>%
  summarize(value=sum(current_dollar_amount, na.rm=T)/1000000) %>% 
  mutate(total=sum(value)) %>% 
  mutate(frac=value/total*100) %>% 
  arrange(desc(frac)) %>% 
  kbl("rst", digits=1)

data.small %>% 
  filter(managing_agency_acronym=="USAID"|str_detect(funding_account_name, "Agency for International Development")) %>%
  # filter(managing_agency_acronym=="USAID") %>% 
  mutate(cat=ifelse(international_sector_name%in%catlist, international_sector_name, "other")) %>% 
  filter(cat=="Emergency Response") %>% 
  group_by(international_purpose_name) %>% 
  summarize(value=sum(current_dollar_amount, na.rm=T)/1000000) %>% 
  mutate(total=sum(value)) %>% 
  mutate(frac=value/total*100) %>% 
  arrange(desc(frac)) %>% 
  kbl("rst", digits=1)

data.small %>% 
  filter(country_code%in%fragile) %>%
  filter(managing_agency_acronym=="USAID"|str_detect(funding_account_name, "Agency for International Development")) %>%
  # filter(managing_agency_acronym=="USAID") %>% 
  mutate(cat=ifelse(international_sector_name%in%catlist, international_sector_name, "other")) %>%
  mutate(type=case_match(cat,
                         c("Emergency Response", "Developmental Food Aid/Food Security Assistance")~"Food Security/Emergency Food Assistance",
                         c("Basic Health", "HIV/AIDS")~"Basic Health & HIV/AIDS",
                         c("Basic Education")~"Basic Education",
                         c("other")~"Other")
         ) %>% 
  group_by(country_code,type) %>% 
  # group_by(us_category_name) %>% 
  summarize(value=sum(current_dollar_amount, na.rm=T)/1000000) %>% 
  mutate(total=sum(value)) %>% 
  mutate(frac=value/total*100) %>% 
  arrange(country_code, desc(frac)) %>% 
  slice(1) %>% select(country_code, total) %>% 
  mutate(country=countrycode(country_code, "iso3c", "country.name")) %>% 
  arrange(country) %>%
  ungroup() %>% summarize(total=sum(total, na.rm=T)) %>%
  kbl("rst", digits=1) 

data.gdp<-ecosextract("NGDPD", as.character(ssa.imf),"WEO_WEO_LIVE", 2023, 2024, "A") %>% 
  rename(id=iso3c) %>% 
  select(id, year, NGDPD)%>% 
  pivot_wider(names_from = year, values_from = NGDPD)%>% 
  mutate(FY24GDP=0.75*`2024`+0.25*`2023`) %>%
  rename(iso3c=id) %>% 
  select(iso3c, FY24GDP)

top.ten.usd<-data.small %>% 
  # filter(country_code=="SSD") %>% 
  filter(managing_agency_acronym=="USAID"|str_detect(funding_account_name, "Agency for International Development")) %>%
  group_by(country_code) %>% 
  summarize(total=sum(current_dollar_amount, na.rm=T)/1000000) %>%
  arrange(desc(total)) %>% 
  slice(1:10) %>% 
  pull(country_code)
  # kbl("rst", digits=1)

data.small %>% 
  # filter(country_code=="SSD") %>% 
  filter(managing_agency_acronym=="USAID"|str_detect(funding_account_name, "Agency for International Development")) %>%
  group_by(country_code) %>% 
  summarize(total=sum(current_dollar_amount, na.rm=T)/1000000) %>%
  rename(iso3c=country_code) %>% 
  left_join(data.gdp) %>% 
  mutate(FY24GDP=FY24GDP/1000000) %>% 
  ungroup() %>% 
  summarize(total=sum(total, na.rm=T),
            FY24GDP=sum(FY24GDP, na.rm=T)) %>% 
  mutate(frac=total/FY24GDP*100) %>% kbl("rst")


top.ten.gdp<-data.small %>% 
  # filter(country_code=="SSD") %>% 
  filter(managing_agency_acronym=="USAID"|str_detect(funding_account_name, "Agency for International Development")) %>%
  group_by(country_code) %>% 
  summarize(total=sum(current_dollar_amount, na.rm=T)/1000000) %>%
  rename(iso3c=country_code) %>% 
  left_join(data.gdp) %>% 
  mutate(FY24GDP=FY24GDP/1000000) %>% 
  mutate(frac=total/FY24GDP*100) %>% 
  arrange(desc(frac))%>% 
  slice(1:10) %>% 
  pull(iso3c)

plot.data.usd<-data.small %>% 
  filter(country_code%in%top.ten.usd) %>% 
  rename(iso3c=country_code) %>% 
  filter(managing_agency_acronym=="USAID"|str_detect(funding_account_name, "Agency for International Development")) %>%
  mutate(cat=ifelse(international_sector_name%in%catlist, international_sector_name, "other")) %>%
  mutate(type=case_match(cat,
                         c("Emergency Response", "Developmental Food Aid/Food Security Assistance")~"Food Security/Emergency Food Assistance",
                         c("Basic Health", "HIV/AIDS")~"Basic Health & HIV/AIDS",
                         c("Basic Education")~"Basic Education",
                         c("other")~"Other")
         ) %>% 
  group_by(iso3c,type) %>% 
  # group_by(us_category_name) %>% 
  summarize(value=sum(current_dollar_amount, na.rm=T)/1000000) %>% 
  mutate(total=sum(value)) %>% 
  mutate(type=factor(type, levels=c("Other", "Basic Education", "Basic Health & HIV/AIDS", "Food Security/Emergency Food Assistance"))) %>% 
  mutate(country=countrycode(iso3c, "iso3c", "country.name")) %>% 
  mutate(country=ifelse(iso3c=="COD", "Dem.Rep.Congo", country))

g.usd<-ggplot(plot.data.usd)+geom_bar(aes(value, fct_reorder(country, total), fill=type), stat="identity")+
  scale_fill_manual(values=c(ssagrey2, ssapeach2, ssablue, ssapeach4),
                    labels=c("Other",
                             "Basic\nEducation", "Basic Health\n& HIV/AIDS", "Food Security &\nEmergency Food Assistance"),
                    guide = guide_legend(reverse = TRUE))+
  scale_x_continuous(labels=label_comma())+
  coord_cartesian(xlim=c(0,1300))+
  theme(legend.position = c(.8,.3),
        legend.title = element_blank(),
        legend.key.size = unit(.3, "cm"))+
  labs(title=str_wrap("Top 10 Most Exposed Countries to USAID Flows, CY 2024",45),
  subtitle = "By Amount (USD millions)",
       caption=paste0("Source: ForeignAssistance.gov and IMF staff calculations","\n",str_wrap("Note: Affected flows include those in which USAID is either the Managing Agency or the Funding Agency. US calendar year ends September, 2024.",65)))
g.usd  

ggsave(filename = "ODA.png",  height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")

plot.data.gdp<-data.small %>% 
  filter(country_code%in%top.ten.gdp) %>% 
  rename(iso3c=country_code) %>% 
  left_join(data.gdp)%>% 
  filter(managing_agency_acronym=="USAID"|str_detect(funding_account_name, "Agency for International Development")) %>%
  mutate(cat=ifelse(international_sector_name%in%catlist, international_sector_name, "other")) %>%
  mutate(type=case_match(cat,
                         c("Emergency Response", "Developmental Food Aid/Food Security Assistance")~"Food Security/Emergency Food Assistance",
                         c("Basic Health", "HIV/AIDS")~"Basic Health & HIV/AIDS",
                         c("Basic Education")~"Basic Education",
                         c("other")~"Other")
         ) %>% 
  group_by(iso3c,type) %>% 
  # group_by(us_category_name) %>% 
  summarize(value=sum(current_dollar_amount, na.rm=T)/1000000,
            FY24GDP=mean(FY24GDP, na.rm=T)) %>% 
  mutate(pct=value/FY24GDP*100000000) %>% 
  mutate(total=sum(pct)) %>% 
  mutate(type=factor(type, levels=c("Other", "Basic Education", "Basic Health & HIV/AIDS", "Food Security/Emergency Food Assistance"))) %>% 
  mutate(country=countrycode(iso3c, "iso3c", "country.name")) %>% 
  mutate(country=ifelse(iso3c=="COD", "Dem.Rep.Congo", country))

g.gdp<-ggplot(plot.data.gdp)+geom_bar(aes(pct, fct_reorder(country, total), fill=type), stat="identity")+
  scale_fill_manual(values=c(ssagrey2, ssapeach2, ssablue, ssapeach4),
                    labels=c("Other",
                             "Basic\nEducation", "Basic Health\n& HIV/AIDS", "Food Security &\nEmergency Food Assistance"),
                    guide = guide_legend(reverse = TRUE))+
  scale_x_continuous(labels=label_comma())+
  # coord_cartesian(xlim=c(0,1300))+
  theme(legend.position = c(.8,.3),
        legend.title = element_blank(),
        legend.key.size = unit(.3, "cm"))+
  labs(title=str_wrap("Top 10 Most Exposed Countries to USAID Flows, CY 2024",45),
  subtitle = "By Percent of GDP",
       caption=paste0("Source: ForeignAssistance.gov and IMF staff calculations","\n",str_wrap("Note: Affected flows include those in which USAID is either the Managing Agency or the Funding Agency. US calendar year ends September, 2024.",65)))
g.gdp

g.usd+g.gdp+plot_annotation(title = "Sub-Saharan Africa. Top 10 Most Exposed Countries to USAID Flows, CY 2024",
                            caption=paste0("Source: ForeignAssistance.gov, WEO database, and IMF staff calculations","\n",str_wrap("Note: Affected flows include those in which USAID is either the Managing Agency or the Funding Agency. US calendar year ends September, 2024.",155)))+plot_layout(guides = "collect")&theme(legend.position = "bottom")

ggsave(filename = "ODA.png",  height = 3, width=6, dpi=600,units="in", device="png", bg = "transparent")


### repeat for FCS

plot.data.usd<-data.small %>% 
  filter(country_code%in%fragile) %>% 
  rename(iso3c=country_code) %>% 
  filter(managing_agency_acronym=="USAID"|str_detect(funding_account_name, "Agency for International Development")) %>%
  mutate(cat=ifelse(international_sector_name%in%catlist, international_sector_name, "other")) %>%
  mutate(type=case_match(cat,
                         c("Emergency Response", "Developmental Food Aid/Food Security Assistance")~"Food Security/Emergency Food Assistance",
                         c("Basic Health", "HIV/AIDS")~"Basic Health & HIV/AIDS",
                         c("Basic Education")~"Basic Education",
                         c("other")~"Other")
         ) %>% 
  group_by(iso3c,type) %>% 
  # group_by(us_category_name) %>% 
  summarize(value=sum(current_dollar_amount, na.rm=T)/1000000) %>% 
  mutate(total=sum(value)) %>% 
  mutate(type=factor(type, levels=c("Other", "Basic Education", "Basic Health & HIV/AIDS", "Food Security/Emergency Food Assistance"))) %>% 
  mutate(country=countrycode(iso3c, "iso3c", "country.name")) %>% 
  mutate(country=ifelse(iso3c=="COD", "Dem.Rep.Congo", country))

g.usdfcs<-ggplot(plot.data.usd)+geom_bar(aes(value, fct_reorder(country, total), fill=type), stat="identity")+
  scale_fill_manual(values=c(ssagrey2, ssapeach2, ssablue, ssapeach4),
                    labels=c("Other",
                             "Basic\nEducation", "Basic Health\n& HIV/AIDS", "Food Security &\nEmergency Food\nAssistance"),
                    guide = guide_legend(reverse = TRUE))+
  scale_x_continuous(labels=label_comma())+
  coord_cartesian(xlim=c(0,1300))+
  theme(legend.position = c(.8,.3),
        legend.title = element_blank(),
        legend.key.size = unit(.6, "cm"))+
  labs(title = str_wrap("By Amount",50),
       subtitle = "(USD millions)")
  

ggsave(filename = "ODA.png",  height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")

plot.data.gdp<-data.small %>% 
  filter(country_code%in%fragile) %>% 
  rename(iso3c=country_code) %>% 
  left_join(data.gdp)%>% 
  filter(managing_agency_acronym=="USAID"|str_detect(funding_account_name, "Agency for International Development")) %>%
  mutate(cat=ifelse(international_sector_name%in%catlist, international_sector_name, "other")) %>%
  mutate(type=case_match(cat,
                         c("Emergency Response", "Developmental Food Aid/Food Security Assistance")~"Food Security/Emergency Food Assistance",
                         c("Basic Health", "HIV/AIDS")~"Basic Health & HIV/AIDS",
                         c("Basic Education")~"Basic Education",
                         c("other")~"Other")
         ) %>% 
  group_by(iso3c,type) %>% 
  # group_by(us_category_name) %>% 
  summarize(value=sum(current_dollar_amount, na.rm=T)/1000000,
            FY24GDP=mean(FY24GDP, na.rm=T)) %>% 
  mutate(pct=value/FY24GDP*100000000) %>% 
  mutate(total=sum(pct)) %>% 
  mutate(type=factor(type, levels=c("Other", "Basic Education", "Basic Health & HIV/AIDS", "Food Security/Emergency Food Assistance"))) %>% 
  mutate(country=countrycode(iso3c, "iso3c", "country.name")) %>% 
  mutate(country=ifelse(iso3c=="COD", "Dem.Rep.Congo", country))

g.gdpfcs<-ggplot(plot.data.gdp)+geom_bar(aes(pct, fct_reorder(country, total), fill=type), stat="identity")+
  scale_fill_manual(values=c(ssagrey2, ssapeach2, ssablue, ssapeach4),
                    labels=c("Other",
                             "Basic\nEducation", "Basic Health\n& HIV/AIDS", "Food Security &\nEmergency Food\nAssistance"),
                    guide = guide_legend(reverse = TRUE))+
  scale_x_continuous(labels=label_comma())+
  # coord_cartesian(xlim=c(0,1300))+
  theme(legend.position = c(.8,.3),
        legend.title = element_blank(),
        legend.key.size = unit(.6, "cm"))+
  labs(title = str_wrap("By Fraction of GDP",50),
       subtitle = "(percent of GDP)")
g.usdfcs+g.gdpfcs+plot_annotation(title = "Sub-Saharan Africa. Exposure of FCS Countries to USAID Flows, CY 2024",
                            caption=paste0("Source: ForeignAssistance.gov, WEO database, and IMF staff calculations","\n",str_wrap("Note: Affected flows include those in which USAID is either the Managing Agency or the Funding Agency. US calendar year ends September, 2024.",155)))+plot_layout(guides = "collect")&theme(legend.position = "bottom")

ggsave(filename = "ODA.png",  height = 6, width=6, dpi=600,units="in", device="png", bg = "transparent")

top.ten.fcs<-data.small %>% 
  # filter(country_code=="SSD") %>% 
  filter(managing_agency_acronym=="USAID"|str_detect(funding_account_name, "Agency for International Development")) %>%
  group_by(country_code) %>% 
  summarize(total=sum(current_dollar_amount, na.rm=T)/1000000) %>%
  rename(iso3c=country_code) %>% 
  left_join(data.gdp) %>% 
  mutate(FY24GDP=FY24GDP/1000000) %>% 
  mutate(frac=total/FY24GDP*100) %>% 
  arrange(desc(frac))%>%
  filter(iso3c%in%fragile) %>% 
  slice(1:10) %>% 
  pull(iso3c)

g.gdpfcs<-ggplot(plot.data.gdp %>% filter(iso3c%in%top.ten.fcs))+geom_bar(aes(pct, fct_reorder(country, total), fill=type), stat="identity")+
  scale_fill_manual(values=c(ssagrey2, ssapeach2, ssablue, ssapeach4),
                    labels=c("Other",
                             "Basic\nEducation", "Basic Health\n& HIV/AIDS", "Food Security &\nEmergency Food\nAssistance"),
                    guide = guide_legend(reverse = TRUE))+
  scale_x_continuous(labels=label_comma())+
  # coord_cartesian(xlim=c(0,1300))+
  theme(legend.position = c(.8,.4),
        legend.title = element_blank(),
        legend.key.size = unit(.5, "cm"))+
  labs(title = str_wrap("Impact of USAID flows, CY 2024",50),
       subtitle = "(percent of local GDP, top 10 FCS countries)",
       caption=paste0("Source: ForeignAssistance.gov, WEO database, and IMF staff calculations","\n",str_wrap("Note: Affected flows include those in which USAID is either the Managing Agency or the Funding Agency. US calendar year ends September, 2024.",85)))
g.1fcs+g.gdpfcs+plot_annotation(title = "Sub-Saharan Africa. Exposure of FCS Countries to USAID Flows, CY 2024")

ggsave(filename = "ODAfcs.png",  height = 4, width=6, dpi=600,units="in", device="png", bg = "transparent")

```

```{r}
#| label: Save charts for page 10
#| echo: false
#| output: false
#| warning: false

save(g.debtwater, g.oecd1, g.oecd2, g.1fcs, g.usd, g.usdfcs, g.gdp, g.gdpfcs,
     file="gallery_page10.RData")  
     
```

# page 11


```{r}
#| label: USAID Health Spending Charts
#| warning: false
#| echo: false 

system.time(raw.dt<-data.table::fread("C:\\projects\\AprREO25\\us_foreign_aid_complete.csv") %>% 
  janitor::clean_names())

data.small<-raw.dt %>% 
  janitor::clean_names() %>% 
  filter(fiscal_year==2022) %>% 
  filter(country_code%in%ssa.list) %>% 
  filter(transaction_type_name=="Disbursements")
  # filter(transaction_type_name=="Obligations")

raw<-NULL

data.small %>% select(international_category_name, international_sector_name, international_purpose_name, international_sector_code) %>%
   filter(international_sector_code%in%120:139) %>% 
  unique()%>%arrange(international_category_name, international_sector_name, international_purpose_name, international_sector_code) %>%  
  arrange(international_sector_code) %>%kbl("rst")

data.small %>% select(us_category_name, international_sector_name, international_purpose_name, international_sector_code) %>%
  filter(international_sector_code%in%120:139) %>% 
  unique()%>%arrange(us_category_name, international_sector_name, international_purpose_name, international_sector_code) %>%  
  arrange(international_sector_code) %>% kbl("rst")

data.small %>% pull(funding_account_name) %>% unique()

data.us<-data.small %>% 
  # mutate(USAID=(managing_agency_acronym=="USAID"|str_detect(funding_account_name, "Agency for International Development"))) %>%
  filter(international_sector_code%in%120:139) %>%
  # filter(us_category_name=="Health") %>%
  # filter(international_sector_name=="Basic Health") %>%
  # filter(country_code=="ZAF") %>% 
  arrange(activity_id) %>% 
  select(activity_id, current_dollar_amount, everything())%>% 
  group_by(country_code)%>% 
  summarize(value=sum(current_dollar_amount, na.rm=T)/1000000) %>% 
  rename(iso3c=country_code)

data.gdp<-ecosextract("NGDPD", as.character(ssa.imf),"WEO_WEO_LIVE", 2021, 2022, "A") %>% 
  rename(id=iso3c) %>% 
  select(id, year, NGDPD) %>% 
  pivot_wider(names_from = year, values_from = NGDPD) %>% 
  mutate(FY22GDP=(0.75*`2022`+0.25*`2021`)/1000000) %>%
  rename(iso3c=id) %>% 
  select(iso3c, FY22GDP)

data.usgdp<-data.us %>% 
  left_join(data.gdp) %>% 
  mutate(aidgdp=value/FY22GDP*100)

data.health<-read_excel("C:\\Projects\\AprREO25\\GHED_data.XLSX", sheet="Data") %>% 
  select(code, year, gghed_gdp, ext_gdp) %>% 
  filter(year==2022& code%in%ssa.list) %>% 
  rename(iso3c=code) 

plot.data<-data.health %>%
  left_join(data.usgdp) %>% 
  select(iso3c, aidgdp, gghed_gdp, ext_gdp) %>% 
  pivot_longer(3:4, names_to = "type", values_to = "value") %>% 
  na.omit() %>% 
  mutate(type=factor(type, levels=c("gghed_gdp", "ext_gdp"),
                     labels=c("Domestically\nFunded", "Externally\nFunded"))) %>% 
  mutate(country=countrycode(iso3c, "iso3c", "country.name"))
plot.order<-plot.data %>% 
  group_by(country) %>% 
  slice(1) %>% 
  arrange(desc(aidgdp)) %>% head(10) %>% pull(country)

g.health1<-ggplot(plot.data %>% filter(country%in%plot.order))+
  geom_bar(aes(value, country, fill=type), stat = "identity")+
  geom_segment(aes(x=0, xend=aidgdp, y=fct_reorder(country, aidgdp)), size=1.3)+
  geom_point(aes(x=aidgdp, y=fct_reorder(country, aidgdp)), size=5, shape="|")+
  scale_fill_manual(values=c(ssapeach2, ssapeach3))+
  theme(legend.position = c(.8,.3),
        legend.title = element_blank(),
        legend.key.size = unit(.5, "cm"),
        plot.title = element_text(size=7))+
  labs(title = str_wrap("USAID Assistance and Total Government Spending on Health, Top 10 Recipients.",50),
       subtitle = "(percent of GDP, black bar = USAID Assistance)",
                        caption = paste0("Sources: WHO Global Health Expenditure Database, ForeignAssistance.gov, WEO database, and IMF staff calculations."))
g.health1  
# ggsave(filename = "health.png",  height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")

plot.data<-data.health %>%
  left_join(data.usgdp) %>% 
  select(iso3c, aidgdp, gghed_gdp, ext_gdp) %>% 
  mutate(total=gghed_gdp+ext_gdp) %>% 
  mutate(frac=aidgdp/total*100) %>% 
  na.omit() %>% 
  mutate(country=countrycode(iso3c, "iso3c", "country.name"))
plot.order<-plot.data %>% 
  group_by(country) %>% 
  arrange(desc(frac)) %>% head(10) %>% pull(country)

g.health2<-ggplot(plot.data %>% filter(country%in%plot.order))+
  geom_bar(aes(frac, fct_reorder(country, frac)), stat = "identity", fill=ssagrey3)+
  labs(title = str_wrap("USAID Assistance as Proportion of Total Government Spending on Health, Top 10.",50),
       subtitle = "(percent of government spending)",
                        caption = paste0("Sources: WHO Global Health Expenditure Database, ForeignAssistance.gov, WEO database, and IMF staff calculations."))
g.health2


g.health1+g.health2+plot_annotation(title = "USAID Health Assistance Relative to Government Health Spending, 2022",
                        caption = paste0("Sources: WHO Global Health Expenditure Database, ForeignAssistance.gov, WEO database, and IMF staff calculations.",
                                         "\n",
                                         str_wrap("Note: Latest available health spending data from WHO is for 2022. Externally-funded spending includes direct foreign transfers and foreign transfers distributed by government, encompassing all financial inflows into the national health system from outside the country. USAID health assistance includes aid for categories 120-139 under the OECD DAC international standard.", 150)),
                        theme = theme(plot.title = element_text(size=8)))

ggsave(filename = "health.png",  height = 3, width=6, dpi=600,units="in", device="png", bg = "transparent")

plot.data %>% 
  left_join(data.gdp) %>% 
  summarize(average=weighted.mean(frac, FY22GDP))

```


```{r}
#| label: Life expectancy chart for SSA PEPFAR countries
#| warning: false
#| echo: false 

raw.le<-read_csv("c:/projects/AprREO25/life-expectancy/life-expectancy.csv")

plot.data<-raw.le %>% 
  janitor::clean_names() %>% 
  filter(year%in%1950:2024) %>% 
  filter(code%in%c("BWA", "ZAF", "NAM", "ZMB", "SWZ", "LSO")) %>% 
  rename(le=4)
  
g.le<-ggplot(plot.data)+geom_line(aes(year, le, colour = code), size=.8)+
  geom_text(aes(year, le, colour = code, label=code), size=7/.pt, data=. %>% group_by(code) %>% slice(n()), hjust=-.2)+
  scale_color_manual(values=c(ssapeach5, ssapeach3, ssagrey2, ssagrey4, ssablue, ssapeach1), guide="none")+
  geom_vline(aes(xintercept = 2003), lty=2, col=ssagrey3, size=1)+
  coord_cartesian(xlim = c(1950, 2030))+
  annotate("text", x=2001, y=68, label="PEPFAR\nIntroduced", col=ssagrey3, size=7/.pt, hjust=1)+
  labs(title = str_wrap("Life Expectancy at Birth, 1950-2023.",50),
       subtitle = "(years)",
       caption = "Source: OurWorldinData.org/life-expectancy")

ggsave(filename = "pepfar.png",  height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")
  
  
```



```{r}
#| label: Fiscal balance adjustment bar chart
#| warning: false
#| echo: false 

database<-"WEO_WEO_LIVE" #
# database<-"WEO_WEO_STAGING" 
# database<-"WEO_COPY_OF_AFRREO_1"
country.list<-as.character(ssa.imf)
code.list<-c("GGXCNL_GDP", "PPPGDP", "GGRG_GDP", "GGEI_GDP")



data<-ecosextract(code.list, as.character(country.list), database, 1990,2025,"A")%>%
  mutate_all( ~ case_when(!is.nan(.x) ~ .x)) %>% 
  rename(interest=5, grants=6, deficit=7, ppp=8)
  summary(data)



plot.data<-data %>%
  # mutate(deficit=-deficit+grants) %>% 
  mutate(pb=deficit+interest) %>% 
  filter(year%in%c(2019:2025)) %>% 
  group_by(year) %>% 
  summarize(pb=weighted.mean(pb, coalesce(ppp,0), na.rm=T),
            int=weighted.mean(interest, coalesce(ppp,0), na.rm=T),
            deficit=weighted.mean(deficit, coalesce(ppp ,0), na.rm=T)) %>% 
  mutate(check=pb-int-deficit)%>% 
  mutate(int=-int) %>% 
  pivot_longer(2:5, names_to = "var", values_to = "value") %>% 
  filter(year%in%c(2019,2020, 2024)) %>% 
  mutate(year=factor(year))
  
         
g.adj<-ggplot(plot.data)+geom_bar(aes(year, value, fill=fct_reorder(var, desc(var))), stat="identity", data=. %>% filter(var%in%c("pb", "int")))+
  geom_hline(aes(yintercept=0), lty=2, size=.5, col=ssagrey4)+
  theme(legend.title = element_blank(),
        legend.position = c(.5,.95),
        legend.direction = "horizontal",
        legend.background = element_rect(fill="transparent"))+
  coord_cartesian(ylim=c(-6.5,.7))+
  scale_fill_manual(values= c(ssablue, ssapeach4), labels=c("Prim.Bal.", "Interest"))+
  labs(title = str_wrap("Sub-Saharan Africa: Fiscal Balance, 2019-24.", 50),
       subtitle = "(percent of GDP, weighted mean)",
       caption = "Source: WEO database.")
g.adj  
  
ggsave(filename = "slide2b.png",
       height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")

#
g.7$data %>% write.csv(file = "slide2b.csv")


```

```{r}
#| label: Save charts for page 11
#| echo: false
#| output: false
#| warning: false

save(g.health1, g.health2, g.adj, g.le,
     file="gallery_page11.RData")  
     
```

# Page 12

```{r}
#| label: Upset plot for macro vulnerabilities
#| warning: false
#| echo: false 

library(ComplexUpset)

filepath<-"q:/DATA/AREO/Spring 2025 - REO/Data/"
filepath<-"c:/projects/AprREO25/"

# foreign debt not available in WEO for a few countries, compile hard data
pbs.list<-read_excel(
  paste0(filepath,"Key numbers.xlsx"),
  sheet = "Primary balance below DSPB",
  range="A1:d46") %>% 
  rename(country=1, test=4) %>% 
  filter(test>=0) %>% 
  mutate(iso3c=countrycode(country, "country.name", "iso3c")) %>% 
  pull(iso3c)
int.list<-read_excel(
  paste0(filepath,"Key numbers.xlsx"),
  sheet = "Interest to rev ex grants",
  range="A2:e47") %>% 
  rename(country=1, test=3) %>% 
  filter(test>=20) %>% 
  mutate(iso3c=countrycode(country, "country.name", "iso3c")) %>% 
  pull(iso3c)
infl.list<-read_excel(
  paste0(filepath,"Key numbers.xlsx"),
  sheet = "Inflation",
  range="A2:b48") %>% 
  rename(country=1, test=2) %>% 
  filter(test>=10) %>% 
  mutate(iso3c=countrycode(country, "country.name", "iso3c")) %>% 
  pull(iso3c)
res.list<-read_excel(
  paste0(filepath,"Key numbers.xlsx"),
  sheet = "Reserves below 5-months",
  range="A1:c46") %>% 
  rename(country=1, test=3) %>% 
  filter(test<=3) %>% 
  mutate(iso3c=countrycode(country, "country.name", "iso3c")) %>% 
  pull(iso3c)
reer.list<-read_excel(
  paste0(filepath,"Key numbers.xlsx"),
  sheet = "REER appreciation above 10%",
  range="A2:h47") %>% 
  rename(country=1, test=8) %>% 
  filter(test>=10) %>% 
  mutate(iso3c=countrycode(country, "country.name", "iso3c")) %>% 
  pull(iso3c)

plot.data<-data.frame(iso3c=setdiff(ssa.list, "ERI")) %>% 
  mutate(pb=iso3c%in%pbs.list) %>% 
  mutate(int=iso3c%in%int.list) %>% 
  mutate(infl=iso3c%in%infl.list) %>% 
  mutate(res=iso3c%in%res.list) %>% 
  mutate(reer=iso3c%in%reer.list) 
  

g.1<-upset(plot.data, names(plot.data[,2:6]), 
      height_ratio = 1.5, 
             # base_annotations=list(),
             set_sizes = F, 
             wrap=F,
      labeller = as_labeller(c("pb"="Prim. Bal. above\nDebt Stab. Prim. Bal.",
                               "int"="Interest/Rev.\n above 20%",
                               "infl"="Inflation above 10%",
                               "res"="Reserves below\n3 mths imports",
                               "reer"="REER apprec more\nthan 10% since 2015")),
      base_annotations=list(
        'Intersection size'=intersection_size(
            text=list(size=7/.pt, vjust=-.4))+
          theme(axis.text.y = element_blank(),
                axis.title.y = element_blank(),
                panel.grid = element_blank(),
                axis.line.x = element_line(size=.7, color=ssagrey4),
                axis.line.y=element_line(size=.7, color=ssagrey4))),
      matrix=(
        intersection_matrix(
            geom=geom_point(
                size=2.5)
        )),
             queries=list(
              upset_query(
                intersect=c("pb", 'reer', 'res'),
                color=ssapeach4,
                fill=ssapeach4,
                only_components=c('intersections_matrix', "Intersection size")),
              upset_query(
                intersect=c("pb", 'reer', 'int'),
                color=ssapeach4,
                fill=ssapeach4,
                only_components=c('intersections_matrix', "Intersection size")),
              upset_query(
                intersect=c("pb", 'res', 'int', 'infl'),
                color=ssapeach4,
                fill=ssapeach4,
                only_components=c('intersections_matrix', "Intersection size")),
              upset_query(
                intersect=c("pb", 'res', 'infl'),
                color=ssapeach4,
                fill=ssapeach4,
                only_components=c('intersections_matrix', "Intersection size")),
              upset_query(
                intersect=c("int", 'res', 'infl'),
                color=ssapeach4,
                fill=ssapeach4,
                only_components=c('intersections_matrix', "Intersection size")),
              upset_query(
                intersect=c("pb", "reer", 'res', 'infl'),
                color=ssapeach4,
                fill=ssapeach4,
                only_components=c('intersections_matrix', "Intersection size")),
              upset_query(
                intersect=c("reer", 'res', 'infl'),
                color=ssapeach4,
                fill=ssapeach4,
                only_components=c('intersections_matrix', "Intersection size")),
              upset_query(
                intersect=c("pb", 'infl', 'int'),
                color=ssapeach4,
                fill=ssapeach4,
                only_components=c('intersections_matrix', "Intersection size"))
        ))+theme(axis.title.x = element_blank(), axis.text = element_text(size=6))

g.upset<-g.1+labs(title="Sub-Saharan Africa. Overlap of Macroeconomic Imbalances, 2024",
                    subtitle = "(No. of Countries in Intersection)",
                    caption = "Source: WEO database and IMF Staff calculations")
               g.upset     

ggsave(filename = "upset.png",  height = 3, width=6, dpi=600,units="in", device="png", bg = "transparent")



```




```{r}
#| label: Issue yields arrow chart for Eurobonds
#| warning: false
#| echo: false 

raw<-read_excel("c:\\projects\\AprREO25\\Eurobond_yields 1.xlsx", sheet = "Table", range="N3:P12")

plot.data<-raw %>% 
  rename(iso3c=1) %>% 
  mutate(country=countrycode(iso3c, "iso3c", "country.name")) %>% 
  mutate(country=ifelse(iso3c=="Average", "Average", country)) %>% 
  arrange(Previous)

  

g.issueyield<-ggplot(plot.data)+
  geom_segment(aes(x=fct_reorder(country,Previous), xend=country,
                   y=Previous, yend = `2024`, col=country%in%c("Average")),
               arrow = arrow(length=unit(.07, "inches"), type="open"), siZe=1.3)+
  geom_point(aes(country, Previous, col=country%in%c("Average")), size=2.5)+
  scale_color_manual(values=c(ssapeach4, ssagrey3), guide="none")+
  scale_x_discrete(guide = guide_axis(n.dodge = 2))+
  annotate("text", x=5.5, y=5.5, label="Pre-crisis", size=7/.pt, color=ssagrey3)+
  annotate("text", x=5.5, y=11.5, label="Latest 2024-25", size=7/.pt, color=ssagrey3)+
  labs(title = "Yield to Maturity at Issuance, 2019-25",
       subtitle = "(percent)",
       caption = "Source: Bloomberg, LLC")
  

ggsave(filename = "yields.png",
       height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")
```


```{r}
#| label: Uncertainty index from FRED
#| warning: false
#| echo: false 

library(fredr)



## FRED API key "c36cb21e65d41e0072e241470b22487b"

fredr_set_key("c36cb21e65d41e0072e241470b22487b")
# raw<-fredr(
#   series_id = "UNRATE",
#   observation_start = as.Date("1990-01-01"),
#   observation_end = as.Date("2000-01-01")
# )
# 
# fredr(
#   series_id = "UNRATE",
#   observation_start = as.Date("1990-01-01"),
#   observation_end = as.Date("2000-01-01"),
#   frequency = "q", # quarterly
#   units = "chg" # change over previous value
# )


popular_funds_series <- fredr_series_search_text(
  search_text = "Global Policy Uncertainty",
  order_by = "popularity",
  sort_order = "desc",
  limit = 1
)

popular_funds_series$notes

popular_funds_series_id <- popular_funds_series$id

raw<-popular_funds_series_id %>%
  fredr(
    observation_start = as.Date("2007-01-01"),
    observation_end = as.Date(Sys.Date())
  ) %>%
  ggplot(data = ., mapping = aes(x = date, y = value, color = series_id)) +
  geom_line() +
  labs(x = "Observation Date", y = "Rate", color = "Series")
plot.data<-raw$data %>% 
  select(date, value)
plot.data %>% tail()
plot.data %>% arrange(desc(value)) %>% head()

g.global<-ggplot(plot.data)+
  geom_vline(aes(xintercept=as.Date("2024-10-1")), lty=2, size=.5, col=ssagrey3)+
  geom_line(aes(date, value), col=ssapeach4, alpha=.8, size=.6, alpha=.7)+
  geom_point(aes(date, value), col=ssapeach4, alpha=.8, size=3, alpha=.7, data=. %>% slice(n()))+
  annotate("text", x=as.Date("2020-5-1")-120, y=500, label="Start of\nCOVID\nshutdowns", hjust=1, size=7/.pt, col=ssagrey3)+
  annotate("text", x=as.Date("2024-10-1")-120, y=600,  label="US\nElection", hjust=1, size=7/.pt, col=ssagrey3)+
  geom_smooth(aes(date, value), se=F, span=.15, lty=2, col=ssagrey4, size=1)+
  scale_x_date(date_labels = "%b\n%Y", breaks=seq(as.Date("2009-1-1"), as.Date(Sys.Date()), by="4 years")-1)+
  labs(title = "Global Economic Policy Uncertainty",
       subtitle = "(index, 1997-2015 = 100)",
       caption = "Sources: Baker, Scott R.; Bloom, Nick; Davis, Stephen J. via FREDÂ®")
g.global
ggsave(filename = "uncertain.png",
       height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")

popular_funds_series <- fredr_series_search_text(
  search_text = "Trade Policy Uncertainty",
  order_by = "popularity",
  sort_order = "desc",
  limit = 1
)

popular_funds_series_id <- popular_funds_series$id

raw<-popular_funds_series_id %>%
  fredr(
    observation_start = as.Date("2007-01-01"),
    # observation_end = as.Date("2025-01-01")
    observation_end = as.Date(Sys.Date())
  ) %>%
  ggplot(data = ., mapping = aes(x = date, y = value, color = series_id)) +
  geom_line() +
  labs(x = "Observation Date", y = "Rate", color = "Series")
plot.data<-raw$data %>% 
  select(date, value) %>% 
  filter(date>=as.Date("2012-1-1")-1)

plot.data %>% arrange(desc(value)) %>% head()

g.trade<-ggplot(plot.data)+
  annotate("rect", xmin=as.Date("2016-10-1"), xmax=as.Date("2020-10-1"), ymin=-Inf, ymax=Inf, fill=ssagrey3, alpha=.3)+
  annotate("rect", xmin=as.Date("2024-10-1"), xmax=as.Date(Sys.Date()), ymin=-Inf, ymax=Inf, fill=ssagrey3, alpha=.3)+
  geom_vline(aes(xintercept=as.Date("2024-10-1")), lty=2, size=.5, col=ssagrey3)+
  geom_line(aes(date, value), col=ssapeach4, alpha=.8, size=.6, alpha=.7)+
  geom_point(aes(date, value), col=ssapeach4, alpha=.8, size=3, alpha=.7, data=. %>% slice(n()))+
  annotate("text", x=as.Date("2018-5-1"), y=1800, label="Trump\nAdmin.", hjust=.5, size=7/.pt, col=ssagrey3)+
  annotate("text", x=as.Date("2024-10-1")-120, y=1800, label="US\nElection", hjust=1, size=7/.pt, col=ssagrey3)+
  geom_smooth(aes(date, value), se=F, span=.15, lty=2, col=ssagrey4, size=1)+
  scale_x_date(date_labels = "%b\n%Y", breaks=seq(as.Date("2009-1-1"), as.Date(Sys.Date()), by="4 years")-1)+
  labs(title = "Trade Policy Uncertainty",
       subtitle = "(index, 1997-2015 = 100)",
       caption = "Sources: Baker, Scott R.; Bloom, Nick; Davis, Stephen J. via FREDÂ®")
g.trade
ggsave(filename = "tradeuncertain.png",
       height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")

```


```{r}
#| label: CD delivery by sector alluvium chart
#| warning: false
#| echo: false 

raw<-read_excel(path="Q:\\DATA\\AREO\\Spring 2025 - REO\\Data\\CD Spending by Sector FY22-26.xlsx",
                    # sheet="Food CPI",
                    sheet="CD Spending by Sector FY22-26",
                    range="A1:c50",
                    na=c("N.A.", "n.a.", "#N/A", "na", "NA"))%>% 
  rename(fy=1, value=2, sector=3) %>% 
  na.omit(fy) %>% 
  mutate(value=value/1000000)

sector.order<-raw %>% 
  group_by(sector) %>% 
  summarize(value=sum(value, na.rm=T)) %>% 
  arrange(desc(value)) %>% 
  head(5) %>% 
  pull(sector)
sector.order


plot.data<-raw %>% 
  mutate(sector=ifelse(sector%in%sector.order, sector,"Other")) %>% 
  mutate(sector=factor(sector,
                       levels=c(sector.order,"Other"))) %>% 
  group_by(sector,fy) %>% 
  summarize(value=sum(value, na.rm=T))

sector.labels=c("Fiscal Pol. &  Manag.", "Fin. & Mon.", "Cross-Sector", "Real", "Gen. Analysis", "Other")

sector.color=c(ssablue, ssapeach3, ssagrey1, ssapeach5, ssagrey5, ssapeach1, ssagrey4, ssapeach4)
data.frame(c(sector.order,"Other"), sector.labels)

data.frame(levels(plot.data$sector), sector.labels)

g.cd<-ggplot(plot.data, aes(fy, value, alluvium=sector))+ 
  ggalluvial::geom_alluvium(aes(fill = sector, col=sector),alpha = .2, curve_type="sigmoid", width=.6, decreasing=F)+
  ggalluvial::geom_stratum(aes(fy, value, stratum=sector, alluvium=sector, fill = sector, col=sector), decreasing=F, width=.6, alpha=.6)+
  scale_fill_manual(values=sector.color,
                    labels=sector.labels)+
  scale_color_manual(values=sector.color,
                     labels=sector.labels)+
  guides(fill = guide_legend(nrow = 2))+
  theme(legend.position = "bottom", 
        legend.text = element_text(size=7),
        legend.title = element_blank(),
        legend.key.size = unit(.2,"cm"))+
  labs(title = str_wrap("Capacity Development Spending, by Sector, 2022-26",45),
       subtitle = "(USD millions, fiscal year)",
       caption="Source: IMF CDMAP database")
g.cd

ggsave(filename = "slide4a.png",
       height = 4, width=4, dpi=600,units="in", device="png", bg = "transparent")

```

```{r}
#| label: Save charts for page 12
#| echo: false
#| output: false
#| warning: false

save(g.upset, g.issueyield, g.global, g.trade, g.cd,
     file="gallery_page12.RData")  
     
```

# Page 13

```{r}
#| label: OECD CRS database query and sankey chart
#| warning: false
#| echo: false 

library(httr)
library(jsonlite)
library(rsdmx)
library(ggsankey)

url<-"sdmx.oecd.org/dcd-public/rest/dataflow/OECD.DCD.FSD/DSD_CRS@DF_CRS/?references=all"

raw.struct <- readSDMX(url)

cls <- slot(raw.struct, "codelists")

codelists <- sapply(slot(cls, "codelists"), function(x) slot(x, "id"))
codelists %>% kbl("rst")

dictionary<-function(x){
  # x=4
  temp.list <- as.data.frame(slot(raw.struct, "codelists"), codelistId = codelists[[x]]) %>% 
  select(id, contains(".en"))
  print(codelists[[x]])
  return(temp.list)
}

map(c(1:length(codelists)), dictionary) %>% head(30) %>% kbl("rst")
#get a codelist
codelists
country.list<-dictionary(3)
ssa.id<-country.list %>% rename(country=2) %>% 
  mutate(iso3c=countrycode(country, "country.name", "iso3c")) %>% 
  select(id, iso3c, country) %>% 
  # filter(iso3c%in%c("ZAF", "LSO", "NAM", "BWA", "SWZ"))
  # filter(iso3c%in%c("LSO")) 
  filter(iso3c%in%ssa.list) %>% slice(1:45)%>% slice(1:45)

country.list %>% filter(str_detect(`label.en`, "EU")) %>% kbl("rst")
codelists
country.list %>% filter(str_detect(`id`, "ALLD")) %>% kbl("rst")


dictionary(11) %>% filter(id%in%c(1000, 110,120,130,140,311,500,700)) %>% head(30) %>% kbl("rst")
dictionary(11) %>% filter(id%in%c(1000,110,120,130,140,311,500,700)) %>% head(30) %>% kbl("rst")
dictionary(8)%>% filter(id%in%c(100)) %>% head(30) %>% kbl("rst")
dictionary(9)%>%  head(30) %>% kbl("rst")
dictionary(9) %>% filter(id%in%c("A", "B", "C", "D", "E", "F", "G", "H", "_T")) %>% head(200) %>% kbl("rst")
dictionary(3) %>% filter(id%in%c("ALLD", "ALLM", "USA", "DACEU_EC", "4EU001")) %>% head(200) %>% kbl("rst")

#build actual query just USA as donot
query.url<-"https://sdmx.oecd.org/dcd-public/rest/data/OECD.DCD.FSD,DSD_CRS@DF_CRS,/"
query.don<-"ALLD+ALLM+USA+DACEU_EC+4EU001" #All donors, all multilat, USA, EU & EC
query.rec<-paste0(ssa.id$id, collapse="+") #list of SSA recipients
query.sectors<-"110+120+130+140+311+500+700+1000" #dictionary(11)  
# query.rec<-"F6" #OECD SSA recipients
query.aid<-"100" # ODA flows
query.disb<-"D" # D=disbursements C=commitments
query.dat<-"V" #V = Current prices and Q = constant prices
query.mode<-"_T+A" #_T = all modalities A = budget support (dictionary(9))
query.time<-"?startPeriod=2023&endPeriod=2023"
query.end<-"&dimensionAtObservation=AllDimensions"

  
query.full<-paste0(query.url,query.don,".", query.rec,".", query.sectors,".",query.aid, "._T.",query.mode,".",query.disb, ".", query.dat, "._T..",query.time, query.end)
query.full
# query.full<-"https://sdmx.oecd.org/public/rest/data/OECD.DCD.FSD,DSD_DAC2@DF_DAC2A,1.2/ALLD.F6+KEN+ETH+BDI.218+201+206..V?startPeriod=2022&endPeriod=2023&dimensionAtObservation=AllDimensions"
raw.sdmx<-readSDMX(query.full)
raw <- as.data.frame(raw.sdmx)
data.crs<-raw %>% 
  select(1,2,3,4,5,7,13) %>% 
  purrr::set_names(nm=c("year", "donor", "id","sector",  "measure", "mode","value"))

data<-data.crs %>% 
  select(donor,mode,sector,value)%>% 
  mutate(mode=case_match(mode,
                         c("A")~ "Budget",
                         c("_T")~"Total"),
         sector=case_match(sector,
                           c("110", "120", "130", "140")~"Health and Basic Services",
                           c("311", "500")~"Agric. and Commodity Aid",
                           c("700")~"Humanitarian Aid",
                           c("1000")~"Total"),
         donor=case_match(donor,
                           c("USA")~"USA",
                           c("ALLD")~"All",
                           c("ALLM")~"Multi",
                           c("4EU001")~"EUinstit",
                            c("DACEU_EC")~"EU")) %>%
  group_by(donor, mode,sector) %>% 
  mutate(value=sum(value, na.rm=T)) %>% 
  slice(n())%>% 
  pivot_wider(names_from = mode, values_from = value) %>% 
  mutate(across(everything(), ~replace_na(.x, 0)))%>% 
  mutate(Otherb=ifelse("Budget"%in%names(.), Total-Budget, Total)) %>% 
  select(-Total)%>% 
  pivot_longer(3:4, names_to = "mode", values_to = "value") %>% 
  pivot_wider(names_from = donor, values_from = value)%>% 
  mutate(across(everything(), ~replace_na(.x, 0)))%>% 
  mutate(multix=Multi-EUinstit,
    Otherd=All-USA-multix-EU)%>% 
  select(-c(All,Multi, EUinstit))%>% 
  pivot_longer(3:6, names_to = "donor", values_to = "value") %>% 
  pivot_wider(names_from = sector, values_from = value) %>% 
  mutate(across(everything(), ~replace_na(.x, 0)))%>%
  mutate(Others=Total-`Agric. and Commodity Aid`-`Health and Basic Services`-`Humanitarian Aid`) %>% 
  select(-Total) %>% 
  pivot_longer(3:6, names_to = "sector", values_to = "value")

plot.data<-data %>% 
  make_long(mode, donor,sector, value=value)%>% 
  mutate(node=factor(node, levels=c("Otherb", "Budget",
                                    "Otherd", "multix", "EU", "USA",
                                    "Others", "Agric. and Commodity Aid", "Humanitarian Aid", "Health and Basic Services"))) %>% 
  mutate(next_node=factor(next_node, levels=c("Otherb", "Budget",
                                    "Otherd", "multix", "EU", "USA",
                                    "Others", "Agric. and Commodity Aid", "Humanitarian Aid", "Health and Basic Services")))

g.build<-ggplot(plot.data, aes(x=x, value=value/1000, next_x=next_x, node=node, next_node=next_node, fill=factor(node)))+
  geom_sankey(flow.alpha=.5, width=.05, space=1)
g.build

flow.data<-ggplot_build(g.build)$data[[1]] %>% 
  group_by(group) %>% 
  summarize(n=n()) %>% 
  pull(n)

color.order<-c(ssagrey5,ssagrey2,
               ssagrey5, ssagrey2,
               ssagrey5, ssagrey2,
               ssagrey5,ssagrey2,
               ssapeach4, ssamedblue, ssablue, ssagrey3,
               ssapeach4,ssamedblue,ssablue, ssagrey3,
               ssapeach4,ssamedblue,ssablue, ssagrey3,
               ssapeach4,ssamedblue,ssablue, ssagrey3)
color.fill.vector<-c(
  rep(color.order[1], flow.data[1]),
  rep(color.order[2], flow.data[2]),
  rep(color.order[3], flow.data[3]),
  rep(color.order[4], flow.data[4]),
  rep(color.order[5], flow.data[5]),
  rep(color.order[6], flow.data[6]),
  rep(color.order[7], flow.data[7]),
  rep(color.order[8], flow.data[8]),
  rep(color.order[9], flow.data[9]),
  rep(color.order[10], flow.data[10]),
  rep(color.order[11], flow.data[11]),
  rep(color.order[12], flow.data[12]),
  rep(color.order[13], flow.data[13]),
  rep(color.order[14], flow.data[14]),
  rep(color.order[15], flow.data[15]),
  rep(color.order[16], flow.data[16]),
  rep(color.order[17], flow.data[17]),
  rep(color.order[18], flow.data[18]),
  rep(color.order[19], flow.data[19]),
  rep(color.order[20], flow.data[20]),
  rep(color.order[21], flow.data[21]),
  rep(color.order[22], flow.data[22]),
  rep(color.order[23], flow.data[23]),
  rep(color.order[24], flow.data[24]))


g.ssaoda<-ggplot(plot.data, aes(x=x, value=value/1000, next_x=next_x, node=node, next_node=next_node, fill=factor(node)))+
  geom_sankey(flow.alpha=.4, width=.5, space=1, flow.fill=color.fill.vector)+
  scale_fill_manual(values=c(ssagrey1,
                             ssagrey4,
                             ssagrey3,
                             ssablue,
                             ssamedblue,
                             ssapeach4,
                             ssagrey2,
                             ssapeach5,
                             ssapeach5,
                             ssapeach5  ))+
  annotate("text", x=2, y=25, label="USA", size=7/.pt, color="white", hjust=.5)+
  annotate("text", x=2, y=10, label="EU 1/", size=7/.pt, color="white", hjust=.5)+
  annotate("text", x=2, y=-10, label="Multi.\nDonors\nex. EU", size=7/.pt, color="white", hjust=.5)+
  annotate("text", x=2, y=-32, label="Others", size=7/.pt, color=ssagrey4, hjust=.5)+
  annotate("text", x=.7, y=26, label="Budget\nSupport", size=7/.pt, color=ssagrey4, hjust=1)+
  annotate("text", x=.7, y=-15, label="Other\nSupport", size=7/.pt, color=ssagrey4, hjust=1)+
  annotate("text", x=3.3, y=23, label="Health, \nEducation, &\nother basic\nneeds", size=7/.pt, color=ssapeach4, hjust=0)+
  annotate("text", x=3.3, y=4, label="Humanitarian", size=7/.pt, color=ssapeach4, hjust=0)+
  annotate("text", x=3.3, y=-4, label="Commod. Aid\n& Agric.", size=7/.pt, color=ssapeach4, hjust=0)+
  annotate("text", x=3.3, y=-20, label="Other\nSectors", size=7/.pt, color=ssagrey3, hjust=0)+
  coord_cartesian(xlim=c(.8,3.6))+
  # scale_y_continuous(breaks = c(-20,0,20), labels=c("0", "20", "40"))+
  theme(axis.line = element_blank(),
        axis.ticks.x = element_blank(),
        legend.position = "none)",
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_blank())+labs(title = "Sub-Saharan Africa, ODA Flows, 2023",
       subtitle = "(Distribution by Donor and Sector)",
       caption = paste0("Source: OECD and IMF staff calculations", "\n", str_wrap("1/ European Union includes EU bilateral donors and via EU Institutions.", 75)))
g.ssaoda

ggsave(filename = "sankey.png",
       height = 3.5, width=3.5, dpi=600,units="in", device="png", bg = "transparent")
  

```



```{r}
#| label: AGOA impact estimates from model
#| warning: false
#| echo: false 

raw<-read_excel("c:\\projects\\AprREO25\\agoa.xls") %>% 
  rename(country=1, iso3c=2, sr_pct=3, sr_usd=4, lr_pct=5, lr_usd=6)

data.gdp<-ecosextract("NGDPD", as.character(ssa.imf),"WEO_WEO_LIVE", 2024, 2024, "A") %>% 
  select(iso3c, year, NGDPD) 

data<-raw %>% 
  left_join(data.gdp) %>% 
  filter(iso3c%in%ssa.list) %>% 
  na.omit(NGDPD) %>% 
  mutate(impact_sr=sr_usd*1000000/NGDPD*100,
         impact_lr=lr_usd*1000000/NGDPD*100) %>% 
  select(country, iso3c, impact_sr, impact_lr)

data %>% arrange(impact_sr) %>% head(5) %>% kbl("rst", digits=2)

plot.data<-data %>% 
  arrange(impact_sr) %>% 
  slice(1:5) %>% 
  mutate(impact_sr=-1*impact_sr,
         impact_lr=-1*impact_lr)

g.agoa<-ggplot(plot.data)+
  geom_segment(aes(x=0, xend=impact_sr, y=fct_reorder(country, impact_sr), yend=country),
               color=ssapeach4, position=position_nudge(y=-.15), size=.8)+
  geom_point(aes(x=impact_sr, y=country), shape="|", size=4, color=ssapeach4, position=position_nudge(y=-.15))+
  geom_segment(aes(x=0, xend=impact_lr, y=fct_reorder(country, impact_lr), yend=country),
               color=ssablue, position=position_nudge(y=.15), size=.8)+
  geom_point(aes(x=impact_lr, y=country), shape="|", size=4, color=ssablue, position=position_nudge(y=.15))+
  annotate("text", x=2.5, y=5.5, label="Long Run", size=7/.pt, color=ssablue)+
  annotate("text", x=2.5, y=4.5, label="Short Run", size=7/.pt, color=ssapeach4)+
  labs(title = str_wrap("Impact of AGOA Suspension on Export Receipts, Top 5 Exposed",45),
       subtitle = "(Percent of GDP)",
       caption = paste0("Source: IMF staff calculations"))
g.agoa

ggsave(filename = "agoa.png",
       height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")


```


```{r}
#| label: Direct COMTRADE query
#| warning: false
#| echo: false 

library(comtradr)

Sys.setenv('COMTRADE_PRIMARY' = 'e06a886d81cd48189236749564a80074')

comtrade.codes<-ct_get_ref_table("HS") #all codes

all.prod<-comtrade.codes %>% # get list of HS codes at 4 digit level
  filter(aggrLevel==2) %>% 
  pull(id)

chunks <- split(all.prod, cut(seq_along(all.prod), 3, labels=FALSE)) #split list into chinks to get around query length limits

#### Single country's trade with USA

## Loop over chunks
extract.ct<-function(codes){
temp<-ct_get_data(
  commodity_code = codes,
  flow_direction = c("Import"),
  reporter = "USA",
  partner = "LSO",
  start_date = 2023,
  end_date = 2023
)
return(temp)
}

data<-purrr::map(chunks, extract.ct) %>% 
  reduce(rbind)



clean.data<-data %>% 
  select(ref_year, reporter_iso, partner_iso, cmd_code, cmd_desc, primary_value) %>% 
  arrange(desc(primary_value), cmd_code)

total.data<-clean.data

top.list<-clean.data %>% 
  head(3) %>% pull(cmd_desc)


top.data<-clean.data %>% 
  filter(cmd_desc%in%top.list) %>% 
  rename(value=primary_value, desc=cmd_desc) %>% 
  select(desc, value)
other.data<-clean.data %>% 
  filter(!cmd_desc%in%top.list) %>%
  rename(value=primary_value, desc=cmd_desc) %>% 
  select(desc, value) %>% 
  summarize(desc="other", value=sum(value, na.rm=T))
  
plot.data<-top.data %>% 
  rbind(other.data) %>% 
  mutate(desc=str_wrap(str_sub(desc,1,35), 20))

ggplot(plot.data)+
  geom_bar(aes(value/1000000, fct_reorder(desc, value)), stat="identity", fill=ssablue)+
  labs(title=str_wrap("Lesotho. Top Export Items to the United States, 2023", 45),
       subtitle = "(USD millions)",
       caption = "Source: COMTRADE and IMF staff calculations")+
  theme(axis.text.y = element_text(size=6))

ggsave(filename = "usmkt.png",
       height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")


#################### WH exemptions list

exemptions.list<-read_csv("c:\\projects\\AprREO25\\Tabula Annex II.csv", col_types = cols("c","c"))%>% 
  mutate(code=str_sub(HTSUS,1,6)) %>% 
  filter(!str_detect(code, "HTSUS"))%>% 
  pull(code) %>% unique()

chunks <- split(exemptions.list, cut(seq_along(exemptions.list), 5, labels=FALSE))
# Fetch all wine related commodity codes from the Comtrade commodities DB.
# This vector of codes will get passed to the API query.
# wine_codes <- ct_commodity_lookup("graphite", return_code = TRUE, return_char = TRUE)



# 2023 total imports unto USA from SSA countries


total<-ct_get_data(
  type = "goods",
  frequency = "A",
  commodity_classification = "HS",
  commodity_code = "TOTAL",
  flow_direction = c("Import"),
  reporter = "USA",
  partner = ssa.list,
  start_date = 2023,
  end_date = 2023,
  process = TRUE,
  tidy_cols = TRUE,
  verbose = FALSE,
  mode_of_transport = "TOTAL modes of transport",
  partner_2 = "World",
  customs_code = "C00",
  update = FALSE,
  requests_per_second = 10/60,
  extra_params = NULL,
  cache = FALSE
)

data.total<-total %>% 
  rename(iso3c=partner_iso, total=primary_value) %>% 
  select(iso3c, total)
write.csv(data.total, "COMTRADEtotal.csv")

# loop over chunks of exemnptions list

extract.fn<-function(codes){
  temp<-ct_get_data(
    type = "goods",
    frequency = "A",
    commodity_classification = "HS",
    commodity_code = codes,
    flow_direction = c("Import"),
    reporter = "USA",
    partner = ssa.list,
    start_date = 2023,
    end_date = 2023,
    process = TRUE,
    tidy_cols = TRUE,
    verbose = FALSE,
    mode_of_transport = "TOTAL modes of transport",
    partner_2 = "World",
    customs_code = "C00",
    update = FALSE,
    requests_per_second = 10/60,
    extra_params = NULL,
    cache = FALSE
  )
  return(temp)
}

chunks
data<-purrr::map(chunks, extract.fn) %>% 
  reduce(rbind)



clean.data<-data %>% 
  select(ref_year, reporter_iso, partner_iso, cmd_code, cmd_desc, primary_value) %>% 
  arrange(partner_iso, cmd_code)


write.csv(clean.data, "exemptions.csv")

data.gdp<-ecosextract("NGDPD", as.character(ssa.imf),"WEO_WEO_LIVE", 2023, 2023, "A") %>% 
  select(iso3c, year, NGDPD)

save(clean.data,data.total, data.gdp, file= "crazy.rdta")


plot.data<-clean.data %>% 
  group_by(partner_iso) %>% 
  summarize(exempt=sum(primary_value, na.rm=T)) %>% 
  rename(iso3c=partner_iso) %>% 
  right_join(data.total) %>% 
   left_join(data.gdp) %>% 
   filter(!iso3c%in%c("ERI"))%>% 
  mutate(full.gdp=total/NGDPD*100,
         exempt.gdp=ifelse(!is.na(exempt),exempt/NGDPD*100,0),
         diff=full.gdp-exempt.gdp) %>% 
  select(iso3c, exempt.gdp, diff) %>% 
  pivot_longer(2:3, names_to = "type", values_to = "value") %>% 
  group_by(iso3c) %>% 
  mutate(order=sum((type=="diff")*value, na.rm=T)) %>% 
  mutate(type=factor(type, levels=c("exempt.gdp", "diff"))) %>% 
  mutate(country=countrycode(iso3c, "iso3c", "country.name"))


g.comtrade<-ggplot(plot.data %>% filter(order>=.5))+
  geom_bar(aes(value, fct_reorder(country, order), fill=type), stat="identity")+
  scale_fill_manual(values=c(ssapeach1, ssapeach4),
                    labels=c("Exempt", "Non-Exempt"))+
  theme(legend.position = c(.6,.2),
        legend.title = element_blank(),
        legend.key.size = unit(.4, "cm"))+
  labs(title = str_wrap("Exports to the United States, 2023",45),
       subtitle = str_wrap("(Percent of GDP, countries where exports to the USA are larger than 0.5 percent of GDP)",50),
       caption = str_wrap("Source: COMTRADE, whitehouse.gov, IMF WEO database, and IMF staff calculations.", 70))
g.comtrade 
  
ggsave(filename = "crazy.png",
       height = 3, width=5, dpi=600,units="in", device="png", bg = "transparent")



```

```{r}
#| label: Effective tariffs chart
#| warning: false
#| echo: false 

raw<-read_excel("c:\\projects\\AprREO25\\SSA trade DOTSv3.xlsx", sheet="US Tariffs Calcs", range="q49:s94")

load("crazy.rdta")
plot.data.main<-clean.data %>% 
  group_by(partner_iso) %>% 
  summarize(exempt=sum(primary_value, na.rm=T)) %>% 
  rename(iso3c=partner_iso) %>% 
  right_join(data.total) %>% 
   left_join(data.gdp) %>% 
   filter(!iso3c%in%c("ERI"))%>% 
  mutate(full.gdp=total/NGDPD*100,
         exempt.gdp=ifelse(!is.na(exempt),exempt/NGDPD*100,0),
         diff=full.gdp-exempt.gdp)%>% 
  select(iso3c, exempt.gdp, diff) %>% 
  pivot_longer(2:3, names_to = "type", values_to = "value") %>% 
  group_by(iso3c) %>% 
  mutate(order=sum((type=="diff")*value, na.rm=T)) %>% 
  mutate(type=factor(type, levels=c("exempt.gdp", "diff")))

g.exports<-ggplot(plot.data.main)+
  geom_bar(aes(value, fct_reorder(iso3c, order), fill=type), stat="identity")+
  scale_fill_manual(values=c(ssapeach1, ssapeach4),
                    labels=c("Exempt", "Non-Exempt"))+
  theme(legend.position = c(.8,.2),
        legend.title = element_blank(),
        legend.key.size = unit(.4, "cm"))+
  labs(
    title = str_wrap("Sub-Saharan Africa. Exposure to US Tariffs",45),
       subtitle = "(Exports to USA, percent of GDP)",
       caption = str_wrap("Source: COMTRADE, whitehouse.gov, IMF WEO database, and IMF staff calculations.", 70)
       )
g.exports

plot.order<-g.1$data %>% 
  group_by(iso3c) %>% 
  slice(n()) %>% 
  arrange(order) %>% 
  pull(iso3c)

plot.data2<-raw %>% 
  janitor::clean_names() %>% 
  mutate(diff=headline_tariff-effective_tarrif) %>% 
  select(-headline_tariff) %>% 
  mutate(iso3c=countrycode(x1, "country.name", "iso3c")) %>% 
  filter(!iso3c%in%c("ERI")) %>% 
  pivot_longer(2:3, names_to = "type", values_to = "value") %>% 
  mutate(iso3c=factor(iso3c, levels=plot.order)) 

g.efftariff<-ggplot(plot.data2)+geom_bar(aes(value, iso3c, fill=type), stat="identity")+
  scale_fill_manual(values=c(ssamedblue, ssablue),
                    labels=c("Exemptions", "Effective"))+
  theme(legend.position = c(.8,.2),
        legend.title = element_blank(),
        legend.key.size = unit(.4, "cm"))+
  labs(
    title = str_wrap("Sub-Saharan Africa. Exposure to US Tariffs",45),
       subtitle = "(Average tariff, percent)",
       caption = str_wrap("Source: COMTRADE, whitehouse.gov, IMF WEO database, and IMF staff calculations.", 70)
       )
       g.efftariff
# g.exports+plot_spacer()+g.efftariff+plot_layout(widths = c(1,.1,1))+plot_annotation(title="Exposure to US Tariffs as announced April 2, 2025",caption = str_wrap("Source: COMTRADE, whitehouse.gov, IMF WEO database, and IMF staff calculations.", 100))

# ggsave(filename = "crazyb.png",
#        height = 6, width=6, dpi=600,units="in", device="png", bg = "transparent")
  
```


```{r}
#| label: Direct COMTRADE sankey chart for ZAF exports
#| warning: false
#| echo: false 

library(comtradr)
library(ggsankey)

Sys.setenv('COMTRADE_PRIMARY' = 'e06a886d81cd48189236749564a80074')
country_codes %>% filter(str_detect(country, "Europe"))


comtrade.codes<-ct_get_ref_table("HS") #all codes

all.prod<-comtrade.codes %>% # get list of HS codes at 4 digit level
  filter(aggrLevel==4) %>% 
  pull(id)

comtrade.codes %>% # get list of HS codes at 4 digit level
  filter(str_sub(id, 1,2)==22)

chunks <- split(all.prod, cut(seq_along(all.prod), 20, labels=FALSE)) #split list into chinks to get around query length limits


#### Single country's trade with USA

## Loop over chunks
extract.wld<-function(codes){
temp<-ct_get_data(
  commodity_code = codes,
  flow_direction = c("Import"),
  reporter = "all_countries",
  partner = "ZAF",
  start_date = 2023,
  end_date = 2023
)
return(temp)
}

raw.wld<-purrr::map(chunks, extract.wld) %>% 
  reduce(rbind)

raw.wld %>% filter(reporter_iso=="ZAF") %>% 
  select(cmd_code, cmd_desc, primary_value) %>% 
  arrange(desc(primary_value)) %>% 
  head(10)

extract.main<-function(codes){
temp<-ct_get_data(
  commodity_code = codes,
  flow_direction = c("Import"),
  reporter = c("USA","CHN", "IND", "EUR"),
  partner = "ZAF",
  start_date = 2023,
  end_date = 2023
)
return(temp)
}

raw.main<-purrr::map(chunks, extract.main) %>% 
  reduce(rbind)

data.main<-raw.main %>% 
  select(cmd_code, reporter_iso, primary_value) %>% 
  pivot_wider(names_from = reporter_iso, values_from = primary_value)

data.wld<-raw.wld %>% 
  select(reporter_iso, cmd_code, primary_value) %>% 
  group_by(cmd_code) %>% 
  summarize(world=sum(primary_value, na.rm=T))



data<-data.wld %>% 
  left_join(data.main) %>% 
  replace(is.na(.), 0) %>% 
  mutate(otherd=world-USA-CHN-IND-EUR) %>% 
  select(-world) %>% 
  mutate(type=case_when(
    str_sub(cmd_code, 1,2)%in%c(71) ~"Precious",
    str_sub(cmd_code, 1,2)%in%c(25:27) ~"Minerals",
    str_sub(cmd_code, 1,2)%in%c(72:83) ~"Metals",
    str_sub(cmd_code, 1,2)%in%c(86:89) ~"Transport",
    TRUE~"other"
  )) %>% 
  group_by(type) %>% 
  summarize(
    usa=sum(USA, na.rm=T)/1000000000,
    eur=sum(EUR, na.rm=T)/1000000000,
    chn=sum(CHN)/1000000000,
    ind=sum(IND, na.rm=T)/1000000000,
    otherd=sum(otherd, na.rm=T)/1000000000)%>% 
  pivot_longer(2:6, names_to = "dest", values_to = "value") %>% 
  make_long(type, dest, value=value)%>% 
  mutate(node=factor(node, levels=c("other",  "Metals", "Transport","Minerals", "Precious",
                                    "otherd", "ind", "eur", "chn", "usa")))%>% 
  mutate(next_node=factor(next_node, levels=c("other",  "diamonds", "textiles",
                                    "otherd", "ind", "eur", "chn", "usa")))

save(data, file="Emma.rdta")

g.zaf<-ggplot(data, aes(x=x, value=value, next_x=next_x, node=node, next_node=next_node, fill=factor(node)))+
  geom_sankey(flow.alpha=.4, width=.15, space=2)+
  # geom_sankey_label(aes(label=node), alpha=.2, size=7/.pt)+
  scale_fill_manual(values=c(ssagrey4,
                            ssablue,
                            ssamedblue,
                            "darkblue",
                             ssapeach2,
                             ssagrey2,
                            ssapeach3,
                            ssapeach3,
                            ssapeach3,
                            ssapeach5
                             ), guide="none")+
  annotate("text", x=.9, y=50, label="Precious\nMetals\n& Gems", size=7/.pt, color=ssapeach3, hjust=1)+
  annotate("text", x=.9, y=10, label="Minerals", size=7/.pt, color="darkblue", hjust=1)+
  annotate("text", x=.9, y=-18, label="Cars &\nTransport Equip.", size=7/.pt, color=ssamedblue, hjust=1)+
  annotate("text", x=.9, y=-35, label="Metals", size=7/.pt, color=ssablue, hjust=1)+
  annotate("text", x=.9, y=-55, label="Other", size=7/.pt, color=ssagrey4, hjust=1)+
  annotate("text", x=2.1, y=75, label="USA", size=7/.pt, color=ssapeach5, hjust=0)+
  annotate("text", x=2.1, y=45, label="China", size=7/.pt, color=ssapeach3, hjust=0)+
  annotate("text", x=2.1, y=20, label="EU", size=7/.pt, color=ssapeach3, hjust=0)+
  annotate("text", x=2.1, y=0, label="India", size=7/.pt, color=ssapeach3, hjust=0)+
  annotate("text", x=2.1, y=-40, label="Other\nDestinations", size=7/.pt, color=ssagrey3, hjust=0)+
  coord_cartesian(xlim=c(.8,2))+
  scale_y_continuous(breaks = c(-80,0,80), labels=c("0", "80", "160"))+
  theme(axis.line = element_blank(),
        axis.ticks.x = element_blank(),
        legend.position = "none)",
        # axis.text.y = element_blank(),
        # axis.ticks.y = element_blank(),
        axis.text.x = element_blank())+
  labs(title = "South Africa, Merchandise Exports, 2023",
       subtitle = "(Distribution by Type and Destination, USD billions)",
       caption = "Source: COMTRADE and IMF staff calculations")
g.zaf

ggsave(filename = "comtradeZAF.png",  height = 3, width=3, dpi=600,units="in", device="png", bg = "transparent")
```

```{r}
#| label: Save charts for page 13
#| echo: false
#| output: false
#| warning: false

save(g.ssaoda, g.agoa, g.comtrade, g.exports, g.efftariff, g.zaf,
     file="gallery_page13.RData")  
     
```

# Page 14

```{r}
#| label: PIMA SFA and DEA analysis
#| warning: false
#| echo: false 

library(frontier)
library(Benchmarking)



raw<-read_excel("c:\\projects\\lesotho\\Template Investment and Efficiency (Jan 2022)_Lesotho.xlsx", sheet = "Frontier", range="a7:k200",col_names = F )%>%
select(1,2,4,5,10,11)%>%
  purrr::set_names(nm=c("imf", "ctry", "pck1","pck2", "hybrid1", "hybrid2")) %>% 
  rowwise() %>% 
  mutate(pck=sum(pck1, pck2, na.rm=T),
         hybrid=sum(hybrid1, hybrid2, na.rm=T)) %>% 
  mutate(pck=na_if(pck,0),
         hybrid=na_if(hybrid,0)) %>% 
  select(imf, ctry, pck, hybrid)
  
 
plot.data<-raw %>% 
  mutate(iso3c=countrycode(imf, "imf", "iso3c")) 

plot.data %>% 
  filter(iso3c%in%ssa.list) %>% 
  pull(iso3c)
## Run SFA analysis
sfa <- frontier::sfa(hybrid ~ log(pck), data = plot.data)
c <- coef(sfa)
c

## run DEA analysis
plot.data.dea<-raw %>% 
  mutate(iso3c=countrycode(imf, "imf", "iso3c")) %>% 
  na.omit()

Benchmarking::dea.plot.frontier(plot.data.dea$pck,plot.data.dea$hybrid,txt=TRUE)
dea<-Benchmarking::dea(plot.data.dea$pck,plot.data.dea$hybrid)
e<-Benchmarking::eff(dea)

plot.data.frontier<-plot.data.dea %>% 
  cbind(e)%>% 
  filter(e==1) #only obs on the frontier, i.e. with efficiency == 1

## DEA chart

plot.data %>% filter(iso3c=="NAM")

g.dea<-ggplot(plot.data)+
  geom_line(aes(pck, hybrid), data=plot.data.frontier, lty=2, col=ssagrey3, size=1, alpha=.6)+ 
  geom_ribbon(aes(pck, ymin=0, ymax=hybrid), data=plot.data.frontier, fill=ssagrey2, size=1, alpha=.3)+ 
  geom_point(aes(x = pck, y = hybrid, color=(iso3c%in% ssa.list), shape=(iso3c%in% ssa.list)),
              size=1.5)+
  # geom_text(aes(x = pck, y = hybrid-5, 
  #               label = iso3c),
  #           size=4/.pt,col="firebrick",
  #           # data = . %>% filter(iso3c=="LSO")) +
  #           # data = . %>% filter(iso3c%in%SACUlist)) +
  # )+
  # geom_point(aes(x = pck, y = hybrid,
  #               label = iso3c),
  #           size=3,col="firebrick",
  #           # data = . %>% filter(iso3c=="LSO"))+ 
  #           # data = . %>% filter(iso3c%in%SACUlist))+ 
  # )+
    theme(axis.title.x = element_text(size=7, colour = ssagrey4))+
  annotate("text", x=700, y=90, label="Global\nBest-Practice\nFrontier", hjust=0, size=7/.pt, col=ssagrey3, fontface="bold")+
    annotate("text", x=5800, y=10, label="Sub-Saharan\nAfrica", hjust=0.5, size=7/.pt, col=ssablue)+
  xlab("\nPer Capita Public Capital Stock - Input (USD, PPP)") +
    coord_cartesian(xlim=c(0,12000), ylim = c(0,105))+
    scale_color_manual(values=c(ssagrey1, ssablue), guide="none")+
    scale_shape_manual(values=c(1, 16), guide="none")+
    labs(title = str_wrap("Public Infrastructure vs Investment, 2022",45),
         subtitle = "(Hybrid Infrastructure Index - Output)",
         caption = paste0(str_wrap("Source: Making Public Investment More Efficient. International Monetary Fund, 2015",55),"\n",
                          str_wrap("Note: The hybrid indicator combines  physical and survey-based indicators into a synthetic index of the coverage and quality of infrastructure networks.", 55))
)
g.dea

ggsave(filename = "dea.png",
       height = 3.5, width=3, dpi=600,units="in", device="png", bg = "transparent")

## SFA Chart

g.sfa<-ggplot(plot.data %>% filter(pck<=35000)) + 
  geom_point(aes(x = pck, y = hybrid, color=(iso3c%in% ssa.list), shape=(iso3c%in% ssa.list)),
              size=1.5)+
  # geom_text(aes(x = pck, y = hybrid-5, 
  #               label = iso3c),
  #           size=7/.pt,col="firebrick",
  #           data = . %>% filter(iso3c=="LSO")) +
  # geom_point(aes(x = pck, y = hybrid,
  #               label = iso3c),
  #           size=3,col="firebrick",
  #           data = . %>% filter(iso3c=="LSO"))+
  geom_line(
    data = data_frame(pck = seq(50, 35000, 10), frontier = c[1] + c[2] * log(pck)), #use coefficients from sfa analysis above
    aes(x = pck, y = frontier),
    size = 1, lty=2,
    color = ssagrey3)+ 
  geom_ribbon(
    data = data_frame(pck = seq(50, 35000, 10), frontier = c[1] + c[2] * log(pck)), #use coefficients from sfa analysis above
    aes(x = pck, ymax = frontier, ymin=0.0001),
    alpha=.2,
    size = 1,
    fill = ssagrey3)+ 
    theme(axis.title.x = element_text(size=7, colour = ssagrey4))+
  annotate("text", x=1000, y=60, label="Global\nBest-Practice\nFrontier", hjust=0, size=7/.pt, col=ssagrey3, fontface="bold")+
    annotate("text", x=2000, y=10, label="Sub-Saharan\nAfrica", hjust=0.5, size=7/.pt, col=ssablue)+
  xlab("\nPer Capita Public Capital Stock - Input (USD, PPP)") +
    coord_cartesian(xlim=c(300,6000), ylim = c(5,75))+
    scale_color_manual(values=c(ssagrey1, ssablue), guide="none")+
    scale_shape_manual(values=c(1, 16), guide="none")+
    labs(title = str_wrap("Public Infrastructure vs Investment, 2022",45),
         subtitle = "(Hybrid Infrastructure Index - Output)",
         caption = paste0(str_wrap("Source: Making Public Investment More Efficient. International Monetary Fund, 2015",55),"\n",
                          str_wrap("Note: The hybrid indicator combines  physical and survey-based indicators into a synthetic index of the coverage and quality of infrastructure networks.", 55))
)

ggsave(filename = "sfa.png",
       height = 3.5, width=3, dpi=600,units="in", device="png", bg = "transparent")

## Both charts

g.dea/g.sfa

ggsave(filename = "pim.png",
       height = 7, width=3, dpi=600,units="in", device="png", bg = "transparent")
```


```{r}
#| label: Stress chart for SSA proportion of countries in distress
#| warning: false
#| echo: false 

# get data from ecos bloomberg --------------------------------------------
# bbseries<-imf_datatools$ecos_sdmx_utilities$get_all_series('ECDATA_BLOOMBERG') %>%
#   data.frame()
# query.list<-bbseries %>% 
#   filter(str_detect(.,"CF1")) %>% 
#   unlist()
# des<-imf_datatools$ecos_sdmx_utilities$get_ecos_sdmx_metadata("ECDATA_BLOOMBERG", query.list)%>% 
#   pull(TICKER_NAME)

series.list<-c('JPSSGAOB Index', # AGO Yes
               "JPSSGDGH Index", # GHA Yes
               "JPGCKESS Index", #KEN Yes
               "JPSSGNIG Index", #NGA Yes 
               "JPSSGSN Index", #SEN/WAEMU Yes
               "JPSSGSAF Index", #ZAF Yes
               # "JPSSGTZB Index", #TZA No
               "JPSSGZMB Index", #ZMB Yes
               "JPSSGCDI Index", #CIV Yes
               "JPEGETSS Index", #ETH Yes
               "JPSSGGA Index", #GAB Yes
               "JPSSGMZB Index",#MOZ Yes
               "JPSSGNMB Index",#NAM Yes
               # "JPGCCMSS Index",#CMR No
               "JPEIGLSP Index"
               # ,#EMBI Yes
               # "USGG10YR Index"#USA Yes
               )

raw = bbextract(series.list, "2013-01-1", Sys.Date()) 
raw %>% tail()
max.date<-raw %>% select(-`JPSSGSN `) %>% pull(date) %>% max()
# bbseries %>% slice(1:6) %>% unlist()
# AFCRSUEZ Comdty
# test<-imf_datatools$ecos_sdmx_utilities$get_ecos_sdmx_metadata("ECDATA_BLOOMBERG", bbseries %>% slice(1:6) %>% unlist())

data<-raw %>%  
  tidyr::fill(everything()) %>% 
  filter(date<=max.date)
plotlist<-data.frame(index=c('JPSSGAOB', # AGO Yes
                             "JPSSGDGH", # GHA Yes
                             "JPGCKESS", #KEN Yes
                             "JPSSGNIG", #NGA Yes 
                             "JPSSGSN ", #SEN/WAEMU Yes
                             "JPSSGSAF", #ZAF Yes
                             "JPSSGZMB", #ZMB Yes
                             "JPSSGCDI", #CIV Yes
                             "JPEGETSS", #ETH Yes
                             "JPSSGGA ", #GAB Yes
                             "JPSSGMZB",#MOZ Yes
                             "JPSSGNMB",#NAM Yes
                             "JPEIGLSP"),
                     iso3c=c(c("AGO", "GHA", "KEN","NGA","SEN", "ZAF", "ZMB", "CIV",
                               "ETH", "GAB", "MOZ", "NAM", "EMBI")
                     ))#EMBI Yes
                             
data %>% tail(10)

data<-data %>% 
  filter(date!=as.Date(Sys.Date()))
data %>% tail()
macdsa.list<-c("AGO", "BWA", "GAB", "GNQ", "SWZ", "NAM", "NGA", "MUS", "SYC", "ZAF")
countrycode(macdsa.list, "iso3c", "country.name")
maclist<-plotlist %>% filter(iso3c%in%macdsa.list) %>% pull(index)
# plotlist %>% filter(iso3c%in%macdsa.list)


stressdata<-data %>% 
  # select(c(date,all_of(maclist))) %>% # only countries in MAC list
  fill(everything())%>%
  mutate(ym=ceiling_date(date, "quarter")) %>% 
  group_by(ym)%>% 
  summarize_all(max, na.rm=T)%>% 
  select(-c(date)) %>% 
  mutate_all(~ifelse(is.infinite(.), NA, .))%>% 
  rowwise() %>% 
  mutate(distress=sum(c_across(2:14)>=1000, na.rm=T),
         stress=sum(c_across(2:14)<1000&c_across(2:6)>=700, na.rm=T),
         performing=sum(c_across(2:14)<700, na.rm=T))%>% 
  ungroup()%>% 
  select(ym,distress, stress, performing)%>% 
  pivot_longer(-ym,names_to = "type", values_to = "value") %>% 
  mutate(type=factor(type,levels=c("performing", "stress", "distress"))) %>% 
  mutate(ym=as.Date(ym, origin="1970-1-1")-1) %>% 
  group_by(ym) %>% 
  mutate(total=sum(value)) %>% 
  mutate(share=value/total)
  

ggplot(stressdata)+
  geom_bar(aes(ym,value, fill=fct_reorder(type, -desc(type))), stat="identity")+
  scale_fill_manual(values=c("grey70", ssapeach3, "firebrick"), guide="none")

g.stress<-ggplot(stressdata,
          # aes(x = ym, y = value, alluvium = type)) +
          aes(x = ym, y = share*100, alluvium = type)
       ) +
  ggalluvial::geom_alluvium(aes(fill = type, col=type),alpha = .7)+
  scale_fill_manual(values=c(ssablue, "grey50", "firebrick"),
                    labels=c("< 700 bps", "700-1000 bps", "> 1000 bps"))+
  scale_color_manual(values=c(ssablue, "grey50", "firebrick"),
                     labels=c("< 700 bps", "700-1000 bps", "> 1000 bps"), guide="none")+
  theme(legend.title = element_blank(),
        legend.background = element_rect(fill = "grey90", colour = NULL),
        axis.text = element_text(size=7),
        legend.text = element_text(size=6),
        axis.title = element_blank(),
        legend.direction = "horizontal",
        legend.position = c(.28,.86)
  )+ guides(fill = guide_legend(nrow = 1))+
  scale_x_date(breaks=seq(as.Date("2014-1-1"), as.Date(Sys.Date()), by="1 years")-1,
                          date_labels = "%b\n%y")+
  labs(title = "SSA. Maximum Spread Reached over 3-month Interval",
                  subtitle = "(proportion of countries, percent)",
                  caption="Source: Bloomberg and IMF staff calculations")+
  theme(plot.title=element_text(size=7),
        # legend.background = element_rect(fill="transparent"),
        legend.key.size = unit(.15, "cm"),
        plot.subtitle=element_text(size=7),
        plot.caption = element_text(size=6, color="grey30"))
        g.stress
ggsave(filename = "distressspreads.png",  height = 2.5, width=5, dpi=600,units="in", device="png", bg = "transparent")

```


```{r}
#| label: Save charts for page 14
#| echo: false
#| output: false
#| warning: false

save(g.sfa, g.dea, g.stress,
     file="gallery_page14.RData")  
     
```

```{r}
#| label: Miscellaneous charts
#| warning: false
#| echo: false 



# ND-GAIN World Map ------------------------------------------------------


library(sf)
library(rnaturalearth)
library(rnaturalearthdata)
library(ggrepel)

"https://www.fao.org/faostat/en/#data/FS"

# The whole world
sf::sf_use_s2(FALSE)
world <- ne_countries(scale = "medium", returnclass = "sf")

world_points<- st_centroid(world)
world_points <- cbind(world, st_coordinates(st_centroid(world$geometry)))%>%
  mutate(wb_a3=case_when(
    wb_a3=="ZAR" ~ "COD", # Map package is old. Still uses ZAR rather than COD
    TRUE ~ wb_a3)
  )

path<-"c://projects/OctREO25/"
raw<-read_csv(paste0(path,"IMF-Adapted_ND-GAIN_Index.csv")) |>
  filter(Indicator=="IMF-Adapted ND-GAIN Index") |> 
  select(ISO3, F2022) |> 
  rename(iso3c=1, index=2) |> 
  mutate(index=index*100)

breaks<-c(0,35,50,70, Inf)
data<-raw %>% 
  rename(wb_a3=iso3c) %>% 
  mutate(index=cut(index, breaks=breaks))
ssa<-world_points%>%
  left_join(data, by="wb_a3")

g.ndgain<-ggplot(data = ssa ) +
  geom_sf(color = "grey100", fill="grey80", alpha=1)+
  geom_sf(color = ssagrey2, aes(fill=index), alpha=1)+
  scale_fill_manual(values=c(IMFred, ssapeach3, IMFmedblue, IMFblue), na.value = ssagrey2, drop=F,na.translate=F,
labels=c("Less than 35", "35 to 50", "50 to 70", "70 +"))+
  # scale_fill_manual(values=c(ssapeach1, ssapeach2, ssapeach3, ssapeach4, ssapeach5), na.value = ssagrey2, drop=F,na.translate=F)
# ,
#                     labels=c("Less\nthan 30", "10-20", "20-30", "30-40", "40+", "No\nData"))+
  theme(axis.text.x = element_blank(),
        axis.text.y=element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        # legend.text = element_blank(),
        legend.text = element_text(size=18/.pt),
        legend.title = element_blank(),
        legend.position = c(.15,.3),
        legend.key.size = unit(.3, 'cm'),
        # legend.position = "none",
        legend.background = element_rect(fill="transparent", color="transparent"),
        legend.box.background = element_rect(fill="transparent", color="transparent"))+
  # labs(title = "Prevalance of Severe Food insecurity.",
  #      subtitle = "(2041-23 average, percent of population)",
  #      caption = "Source: FAO Stat")+
    coord_sf(ylim=c(-56,85))
g.ndgain
ggsave(filename = "climatemap.png",  height = 3, width=6, dpi=600,units="in", device="png", bg = "transparent")


# Chart of arrangements --------------------------------------------------

plot.data<-read_excel("C:\\projects\\OctREO25\\Fund Arrangements since 1952 updated with SMP.xlsx", sheet="Table Ongoing", range="a50:t52", col_names=F) |> 
  purrr::set_names(nm=c("Type", 2007:2025)) |> 
  pivot_longer(2:20, names_to = "year", values_to = "value") |> 
  filter(year>=2012) |> 
  filter(Type!="Total disbursing Programs") |> 
  mutate(Type=factor(Type, levels=c("Total Emergency Facilities",
"Total non-disbursing programs", "Total disbursing programs"),
labels=c("Emergency", "Non-Disbursing", "Disbursing"))) |> 
  mutate(year=as.numeric(year))

ggplot(plot.data)+geom_bar(aes(year, value, fill=Type), stat="identity", alpha=.7)+
  theme(legend.position = c(.2,.7),
legend.title = element_blank())+
  scale_fill_manual(values=c(ssapeach4, ssagrey3, fundblue))+
  scale_x_continuous(breaks=seq(2010,2025, by=5))+
  labs(title="Sub-Saharan Africa. Fund Engagement, 2012-25",
subtitle = "(No. of arrangements active during the year)",
caption=paste0("Source: IMF FIN database.")
  )

ggsave(filename = "engagement.png",  height = 4, width=4, dpi=600,units="in", device="png", bg = "transparent")

 
```